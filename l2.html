<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Ledger ‚Äî Accounts & Chart (v2.6)</title>

<!--
  Google Fonts used by the app.
  NOTE: DM Mono & Gloria Hallelujah were removed in this version.
-->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Geologica:wght@100..900&family=Inconsolata:wght@200..900&family=Patrick+Hand&display=swap" rel="stylesheet">

<style>
/* ============================================
      CSS VARIABLES & DESIGN TOKENS
      - Central palette and sizing tokens.
      - Dark mode overrides in :root.dark-mode.
   ============================================ */
:root {
  --maxw: 1400px;
  --c-pos: #4c8036;       /* positive values (assets, credit availability) */
  --c-neg: #a02d2a;       /* negative values (debt) */
  --c-black: #000000;
  --c-white: #ffffff;
  --c-bg: #ffffff;        /* background default */
  --c-fg: #000000;        /* text color default */
  --c-border: #000000;
  --radius: 10px;
  --gap: 12px;
  --c-tint-pos: #f7f9f4;  /* tinted background for positive inputs */
  --c-tint-neg: #f9f4f4;  /* tinted background for negative inputs */
  --c-muted: #e8e8e8;
  --c-overlimit: #d85140;
  --c-input-bg: #ffffff;
  --c-input-border: #000000;
  --c-header-bg: #ffffff;
  --c-statusbar-bg: #ffffff;
  --c-toast-bg: #000000;
  --c-toast-fg: #ffffff;
  --c-modal-bg: #ffffff;
  --c-modal-border: #000000;
  --c-modal-fg: #000000;
  
  /* Default font; can be overridden by JS via --font-current */
  --font-current: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
}

/* Dark mode palette overrides: same variable names, different values */
:root.dark-mode {
  --c-pos: #7cbf5f;
  --c-neg: #ff6b5f;
  --c-black: #ffffff;
  --c-white: #1a1a1a;
  --c-bg: #1a1a1a;
  --c-fg: #e0e0e0;
  --c-border: #404040;
  --c-tint-pos: #1a3a0f;
  --c-tint-neg: #3a1a1a;
  --c-muted: #333333;
  --c-input-bg: #2a2a2a;
  --c-input-border: #505050;
  --c-header-bg: #222222;
  --c-statusbar-bg: #222222;
  --c-toast-bg: #333333;
  --c-toast-fg: #e0e0e0;
  --c-modal-bg: #2a2a2a;
  --c-modal-border: #505050;
  --c-modal-fg: #e0e0e0;
}

/* ============================================
      BASE LAYOUT
   ============================================ */
html, body { 
  height: 100%; 
  margin: 0; 
  background: var(--c-bg); 
  color: var(--c-fg); 
}

body {
  font-family: var(--font-current);
  font-size: 18px;
  line-height: 1.5;
  /* Smooth transitions for theme/font changes */
  transition: background-color 0.3s ease, color 0.3s ease, font-family 0.2s ease;
}

/* Main content width wrapper */
.wrap { 
  width: 90vw; 
  max-width: var(--maxw); 
  margin: 0 auto; 
  padding: 0px;
}

a {
  color: var(--c-black);
  text-decoration: underline;
}

/* ============================================
      HEADER & TOOLBAR
      - Sticky top bar with totals, interest summary,
        timeframe + chart mode controls, refresh/submit.
   ============================================ */
header { 
  position: sticky; 
  top: 0; 
  background: var(--c-header-bg); 
  z-index: 5; 
  border-bottom: 1px solid var(--c-border);
  padding-bottom: 1rem;
  transition: background-color 0.3s ease;
}

/* Main toolbar layout */
.toolbar { 
  display: flex; 
  gap: var(--gap); 
  align-items: flex-start;
  justify-content: space-between;
  padding: 6px 24px 10px 24px;
  flex-wrap: nowrap; 
  width: 100%;
  box-sizing: border-box;
}

/* Left side: big ‚Äúassets vs debts‚Äù + interest numbers */
.financial-group {
  display: flex;
  gap: var(--gap);
  align-items: baseline;
  flex-wrap: wrap;
  min-width: 0;
  flex-shrink: 1;
}

/* Right side: type filters + timeframe + mode + buttons */
.toolbar-right {
  display: flex;
  flex-direction: column;
  align-items: flex-end;
  gap: 6px;
  flex-shrink: 0;
  max-width: 60%;
}

/* Row to hold type summary filters (chips) */
.type-filter-row {
  display: flex;
  flex-wrap: wrap;
  justify-content: flex-end;
  gap: 0.35rem;
}

/* Row with timeframe, mode radio buttons, refresh, submit */
.toolbar-controls {
  display: flex;
  gap: 0.6rem;
  align-items: center;
  flex-wrap: wrap;
  justify-content: flex-end;
}

/* Smaller text for labels in the toolbar */
.toolbar label { 
  font-size: 0.8rem;
  font-weight: 300;
  cursor: pointer;
  color: var(--c-fg);
}

/* Compact select styling in toolbar */
.toolbar select {
  font-size: 0.8rem;
  font-weight: 300;
  padding: 4px 6px;
  border: 1px solid var(--c-input-border);
  border-radius: 4px;
  background: var(--c-input-bg);
  color: var(--c-fg);
  font-family: var(--font-current);
  transition: background-color 0.3s ease, border-color 0.3s ease;
}

/* ============================================
      FINANCIAL SUMMARY
      - Large assets/debts + smaller interest summary.
   ============================================ */
#financial-summary {
  font-size: 5rem;
  font-weight: 300;
  white-space: nowrap;
  line-height: 1.1;
  flex-shrink: 1;
  min-width: 0;
  color: var(--c-fg);
}

/* Used to highlight the ‚Äúwinning‚Äù side (assets or debts). */
#financial-summary .bold-value {
  font-weight: 700;
}

#interest-summary {
  font-size: 2rem;
  font-weight: 300;
  white-space: nowrap;
  line-height: 1.1;
  flex-shrink: 1;
  min-width: 0;
  opacity: 0.9;
}

/* Color helpers for interest + sign direction */
.interest-earned { color: var(--c-pos); }
.interest-cost { color: var(--c-neg); }
.summary-debt { color: var(--c-neg); }
.summary-asset { color: var(--c-pos); }

/* ============================================
      CHART CONTAINER
      - Host Google Charts (bar/line/donuts).
   ============================================ */
#chart { 
  min-height: 30vh; 
  width: 100%; 
  margin: 0;
  padding: 0;
  overflow: hidden; 
  display: flex;    
  flex-direction: column;
  justify-content: center;
  align-items: center;
}

#chart-pager {
  text-align: center;
}

/* ============================================
      VISUAL RATIO BAR
      - Simple linear asset vs debt ‚Äúfinger-width‚Äù bar.
   ============================================ */
#visual-ratio-bar {
  width: 100%;
  height: 30px; /* Approx finger width */
  display: flex;
  overflow: hidden;
  margin-top: 8px;
}

/* Portion representing assets */
#ratio-asset {
  background-color: var(--c-pos);
  height: 100%;
  transition: width 0.5s ease;
}

/* Portion representing debts */
#ratio-debt {
  background-color: var(--c-neg);
  height: 100%;
  transition: width 0.5s ease;
}

/* Horizontal divider lines around chart & sections */
hr.divider {
  border: none;
  border-top: 1px solid var(--c-border);
  margin-top: 1rem;
  transition: border-color 0.3s ease;
}

/* ============================================
      ACCOUNT ROWS
      - Each row = account name, current value,
        interest, input line, history chips, ratio bar.
   ============================================ */
.accounts { 
  display: grid; 
  grid-template-columns: 1fr; 
  gap: var(--gap); 
}

/* Main flex row for a single account */
.row { 
  display: flex; 
  align-items: flex-start; 
  justify-content: space-between; 
  border-bottom: 1px solid var(--c-border);
  padding: 12px 0; 
  gap: 12px; 
  transition: opacity 0.3s ease;
}

/* Left side: name, last value, meta, input, mute */
.left { 
  flex: 1 1 auto; 
  padding-right: 12px; 
  min-width: 0; 
  display: flex;
  flex-wrap: wrap;
  align-items: flex-start; 
  justify-content: space-between; 
  gap: var(--gap);
}

/* Right side: value chips + per-account ratio bar */
.right { 
  flex: 0 1 auto; 
  min-width: 40%; 
  text-align: right; 
  font-size: .9rem; 
}

/* Bundle: last value + name + stacked meta (limit/APR) */
.account-details {
  display: flex;
  flex-wrap: wrap;
  align-items: flex-start;
  gap: var(--gap);
  min-width: 0;
}

/* Big ‚Äúlast known‚Äù value for the account */
.lastval { 
  font-weight: 600; 
  font-size: 2.6rem; 
  white-space: nowrap;
  color: var(--c-fg);
}

/* Account name: clickable, can long-press for menu, single-click opens link if defined */
.name { 
  font-weight: lighter; 
  color: var(--c-black); 
  font-size: 2.2rem; 
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  cursor: pointer;
  user-select: none;
  position: relative;
}

.name:hover { opacity: 0.8; }
.name:active { opacity: 0.6; }

/* Wraps LIMIT + APR as a small vertical column to the right of the name */
.account-meta {
  display: flex;
  flex-direction: column;
  align-items: flex-start;
  gap: 0.1rem;
}

/* Limit line (shows CC limit with utilization-based color) */
.limit {
  font-weight: 600;
  font-size: 0.75rem;
  padding-top: 0.35rem;
  color: var(--c-fg);
}

/* APR + calculated interest for timeframe (e.g. +$X/mo) */
.apr { 
  font-weight: 400; 
  font-size: 0.75rem;
  opacity: .75;
  padding-top: 0.1rem;
  color: var(--c-fg);
}

/* Line with numeric input + mute toggle switch */
.input-line { 
  display: flex; 
  gap: 10px; 
  align-items: center; 
  flex-shrink: 0;
  padding-top: 0.25rem;
}

/* ============================================
      INPUT FIELDS
      - Used for adding new account values & some modals.
   ============================================ */
input[type="number"], input[type="date"], input[type="text"], input[type="url"] {
  width: 10rem;
  max-width: 10rem;
  padding: .7rem .8rem;
  font-size: 1.1rem;
  border: 2px solid var(--c-input-border);
  border-radius: var(--radius);
  background: var(--c-input-bg);
  color: var(--c-fg);
  font-family: var(--font-current);
  outline: none;
  transition: background-color 0.3s ease, border-color 0.3s ease;
}

input[type="number"]::placeholder,
input[type="date"]::placeholder,
input[type="text"]::placeholder,
input[type="url"]::placeholder {
  color: var(--c-fg);
  opacity: 0.6;
}

/* Focus ring uses ‚Äúpositive‚Äù color as accent */
input[type="number"]:focus,
input[type="date"]:focus,
input[type="text"]:focus,
input[type="url"]:focus {
  border-color: var(--c-pos);
  box-shadow: 0 0 0 2px var(--c-pos) inset;
}

/* Visual state when submitting entries */
input[type="number"].submitting,
input[type="date"].submitting,
input[type="text"].submitting,
input[type="url"].submitting {
  opacity: 0.5;
  pointer-events: none;
}

/* ‚ÄúPulse green‚Äù when submit succeeded */
input[type="number"].submitted-ok,
input[type="date"].submitted-ok,
input[type="text"].submitted-ok,
input[type="url"].submitted-ok {
  animation: flash-green 0.8s ease-out;
}

@keyframes flash-green {
  0% { box-shadow: 0 0 0 2px var(--c-pos) inset; }
  100% { box-shadow: 0 0 0 0px var(--c-pos) inset; }
}

/* Positive / negative text coloring helpers */
.values [data-sign="pos"], .lastval[data-sign="pos"] { color: var(--c-pos); }
.values [data-sign="neg"], .lastval[data-sign="neg"] { color: var(--c-neg); }

/* ============================================
      BUTTONS
   ============================================ */
button {
  padding: .7rem 1rem;
  font-size: 1rem;
  font-weight: 300;
  border: 2px solid var(--c-input-border);
  color: var(--c-fg);
  background: var(--c-input-bg);
  cursor: pointer;
  border-radius: var(--radius);
  font-family: var(--font-current);
  transition: background-color 0.3s ease, border-color 0.3s ease;
}

button:hover { 
  background: var(--c-input-bg);
  text-decoration: underline;
}

/* Visible focus for keyboard navigation */
button:focus-visible { 
  outline: 3px solid var(--c-pos); 
  outline-offset: 2px; 
}

/* Disabled state for loading moments */
button:disabled {
  opacity: 0.4;
  cursor: not-allowed;
}

/* Smaller buttons inside the top-right toolbar controls */
.toolbar-controls button {
  font-size: 0.8rem;
  padding: 0.4rem 0.75rem;
}

/* ============================================
      VALUE CHIPS
      - Recent values per account; click to edit/delete.
   ============================================ */
.values { 
  display: flex; 
  justify-content: flex-end;
  gap: .6rem; 
  overflow-x: auto;
  width: 100%;
}

/* Chip representing a single past entry value */
.chip {
  padding: .25rem .6rem;
  border-radius: 999px;
  border: 1px solid var(--c-input-border);
  font-variant-numeric: tabular-nums;
  font-size: .95rem;
  cursor: pointer;
  user-select: none;
  flex-shrink: 0;
  transition: all 0.2s ease;
  color: var(--c-fg);
  background: var(--c-input-bg);
}

/* Hover uses positive background (green) for emphasis */
.chip:hover {
  background: var(--c-pos);
  color: var(--c-white);
  transform: scale(1.05);
}

/* ‚ÄúNo delete‚Äù chip: old format / non-editable. */
.chip.no-delete {
  cursor: default;
  opacity: 0.7;
  background: transparent;
  color: var(--c-fg);
}
.chip.no-delete:hover {
  background: transparent;
  color: var(--c-fg);
  transform: none;
}

/* ============================================
      MOBILE RATIO BARS
      - Char-based bar (‚ñà‚ñà) for per-account share of assets/debts.
   ============================================ */
.ratio-bar {
  display: none;
  font-size: 1.5rem;
  margin: 0;
  padding: 0;
  white-space: nowrap;
  letter-spacing: -1px;
}
.ratio-bar span {
  display: inline-block;
}

/* ============================================
      BOTTOM SECTION (Score, Font & Dark Mode)
      - Credit card metrics + score display + font nav + dark mode.
   ============================================ */
.bottom-section {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: 1.5rem;
  padding: 2rem 2rem 1rem;
  width: 100%;
  box-sizing: border-box;
}

/* CC LIMIT / CC DEBT METRICS */
.cc-metrics {
  display: flex;
  flex-direction: row;
  justify-content: center;
  align-items: flex-end;
  gap: 2rem;
  margin-bottom: 1rem;
  text-align: center;
}

.cc-metric {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 0.25rem;
}

/* Numeric value (big) for CC limit / debt */
.cc-metric-value {
  font-size: 2.2rem;
  font-weight: 600;
  letter-spacing: 0.05em;
  font-variant-numeric: tabular-nums;
  color: var(--c-fg);
}

/* Label text below CC metric value */
.cc-metric-label {
  font-size: 0.8rem;
  font-weight: 500;
  letter-spacing: 0.2em;
  text-transform: uppercase;
  color: var(--c-fg);
}

/* ‚ÄúScore‚Äù numeric indicator for the user‚Äôs subjective state */
#score-display {
  font-size: 50px;
  font-weight: 300;
  color: #b5a8a8;
  font-family: monospace; /* Can be overridden, or left as monospace for scoreboard feel */
  letter-spacing: 0.2em;
  cursor: pointer;
  user-select: none;
  transition: opacity 0.2s ease, transform 0.2s ease;
  padding: 0;
  margin: 0;
  line-height: 1;
  align-items: center;
}

#score-display:hover { opacity: 0.8; }
#score-display:active { transform: scale(0.98); }

/* Container for font nav arrows + dark mode toggle */
.bottom-controls-container {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 1.5rem; /* Space between arrows and toggle */
}

/* Left/right arrows to cycle font options */
.font-nav-btn {
  font-size: 4.5rem; /* Increased 50% from earlier version */
  line-height: 1;
  font-weight: 300;
  cursor: pointer;
  user-select: none;
  color: var(--c-fg);
  opacity: 0.6;
  transition: opacity 0.2s ease, transform 0.2s ease;
}

.font-nav-btn:hover {
  opacity: 1;
  transform: scale(1.1);
}

.font-nav-btn:active {
  transform: scale(0.95);
}

/* Wrapper for dark mode checkbox + icon indicator */
.bottom-dark-mode-toggle {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 0.4rem;
}

/* Square checkbox that gets a checkmark when enabled */
.dark-mode-checkbox-label {
  display: flex;
  justify-content: center;
}

.dark-mode-checkbox-label input[type="checkbox"] {
  appearance: none;
  -webkit-appearance: none;
  width: 28px;
  height: 28px;
  margin: 0;
  cursor: pointer;
  background: var(--c-bg);
  border: 2px solid var(--c-fg);
  border-radius: 3px;
  background-repeat: no-repeat;
  background-position: center;
  background-size: 80% 80%;
}

/* Inline SVG check icon when checked */
.dark-mode-checkbox-label input[type="checkbox"]:checked {
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='black' stroke-width='3'%3E%3Cpolyline points='20 6 9 17 4 12'%3E%3C/polyline%3E%3C/svg%3E");
}

.dark-mode-checkbox-label input[type="checkbox"]:focus-visible {
  outline: 2px solid var(--c-pos);
  outline-offset: 2px;
}

/* Icon next to checkbox, changes between ‚óê/‚óë in JS */
.dark-mode-icon {
  font-size: 1.3rem;
  line-height: 1;
  color: var(--c-fg);
  user-select: none;
  transition: opacity 0.25s ease, transform 0.25s ease;
}

/* ============================================
      FOOTER
      - Privacy note + version features + sheet link.
   ============================================ */
footer { 
  padding: 16px 24px 24px;
  text-align: center;
  font-size: 0.7rem;
  line-height: 1.6;
  opacity: 0.8;
  color: var(--c-fg);
}

footer small {
  font-size: 0.7rem;
  display: block;
  margin-bottom: 8px;
}

footer a {
  font-size: 0.7rem;
  color: var(--c-black);
  text-decoration: underline;
  opacity: 0.9;
}

footer a:hover {
  opacity: 1;
  text-decoration: none;
}

footer b { font-weight: 600; }

/* Highlighted ‚Äúprivacy-first‚Äù security note block */
.security-notice {
  font-size: 0.7rem;
  background: var(--c-tint-pos);
  padding: 10px 14px;
  border-radius: 8px;
  margin: 16px auto 8px;
  max-width: 900px;
  border-left: 3px solid var(--c-pos);
  text-align: left;
  line-height: 1.5;
  color: var(--c-fg);
  transition: background-color 0.3s ease;
}

.security-notice strong {
  font-weight: 700;
  color: var(--c-pos);
}

/* ============================================
      TOAST
      - Lightweight notification bubble (bottom center).
   ============================================ */
#toast {
  position: fixed;
  bottom: 20px;
  left: 50%;
  transform: translateX(-50%);
  padding: 12px 24px;
  border-radius: var(--radius);
  background: var(--c-toast-bg);
  color: var(--c-toast-fg);
  border: 2px solid var(--c-pos);
  font-weight: 500;
  z-index: 100;
  opacity: 0;
  visibility: hidden;
  transition: opacity 0.3s ease, visibility 0.3s ease, bottom 0.3s ease;
}

/* Visible state of toast */
#toast.show {
  opacity: 1;
  visibility: visible;
  bottom: 30px;
}

/* Error vs success color accents (border only). */
#toast[data-type="error"] {
  background: var(--c-toast-bg);
  color: var(--c-toast-fg);
  border-color: var(--c-neg);
}

#toast[data-type="success"] {
  background: var(--c-toast-bg);
  color: var(--c-toast-fg);
  border-color: var(--c-pos);
}

/* ============================================
      MODALS (Shared)
      - Reusable base styles for all modal overlays.
   ============================================ */
.modal-backdrop {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.6);
  z-index: 200;
  display: none;
  opacity: 0;
  transition: opacity 0.3s ease;
}

/* Darker backdrop when in dark mode */
:root.dark-mode .modal-backdrop {
  background: rgba(0, 0, 0, 0.8);
}

/* Centered modal box */
.modal {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  background: var(--c-modal-bg);
  color: var(--c-modal-fg);
  border: 2px solid var(--c-modal-border);
  border-radius: var(--radius);
  z-index: 201;
  padding: 24px;
  width: 90vw;
  max-width: 400px;
  display: none;
  opacity: 0;
  transition: opacity 0.3s ease, top 0.3s ease;
}

/* Visible state for modals/backdrops */
.modal-backdrop.show, .modal.show {
  display: block;
  opacity: 1;
}

.modal h3 { margin-top: 0; color: var(--c-modal-fg); }
.modal p { margin-top: 0; line-height: 1.4; color: var(--c-modal-fg); }

/* Block for showing descriptive details inside modals */
.modal-details { font-weight: 600; display: block; margin: 12px 0; font-size: 1.1rem; color: var(--c-modal-fg); }

/* Standard area for buttons inside modals */
.modal-buttons { display: flex; gap: 12px; justify-content: flex-end; margin-top: 20px; }

/* Standard label/input grouping inside modals */
.modal-form-group { margin-bottom: 16px; }
.modal-form-group label { display: block; margin-bottom: 6px; font-weight: 600; font-size: 0.9rem; color: var(--c-modal-fg); }
.modal-form-group input, .modal-form-group select {
  width: 100%; max-width: 100%; box-sizing: border-box;
  background: var(--c-input-bg); color: var(--c-fg);
  border: 1px solid var(--c-input-border); padding: 8px; border-radius: 4px;
}

/* Red confirm button for delete actions */
#delete-btn-confirm { background: var(--c-neg); color: var(--c-white); border-color: var(--c-neg); }

/* Save buttons across modals (green-ish) */
#edit-chip-save, #edit-account-save, #edit-type-save { background: var(--c-pos); color: var(--c-white); border-color: var(--c-pos); }

/* Account menu modal: vertical stacked buttons */
#account-menu-modal .modal-buttons { flex-direction: column; }
#account-menu-modal .modal-buttons button { width: 100%; text-align: left; padding: 1rem; font-size: 1.1rem; }
#account-menu-delete { background: var(--c-neg); color: var(--c-white); border-color: var(--c-neg); }
#account-menu-add { background: var(--c-pos); color: var(--c-white); border-color: var(--c-pos); }

/* ============================================
      TYPE SUMMARY ITEMS
      - Small per-type chips in the toolbar.
   ============================================ */
.type-item {
  display: inline-flex;
  flex-direction: column;
  align-items: center;
  gap: 0.08rem;
  font-size: 0.8rem;
  padding: 0.25rem 0.4rem;
  border-radius: 12px;
  min-width: 96px;
  color: var(--c-fg);
}

/* Dimmed state when type is muted */
.type-item.muted { opacity: 0.4; }

.type-item .type-value { font-weight: 600; white-space: nowrap; font-size: 0.8rem; }
.type-item .type-value.positive { color: var(--c-pos); }
.type-item .type-value.negative { color: var(--c-neg); }

/* Label text with double-click to edit type color */
.type-item .type-label { font-weight: 500; letter-spacing: 0.06em; font-size: 0.7rem; cursor: pointer; }

/* Little ‚Äúenable/disable‚Äù checkbox for each type */
.type-toggle-label {
  font-size: 0.65rem;
  display: flex;
  align-items: center;
  gap: 0.25rem;
  color: var(--c-fg);
  cursor: pointer;
}

.type-toggle-label input[type="checkbox"] {
  appearance: none; -webkit-appearance: none; width: 14px; height: 14px; margin: 0; cursor: pointer;
  background: white; border: 1.5px solid black; border-radius: 2px;
}
.type-toggle-label input[type="checkbox"]:checked {
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='black' stroke-width='3'%3E%3Cpolyline points='20 6 9 17 4 12'%3E%3C/polyline%3E%3C/svg%3E");
  background-size: contain; background-repeat: no-repeat; background-position: center;
}

/* ============================================
      MUTE TOGGLE
      - Per-account mute slider (on right of input).
   ============================================ */
.mute-checkbox { position: relative; width: 48px; height: 28px; flex-shrink: 0; }
.mute-checkbox input[type="checkbox"] { position: absolute; opacity: 0; width: 100%; height: 100%; cursor: pointer; z-index: 2; margin: 0; }
.mute-checkbox-slider {
  position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: var(--c-pos); border: none; border-radius: 999px;
  transition: background 0.3s ease; pointer-events: none; box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.08);
}
.mute-checkbox-slider::before {
  content: ''; position: absolute; height: 22px; width: 22px; left: 3px; bottom: 3px; background: var(--c-white); border: none; border-radius: 50%;
  transition: transform 0.3s ease; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.15);
}
.mute-checkbox input[type="checkbox"]:checked + .mute-checkbox-slider { background: var(--c-muted); }
.mute-checkbox input[type="checkbox"]:checked + .mute-checkbox-slider::before { transform: translateX(20px); }

/* ‚ÄúMuted‚Äù row style (visually deemphasized, but retained in DOM) */
.row.muted { opacity: 0.5; }
.row.muted * { color: var(--c-muted) !important; border-color: var(--c-muted) !important; background-color: transparent !important; }
.row.muted input[type="number"] { background: transparent !important; color: var(--c-muted) !important; }
.row.muted .mute-checkbox-slider { background: var(--c-muted) !important; border-color: var(--c-muted) !important; }
.row.muted .mute-checkbox-slider::before { background: var(--c-white) !important; border-color: var(--c-muted) !important; }

/* ============================================
      MOBILE
      - Layout tweaks for narrow screens.
   ============================================ */
@media (max-width: 650px) {
  .row { flex-direction: column; }
  .right { min-width: unset; text-align: left; align-self: flex-start; padding-top: 0.5rem; }
  .right .values { display: none; }       /* Hide chips on right for mobile */
  .right .ratio-bar { display: block; }   /* Show character ratio bar instead */
  .left { gap: 8px; width: 100%; padding-right: 0; }
  input[type="number"], input[type="date"], input[type="text"], input[type="url"] { width: 100%; max-width: 100%; }
  .input-line { width: 100%; margin-left: 0; padding-top: 0; }
  .apr { padding-top: 0; }
  .toolbar { flex-direction: column; align-items: flex-start; justify-content: flex-start; padding: 6px 16px 10px 16px; }
  .financial-group { flex-direction: column; align-items: center; width: 100%; }
  #financial-summary { font-size: 4.2rem; padding-bottom: 4px; width: 100%; text-align: center; }
  #interest-summary { font-size: 1.8rem; width: 100%; text-align: center; padding-bottom: 4px; }
  .toolbar-right { align-items: center; max-width: 100%; width: 100%; }
  .type-filter-row { justify-content: center; }
  .toolbar-controls { justify-content: center; width: 100%; }
  .lastval, .name { font-size: 2rem; }
  footer, footer small, footer a, .security-notice { font-size: 0.75rem; }
  #score-display { font-size: 60px; }
  .bottom-section { padding: 1.5rem 1rem; gap: 1rem; }

  /* Mobile-specific toggling behavior for dark mode icon (if used) */
  .dark-mode-toggle-icon { font-size: 1.3rem; line-height: 1; color: var(--c-fg); user-select: none; transition: opacity 0.25s ease, transform 0.25s ease; }
  .dark-mode-toggle-label input[type="checkbox"]:checked ~ .dark-mode-toggle-icon { transform: rotate(180deg); opacity: 0.9; }

  /* CC metrics stack vertically on mobile */
  .cc-metrics {
    flex-direction: column;
    align-items: center;
    gap: 0.5rem;
  }
}
</style>
</head>
<body>
<!-- Toast notification container (used by JS for quick status messages) -->
<div id="toast" role="status" aria-live="polite"></div>

<!-- Delete confirmation modal -->
<div id="delete-modal-backdrop" class="modal-backdrop"></div>
<div id="delete-modal" class="modal" role="alertdialog" aria-modal="true" aria-labelledby="delete-modal-title">
  <h3 id="delete-modal-title">Delete Entry?</h3>
  <p>Do you really want to delete this entry?</p>
  <span id="delete-modal-details" class="modal-details"></span>
  <div id="delete-modal-buttons" class="modal-buttons">
    <button id="delete-btn-cancel">Cancel</button>
    <button id="delete-btn-confirm">Yes, Delete</button>
  </div>
</div>

<!-- Edit chip modal (edit single historical value) -->
<div id="edit-chip-modal-backdrop" class="modal-backdrop"></div>
<div id="edit-chip-modal" class="modal" role="dialog" aria-modal="true" aria-labelledby="edit-chip-modal-title">
  <h3 id="edit-chip-modal-title">Edit Entry</h3>
  <div class="modal-form-group">
    <label for="edit-chip-value">Value:</label>
    <input type="number" id="edit-chip-value" step="0.01" placeholder="Enter value">
  </div>
  <div class="modal-form-group">
    <label for="edit-chip-date">Date:</label>
    <input type="date" id="edit-chip-date">
  </div>
  <span id="edit-chip-details" class="modal-details"></span>
  <div id="edit-chip-buttons" class="modal-buttons">
    <button id="edit-chip-delete">Delete</button>
    <button id="edit-chip-cancel">Cancel</button>
    <button id="edit-chip-save">Save</button>
  </div>
</div>

<!-- Account menu modal (long-press on account name to open) -->
<div id="account-menu-modal-backdrop" class="modal-backdrop"></div>
<div id="account-menu-modal" class="modal" role="dialog" aria-modal="true" aria-labelledby="account-menu-modal-title">
  <h3 id="account-menu-modal-title">Account Actions</h3>
  <p id="account-menu-account-name" style="font-weight: 600; font-size: 1.2rem; margin-bottom: 1rem;"></p>
  <div id="account-menu-buttons" class="modal-buttons">
    <button id="account-menu-edit">‚úèÔ∏è Edit Account Settings</button>
    <button id="account-menu-delete">üóëÔ∏è Delete Account</button>
    <button id="account-menu-add">‚ûï Add New Account Below</button>
    <button id="account-menu-cancel">Cancel</button>
  </div>
</div>

<!-- Edit Account modal (type, color, link, limit, APR, current value) -->
<div id="edit-account-modal-backdrop" class="modal-backdrop"></div>
<div id="edit-account-modal" class="modal" role="dialog" aria-modal="true" aria-labelledby="edit-account-modal-title">
  <h3 id="edit-account-modal-title">Edit Account</h3>
  <p id="edit-account-name" style="font-weight: 600; font-size: 1.1rem; margin-bottom: 1rem;"></p>
  <div class="modal-form-group">
    <label for="edit-account-type">Type:</label>
    <select id="edit-account-type">
      <option value="bk">Banks</option>
      <option value="cc">CreditCards</option>
      <option value="bill">Bills</option>
      <option value="ii">Investments</option>
      <option value="sv">Savings</option>
    </select>
  </div>
  <div class="modal-form-group">
    <label for="edit-account-color">Account Color (hex):</label>
    <div style="display:flex; gap:8px; align-items:center;">
      <input type="color" id="edit-account-color-picker" style="flex:0 0 40px; padding:0; border-radius:50%; border:1px solid var(--c-input-border); height:40px;">
      <input type="text" id="edit-account-color" placeholder="#4c8036" style="flex:1;">
    </div>
  </div>
  <div class="modal-form-group">
    <label for="edit-account-link">Account Link (login URL, etc.):</label>
    <input type="url" id="edit-account-link" placeholder="https://...">
  </div>
  <div class="modal-form-group">
    <label for="edit-account-limit">Credit Limit (for CC accounts):</label>
    <input type="number" id="edit-account-limit" step="1" placeholder="e.g. 5000">
  </div>
  <div class="modal-form-group">
    <label for="edit-account-apr">APR (as decimal, e.g. 0.29 for 29%):</label>
    <input type="number" id="edit-account-apr" step="0.01" placeholder="e.g. 0.29">
  </div>
  <div class="modal-form-group">
    <label for="edit-account-value">Current Value:</label>
    <input type="number" id="edit-account-value" step="0.01" placeholder="Current balance">
  </div>
  <div id="edit-account-buttons" class="modal-buttons">
    <button id="edit-account-cancel">Cancel</button>
    <button id="edit-account-save">Save Changes</button>
  </div>
</div>

<!-- Edit Type Color modal (used when double-clicking type label in toolbar) -->
<div id="edit-type-modal-backdrop" class="modal-backdrop"></div>
<div id="edit-type-modal" class="modal" role="dialog" aria-modal="true" aria-labelledby="edit-type-modal-title">
  <h3 id="edit-type-modal-title">Edit Type Color</h3>
  <p id="edit-type-name" style="font-weight:600; font-size:1.0rem; margin-bottom:1rem;"></p>
  <div class="modal-form-group">
    <label for="edit-type-color">Type Color (hex):</label>
    <div style="display:flex; gap:8px; align-items:center;">
      <input type="color" id="edit-type-color-picker" style="flex:0 0 40px; padding:0; border-radius:50%; border:1px solid var(--c-input-border); height:40px;">
      <input type="text" id="edit-type-color" placeholder="#4c8036" style="flex:1;">
    </div>
  </div>
  <div class="modal-buttons">
    <button id="edit-type-cancel">Cancel</button>
    <button id="edit-type-save">Save</button>
  </div>
</div>

<!-- Main header section: sticky top with summary, filters, and charts -->
<header>
  <div class="toolbar">
    <!-- Left: total assets vs total debts, and interest summary -->
    <div class="financial-group">
      <div id="financial-summary"></div>
      <div id="interest-summary"></div>
    </div>

    <!-- Right: type summary filters + timeframe/mode/refresh/submit controls -->
    <div class="toolbar-right">
      <div id="typeFilterRow" class="type-filter-row"></div>

      <div class="toolbar-controls">
        <label for="timeframe">Timeframe:</label>
        <select id="timeframe">
          <option value="3d" selected>Last 3 Days</option>
          <option value="today">Today</option>
          <option value="7d">Last 7 Days</option>
          <option value="14d">Last 14 Days</option>
          <option value="30d">Last 30 Days</option>
          <option value="90d">Last 90 Days</option>
          <option value="1y">Last Year (12mo)</option>
          <option value="ytd">This Calendar Year</option>
          <option value="all">All Time</option>
        </select>

        <!-- Chart mode radio buttons -->
        <label><input type="radio" name="mode" value="totals" checked> Totals</label>
        <label><input type="radio" name="mode" value="types"> Type</label>
        <label><input type="radio" name="mode" value="accounts"> Per-account</label>

        <!-- Manual refresh + bulk submit for all rows -->
        <button id="refresh" aria-label="Refresh data">Refresh</button>
        <button id="submitAll">Submit All</button>
      </div>
    </div>
  </div>
  <hr>
  <!-- Main chart container (Google Charts) -->
  <div id="chart"></div>
  <!-- Pager to switch between bar, line, donut chart slides -->
  <div id="chart-pager" aria-label="Chart view navigation"></div>
  <hr>
  <!-- Visual Ratio Bar (Asset vs Debt, full-width) -->
  <div id="visual-ratio-bar">
    <div id="ratio-asset"></div>
    <div id="ratio-debt"></div>
  </div>
</header>

<!-- Divider separating header from body content -->
<hr class="wrap divider">

<main class="wrap">
  <!-- Dynamic account rows inserted here via JS -->
  <section id="accounts" class="accounts"></section>

  <!-- Bottom section with CC metrics, Score, Font Controls, and Dark Mode toggle -->
  <div class="bottom-section">
    <!-- Credit card metrics derived from AccountMeta + current balances -->
    <div class="cc-metrics">
      <div class="cc-metric">
        <div id="cc-limit-value" class="cc-metric-value">0</div>
        <div class="cc-metric-label">CC LIMIT</div>
      </div>
      <div class="cc-metric">
        <div id="cc-debt-value" class="cc-metric-value">0</div>
        <div class="cc-metric-label">CC DEBT</div>
      </div>
    </div>

    <!-- 3-digit ‚Äúscoreboard‚Äù display, editable via click -->
    <div id="score-display">000</div>
    
    <!-- Font Navigation + Dark Mode -->
    <div class="bottom-controls-container">
      <!-- Previous font option -->
      <div id="font-prev" class="font-nav-btn">&lt;</div>
      
      <!-- Checkbox toggles dark-mode root class; icon label below -->
      <div class="bottom-dark-mode-toggle">
        <label class="dark-mode-checkbox-label">
          <input type="checkbox" id="dark-mode-checkbox" aria-label="Toggle dark mode">
        </label>
        <div id="dark-mode-icon" class="dark-mode-icon">‚óê</div>
      </div>
      
      <!-- Next font option -->
      <div id="font-next" class="font-nav-btn">&gt;</div>
    </div>
  </div>

  <!-- Footer with privacy statement and version features list -->
  <footer>
    <div class="security-notice">
      üîí <strong>Privacy First:</strong> No login credentials or personally identifiable 
      information is stored in this application. All data resides in your Google Sheet. 
      Your financial footprint, your control.
    </div>

    <small>
      <b>v2.6 Features:</b> CC limits ‚Ä¢ Edit account settings ‚Ä¢ Type summaries ‚Ä¢ Font Switcher ‚Ä¢ Mute/unmute ‚Ä¢ Dark mode üåô ‚Ä¢ Score tracker üìä ‚Ä¢ AccountMeta persistence<br>
      <a href="https://docs.google.com/spreadsheets/d/YOUR_SHEET_ID_HERE" target="_blank" rel="noopener">üìä Open Google Sheet</a>
    </small>
  </footer>
</main>

<script>
/* ============================================
    CONFIGURATION
    - Backend endpoint + sheet ID used by the app.
   ============================================ */
const API_BASE = 'https://script.google.com/macros/s/AKfycbxDKAcw3_UHSMdRzsEktFgBcW1Wao0XysRFpqTlQq-sBqHVGjzbl1YM1ZBFcXJy7tV1/exec';
const SHEET_ID = '1v5Xc57U77arzf-JUqe85Iwwh-9Z1i1u0Rcmyrans9o8/edit?usp=sharing';

/* ============================================
    APPLICATION STATE
    - SNAP: latest snapshot from backend (accounts, series, etc.)
    - MODE: chart mode (totals, types, accounts)
    - TIMEFRAME: current timeframe filter
    - MUTED_ACCOUNTS / MUTED_TYPES: sets of IDs to hide
    - DARK_MODE: boolean; CHART_SLIDE: 0..2 for slide pager
   ============================================ */
let SNAP = null;
let MODE = 'totals';
let TIMEFRAME = '3d';
let IS_LOADING = false;
let TOAST_TIMER = null;
let LONG_PRESS_TIMER = null;
const LONG_PRESS_DURATION = 500;

let MUTED_ACCOUNTS = new Set();
let MUTED_TYPES = new Set();
let DARK_MODE = false;
let SCORE = 0;
let CHART_SLIDE = 0;          // 0..2
const MAX_CHART_SLIDE = 2;    // 3 chart views total

// Fonts List (DM Mono and Gloria Hallelujah removed)
const FONT_OPTIONS = [
  'system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif',
  '"Geologica", sans-serif',
  '"Inconsolata", monospace',
  '"Patrick Hand", cursive'
];
let CURRENT_FONT_INDEX = 0;

/* Standard internal type codes ‚Üí human labels */
const TYPE_LABELS = {
  'bk': 'Banks',
  'cc': 'CreditCards',
  'bill': 'Bills',
  'ii': 'Investments',
  'sv': 'Savings'
};

/* Metadata containers:
   - ACCOUNT_METADATA: per-account limit/color/link
   - TYPE_META_OVERRIDES: per-type color overrides (stored in URL hash)
*/
let ACCOUNT_METADATA = new Map();      // accountName -> { limit, color, link }
let TYPE_META_OVERRIDES = new Map();   // typeCode -> { color }

/* ============================================
    FONT SWITCHER
    - Uses CSS custom property --font-current.
   ============================================ */
function updateFont() {
  const font = FONT_OPTIONS[CURRENT_FONT_INDEX];
  document.documentElement.style.setProperty('--font-current', font);
  saveStateToURL();
}

/* Cycle font index forward/backward and show toast */
function cycleFont(direction) {
  if (direction === 'next') {
    CURRENT_FONT_INDEX = (CURRENT_FONT_INDEX + 1) % FONT_OPTIONS.length;
  } else {
    CURRENT_FONT_INDEX = (CURRENT_FONT_INDEX - 1 + FONT_OPTIONS.length) % FONT_OPTIONS.length;
  }
  updateFont();
  showToast(`Font changed to option ${CURRENT_FONT_INDEX + 1}`, 'info', 1000);
}

/* ============================================
    DARK MODE
    - Controlled by DARK_MODE boolean and root class.
   ============================================ */
function applyDarkModeClass() {
  const root = document.documentElement;
  if (DARK_MODE) {
    root.classList.add('dark-mode');
  } else {
    root.classList.remove('dark-mode');
  }
}

/* Icon text toggles between ‚óê and ‚óë to reflect mode */
function updateDarkModeIcon() {
  const iconEl = document.getElementById('dark-mode-icon');
  if (!iconEl) return;
  iconEl.textContent = DARK_MODE ? '‚óë' : '‚óê';
}

/* Toggle dark mode flag, re-apply class and persist in URL */
function toggleDarkMode() {
  DARK_MODE = !DARK_MODE;
  applyDarkModeClass();
  const checkbox = document.getElementById('dark-mode-checkbox');
  if (checkbox) checkbox.checked = DARK_MODE;
  updateDarkModeIcon();
  saveStateToURL();
}

/* Wire checkbox event + initial apply */
function initDarkMode() {
  const checkbox = document.getElementById('dark-mode-checkbox');
  if (!checkbox) return;
  checkbox.addEventListener('change', toggleDarkMode);
  applyDarkModeClass();
  checkbox.checked = DARK_MODE;
  updateDarkModeIcon();
}

/* Simple heuristic: auto-enable dark mode between 8pm‚Äì6am local time */
function shouldAutoEnableDarkMode() {
  const hour = new Date().getHours();
  return hour >= 20 || hour < 6;
}

/* Initialize theme from URL hash or auto-detect; also sets font */
function initializeTheme() {
  const hash = window.location.hash.substring(1);
  const params = new URLSearchParams(hash);
  
  // Dark Mode from URL state if present
  const darkModeParam = params.get('darkMode');
  if (darkModeParam === 'true') {
    DARK_MODE = true;
  } else if (darkModeParam === 'false') {
    DARK_MODE = false;
  } else {
    DARK_MODE = shouldAutoEnableDarkMode();
  }

  // Font selection from URL state if present
  const fontParam = params.get('font');
  if (fontParam) {
    const idx = parseInt(fontParam, 10);
    if (!isNaN(idx) && idx >= 0 && idx < FONT_OPTIONS.length) {
      CURRENT_FONT_INDEX = idx;
    }
  }
  updateFont();
}

/* ============================================
    SCORE MANAGEMENT
    - Basic scoreboard display (000‚Äì999).
   ============================================ */
function formatScore(num) {
  return String(num).padStart(3, '0');
}

function renderScore() {
  const scoreDisplay = document.getElementById('score-display');
  if (scoreDisplay) {
    scoreDisplay.textContent = formatScore(SCORE);
  }
}

/* ============================================
    SCORE EDITING
    - On click, open a simple modal to modify the score.
   ============================================ */
function showEditScoreModal() {
  const backdrop = document.createElement('div');
  backdrop.className = 'modal-backdrop show';
  backdrop.id = 'score-edit-backdrop';

  const modal = document.createElement('div');
  modal.className = 'modal show';
  modal.id = 'score-edit-modal';
  modal.setAttribute('role', 'dialog');
  modal.setAttribute('aria-modal', 'true');

  modal.innerHTML = `
    <h3>Edit Score</h3>
    <div class="modal-form-group">
      <label for="score-input">New Score (0-999):</label>
      <input type="number" id="score-input" min="0" max="999" step="1" placeholder="000">
    </div>
    <div class="modal-buttons">
      <button id="score-cancel">Cancel</button>
      <button id="score-save">Save</button>
    </div>
  `;

  document.body.appendChild(backdrop);
  document.body.appendChild(modal);

  const input = document.getElementById('score-input');
  input.value = SCORE;
  setTimeout(() => input.focus(), 100);

  /* Close on cancel */
  document.getElementById('score-cancel').addEventListener('click', () => {
    backdrop.remove();
    modal.remove();
  });

  /* Save triggers backend updateScore route */
  document.getElementById('score-save').addEventListener('click', () => {
    processUpdateScore(input.value, backdrop, modal);
  });

  /* Clicking outside modal closes it */
  backdrop.addEventListener('click', () => {
    backdrop.remove();
    modal.remove();
  });

  /* Enter key also saves */
  input.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') {
      processUpdateScore(input.value, backdrop, modal);
    }
  });
}

/* Persist score change to backend (updateScore route) */
async function processUpdateScore(newValue, backdrop, modal) {
  const val = Number(newValue);
  if (isNaN(val) || val < 0 || val > 999) {
    showToast('Please enter a score between 0 and 999', 'error');
    return;
  }

  backdrop.remove();
  modal.remove();

  setLoading(true, 'Updating score‚Ä¶');

  try {
    const body = new URLSearchParams({
      payload: JSON.stringify({ score: val })
    });

    const res = await fetch(`${API_BASE}?route=updateScore`, { 
      method: 'POST', 
      body 
    });
    const text = await res.text();
    const j = JSON.parse(text);

    if (!j.ok) {
      throw new Error(j.error || 'Update failed');
    }

    SCORE = val;
    saveStateToURL();
    renderScore();
    setLoading(false);
    showToast('Score updated!', 'success');

  } catch (e) {
    console.error('Score update error:', e);
    setLoading(false);
    showToast('Failed to update score: ' + e.message, 'error', 5000);
  }
}

/* ============================================
    UI UTILITIES
    - Toast & loading state handling.
   ============================================ */

/* Show toast info/error/success messages */
function showToast(msg, type = 'info', duration = 3000) {
  const el = document.getElementById('toast');
  if (!el) return;

  if (TOAST_TIMER) clearTimeout(TOAST_TIMER);

  el.textContent = msg;
  el.dataset.type = type;
  el.classList.add('show');

  TOAST_TIMER = setTimeout(() => el.classList.remove('show'), duration);
}

/* Toggle global loading state:
   - Disables refresh/submit buttons.
   - Disables row number inputs while submitting.
*/
function setLoading(loading, message) {
  IS_LOADING = loading;
  const refresh = document.getElementById('refresh');
  const submitAll = document.getElementById('submitAll');
  if (refresh) refresh.disabled = loading;
  if (submitAll) submitAll.disabled = loading;
  document.querySelectorAll('.row .left input[type="number"]').forEach(inp => {
    inp.disabled = loading;
    inp.classList.toggle('submitting', loading);
  });
  if (message && !document.getElementById('delete-modal-backdrop').classList.contains('show')) {
    showToast(message, 'info', loading ? 10000 : 3000);
  }
}

/* ============================================
    DELETE MODAL
    - Confirm deletion of a specific date/value entry.
   ============================================ */
function showDeleteConfirm(account, date, value, readableValue) {
  if (IS_LOADING) return;
  const backdrop = document.getElementById('delete-modal-backdrop');
  const modal = document.getElementById('delete-modal');
  const details = document.getElementById('delete-modal-details');
  const confirmBtn = document.getElementById('delete-btn-confirm');

  details.textContent = `${account}: ${readableValue} on ${date}`;
  backdrop.classList.add('show');
  modal.classList.add('show');
  confirmBtn.onclick = () => processDelete(account, date, value);
}

/* Hide delete confirmation modal */
function hideDeleteConfirm() {
  document.getElementById('delete-modal-backdrop').classList.remove('show');
  document.getElementById('delete-modal').classList.remove('show');
}

/* Call backend delete route with account/date/value */
async function processDelete(account, date, value) {
  hideDeleteConfirm();
  if (IS_LOADING) return;
  setLoading(true, 'Deleting entry‚Ä¶');

  try {
    const body = new URLSearchParams({ 
      payload: JSON.stringify({ account, date, value: Number(value) }) 
    });

    const res = await fetch(`${API_BASE}?route=delete`, { method: 'POST', body });
    const text = await res.text();
    let j;
    try { j = JSON.parse(text); } catch {
      console.error('Delete non-JSON:', text);
      showToast('Delete failed (non-JSON response)', 'error', 5000);
      setLoading(false);
      return;
    }

    if (!j.ok) {
      console.error('Delete JSON error:', j);
      showToast(`Delete failed: ${j.error || 'Unknown'}`, 'error', 5000);
      setLoading(false);
      return;
    }
    showToast('Entry deleted. Refreshing‚Ä¶', 'success');
    await fetchSnapshot();
  } catch (e) {
    console.error(e);
    setLoading(false);
    showToast('Network error deleting entry.', 'error', 5000);
  }
}

/* ============================================
    EDIT CHIP MODAL
    - Update date and/or value for an existing entry.
   ============================================ */
function showEditChipModal(account, date, value, readableValue) {
  if (IS_LOADING) return;
  const backdrop = document.getElementById('edit-chip-modal-backdrop');
  const modal = document.getElementById('edit-chip-modal');
  const details = document.getElementById('edit-chip-details');
  const valueInput = document.getElementById('edit-chip-value');
  const dateInput = document.getElementById('edit-chip-date');
  const saveBtn = document.getElementById('edit-chip-save');
  const deleteBtn = document.getElementById('edit-chip-delete');

  details.textContent = `Account: ${account}`;
  valueInput.value = Number(value);

  /* Convert MM/DD/YYYY -> YYYY-MM-DD for date input */
  const dateParts = date.split('/');
  if (dateParts.length === 3) {
    const [month, day, year] = dateParts;
    dateInput.value = `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`;
  } else {
    dateInput.value = '';
  }

  backdrop.classList.add('show');
  modal.classList.add('show');
  setTimeout(() => valueInput.focus(), 100);

  saveBtn.onclick = () => processEditChip(account, date, value);
  deleteBtn.onclick = () => {
    hideEditChipModal();
    showDeleteConfirm(account, date, value, readableValue);
  };
}

/* Hide chip edit modal UI */
function hideEditChipModal() {
  document.getElementById('edit-chip-modal-backdrop').classList.remove('show');
  document.getElementById('edit-chip-modal').classList.remove('show');
}

/* Apply chip edit by deleting old data point and inserting new one */
async function processEditChip(originalAccount, originalDate, originalValue) {
  if (IS_LOADING) return;
  const valueInput = document.getElementById('edit-chip-value');
  const dateInput = document.getElementById('edit-chip-date');

  const newValue = Number(valueInput.value);
  const newDateISO = dateInput.value;

  if (isNaN(newValue) || newValue === 0) {
    showToast('Please enter a valid non-zero value', 'error');
    return;
  }
  if (!newDateISO) {
    showToast('Please select a date', 'error');
    return;
  }

  const [year, month, day] = newDateISO.split('-');
  const newDate = `${parseInt(month)}/${parseInt(day)}/${year}`;

  hideEditChipModal();
  setLoading(true, 'Updating entry‚Ä¶');

  try {
    /* Delete original entry */
    const deleteBody = new URLSearchParams({ 
      payload: JSON.stringify({ account: originalAccount, date: originalDate, value: Number(originalValue) }) 
    });
    const deleteRes = await fetch(`${API_BASE}?route=delete`, { method: 'POST', body: deleteBody });
    const deleteText = await deleteRes.text();
    const deleteJson = JSON.parse(deleteText);
    if (!deleteJson.ok) throw new Error('Delete failed: ' + (deleteJson.error || 'Unknown'));

    /* Submit replacement entry with updated date/value */
    const submitBody = new URLSearchParams({ 
      payload: JSON.stringify({ 
        entries: [{ account: originalAccount, value: newValue, date: newDate }] 
      }) 
    });
    const submitRes = await fetch(`${API_BASE}?route=submit`, { method: 'POST', body: submitBody });
    const submitText = await submitRes.text();
    const submitJson = JSON.parse(submitText);
    if (!submitJson.ok) throw new Error('Submit failed: ' + (submitJson.error || 'Unknown'));

    showToast('Entry updated! Refreshing‚Ä¶', 'success');
    await fetchSnapshot();
  } catch (e) {
    console.error('Edit error:', e);
    setLoading(false);
    showToast('Failed to update entry: ' + e.message, 'error', 5000);
  }
}

/* ============================================
    ACCOUNT MENU MODAL
    - Long-press on account name to open.
   ============================================ */
function showAccountMenu(accountName) {
  if (IS_LOADING) return;
  const backdrop = document.getElementById('account-menu-modal-backdrop');
  const modal = document.getElementById('account-menu-modal');
  const accountNameEl = document.getElementById('account-menu-account-name');
  const deleteBtn = document.getElementById('account-menu-delete');
  const addBtn = document.getElementById('account-menu-add');
  const editBtn = document.getElementById('account-menu-edit');

  accountNameEl.textContent = accountName;
  backdrop.classList.add('show');
  modal.classList.add('show');

  /* Edit opens Edit Account modal */
  editBtn.onclick = () => { hideAccountMenu(); showEditAccountModal(accountName); };
  /* Delete & Add currently just show ‚Äúcoming soon‚Äù toasts */
  deleteBtn.onclick = () => { hideAccountMenu(); showToast('Account deletion coming in a future version.', 'info', 3000); };
  addBtn.onclick = () => { hideAccountMenu(); showToast('Add account feature coming in a future version.', 'info', 3000); };
}

/* Close account menu modal */
function hideAccountMenu() {
  document.getElementById('account-menu-modal-backdrop').classList.remove('show');
  document.getElementById('account-menu-modal').classList.remove('show');
}

/* ============================================
    EDIT ACCOUNT MODAL
    - Color, limit, type, APR, link, and last value.
   ============================================ */

/* Normalize hex string: ensure leading # and 6 hex digits */
function normalizeHexColor(str) {
  if (!str) return '';
  let s = String(str).trim();
  if (!s) return '';
  if (s[0] !== '#') s = '#' + s;
  if (!/^#[0-9A-Fa-f]{3,6}$/.test(s)) return '';
  if (s.length === 4) s = '#' + s[1]+s[1] + s[2]+s[2] + s[3]+s[3];
  return s.toUpperCase();
}

/* Populate Edit Account modal for a given account name */
function showEditAccountModal(accountName) {
  if (IS_LOADING) return;

  const account = SNAP.accounts.find(a => a.name === accountName);
  if (!account) return showToast('Account not found','error');

  const meta = ACCOUNT_METADATA.get(accountName) || {};

  // Set modal text
  document.getElementById('edit-account-name').textContent = accountName;

  // Type
  document.getElementById('edit-account-type').value = account.type || 'bk';

  // Limit (from AccountMeta sheet)
  document.getElementById('edit-account-limit').value =
    (typeof meta.limit === 'number') ? meta.limit : '';

  // APR (from Accounts sheet)
  document.getElementById('edit-account-apr').value =
    (typeof account.apr === 'number') ? account.apr : '';

  // Color (AccountMeta color or account.color)
  const color = meta.color || account.color || '';
  const norm  = normalizeHexColor(color) || '#4C8036';
  const colorInput  = document.getElementById('edit-account-color');
  const colorPicker = document.getElementById('edit-account-color-picker');
  colorInput.value  = norm;
  colorPicker.value = norm;

  // Link (AccountMeta link if available)
  document.getElementById('edit-account-link').value = meta.link || '';

  // Current value (snapshot last value)
  const last = SNAP.series?.[accountName]?.last ?? 0;
  document.getElementById('edit-account-value').value = last;

  // Sync color picker <-> text input
  colorPicker.oninput = () => { colorInput.value = colorPicker.value; };
  colorInput.oninput  = () => {
    const n = normalizeHexColor(colorInput.value);
    if (n) colorPicker.value = n;
  };

  // Wire SAVE to processEditAccount
  const saveBtn = document.getElementById('edit-account-save');
  saveBtn.onclick = () => processEditAccount(accountName);

  // Show modal
  document.getElementById('edit-account-modal-backdrop').classList.add('show');
  document.getElementById('edit-account-modal').classList.add('show');
}

/* Hide Edit Account modal */
function hideEditAccountModal() {
  document.getElementById('edit-account-modal-backdrop').classList.remove('show');
  document.getElementById('edit-account-modal').classList.remove('show');
}

/* Persist account type/APR/color/limit/link/value back to backend */
async function processEditAccount(accountName) {
  if (IS_LOADING) return;

  const type  = document.getElementById('edit-account-type').value.trim();
  const limit = document.getElementById('edit-account-limit').value.trim();
  const apr   = document.getElementById('edit-account-apr').value.trim();
  const value = document.getElementById('edit-account-value').value.trim();
  const color = normalizeHexColor(
      document.getElementById('edit-account-color').value
  );
  const link  = document.getElementById('edit-account-link').value.trim();

  const metaLimit = limit !== '' && !isNaN(Number(limit)) ? Number(limit) : '';
  const newAPR    = apr   !== '' && !isNaN(Number(apr))   ? Number(apr)   : '';
  const newValue  = value !== '' && !isNaN(Number(value)) ? Number(value) : null;

  hideEditAccountModal();
  showToast('Saving account‚Ä¶','info');

  try {
    /* 1) Save limit/color/link to AccountMeta sheet */
    const metaPayload = {
      entries: [{
        account: accountName,
        limit: metaLimit,
        color: color || '',
        link:  link  || ''
      }]
    };
    await fetch(`${API_BASE}?route=updateAccountMeta`, {
      method: 'POST',
      body: new URLSearchParams({
        payload: JSON.stringify(metaPayload)
      })
    });

    /* 2) Save APR / Type / AccountColor to Accounts sheet */
    const acctPayload = {
      entries: [{
        account: accountName,
        type: type,
        apr: newAPR,
        accountColor: color || ''
      }]
    };
    await fetch(`${API_BASE}?route=updateAccount`, {
      method: 'POST',
      body: new URLSearchParams({
        payload: JSON.stringify(acctPayload)
      })
    });

    /* 3) If value changed vs last known, append new Values entry */
    const current = SNAP.series?.[accountName]?.last ?? null;
    if (newValue !== null && newValue !== current) {
      await fetch(`${API_BASE}?route=submit`, {
        method: 'POST',
        body: new URLSearchParams({
          payload: JSON.stringify({
            entries: [{ account: accountName, value: newValue }]
          })
        })
      });
    }

    showToast('Saved!', 'success');
    await fetchSnapshot();

  } catch (err) {
    console.error(err);
    showToast('Error saving: ' + err.message, 'error', 5000);
  }
}

/* ============================================
    EDIT TYPE COLOR MODAL
    - Allows per-type color overrides stored locally.
   ============================================ */

/* Resolve effective color for a type:
   - 1) Local override (TYPE_META_OVERRIDES)
   - 2) Backend typeMeta.color
   - 3) Default red for cc/bill, green otherwise
*/
function getTypeEffectiveColor(typeCode) {
  const override = TYPE_META_OVERRIDES.get(typeCode);
  if (override && override.color) return override.color;
  const metaAPI = SNAP?.typeMeta?.[typeCode];
  if (metaAPI && metaAPI.color) return normalizeHexColor(metaAPI.color) || null;
  if (typeCode === 'cc' || typeCode === 'bill') return '#a02d2a';
  return '#4c8036';
}

/* Populate and display Edit Type Color modal */
function showEditTypeModal(typeCode, labelText) {
  if (IS_LOADING) return;
  const backdrop = document.getElementById('edit-type-modal-backdrop');
  const modal = document.getElementById('edit-type-modal');
  const nameEl = document.getElementById('edit-type-name');
  const picker = document.getElementById('edit-type-color-picker');
  const input = document.getElementById('edit-type-color');
  const saveBtn = document.getElementById('edit-type-save');

  nameEl.textContent = `${labelText} (${typeCode})`;
  const current = getTypeEffectiveColor(typeCode) || '#4c8036';
  const norm = normalizeHexColor(current) || '#4c8036';
  picker.value = norm;
  input.value = norm;

  picker.oninput = () => { input.value = picker.value; };
  input.oninput = () => { const norm = normalizeHexColor(input.value); if (norm) picker.value = norm; };

  backdrop.classList.add('show');
  modal.classList.add('show');
  saveBtn.onclick = () => processEditType(typeCode);
}

/* Hide Edit Type modal */
function hideEditTypeModal() {
  document.getElementById('edit-type-modal-backdrop').classList.remove('show');
  document.getElementById('edit-type-modal').classList.remove('show');
}

/* Store per-type color override and re-render type summary */
function processEditType(typeCode) {
  const input = document.getElementById('edit-type-color');
  const color = normalizeHexColor(input.value);
  if (!color) {
    showToast('Please enter a valid 6-digit hex color (e.g. #4C8036).', 'error', 4000);
    return;
  }
  TYPE_META_OVERRIDES.set(typeCode, { color });
  saveStateToURL();
  hideEditTypeModal();
  showToast('Type color updated!', 'success', 2000);
  renderAll();
}

/* ============================================
    DATA FETCHING
    - snapshot route: accounts, series, typeMeta, accountMeta, score.
   ============================================ */
async function fetchSnapshot() {
  if (IS_LOADING) return;
  setLoading(true, 'Loading snapshot‚Ä¶');

  try {
    const res = await fetch(`${API_BASE}?route=snapshot&ts=${Date.now()}&timeframe=${TIMEFRAME}`);
    const text = await res.text();
    let j;
    try { j = JSON.parse(text); } catch {
      console.error('Non-JSON response:', text);
      showToast('Error: API returned non-JSON. Check console.', 'error', 5000);
      setLoading(false);
      return;
    }
    if (!j.ok) {
      console.error('Snapshot error:', j);
      showToast('Error: ' + (j.error || 'snapshot failed'), 'error', 5000);
      setLoading(false);
      return;
    }

    SNAP = j;
    
    // Update score from database snapshot (if present)
    if (SNAP.score !== undefined) {
      SCORE = Number(SNAP.score);
    }

    // Load AccountMeta (limits/colors/links) into ACCOUNT_METADATA
    ACCOUNT_METADATA = new Map();
    if (SNAP.accountMeta) {
      Object.entries(SNAP.accountMeta).forEach(([accountName, meta]) => {
        if (!accountName) return;
        let limit = null;
        if (typeof meta.limit === 'number') {
          limit = meta.limit;
        } else if (typeof meta.limit === 'string' && meta.limit.trim() !== '') {
          const parsed = Number(meta.limit.replace(/,/g, ''));
          if (!isNaN(parsed)) limit = parsed;
        }
        ACCOUNT_METADATA.set(accountName, {
          limit: Number.isFinite(limit) ? limit : null,
          color: meta.color || null,
          link: meta.link || null
        });
      });
    }

    console.log('Snapshot loaded:', SNAP);
    setLoading(false);
    renderAll();
  } catch (err) {
    console.error('Fetch failed:', err);
    setLoading(false);
    showToast('Fetch failed (see console)', 'error', 5000);
  }
}

/* ============================================
    URL STATE (muted + types + dark mode + font + typeMeta)
    - Uses window.location.hash to persist UI state.
   ============================================ */
function loadStateFromURL() {
  const hash = window.location.hash.substring(1);
  const params = new URLSearchParams(hash);

  const mutedParam = params.get('muted');
  if (mutedParam) MUTED_ACCOUNTS = new Set(mutedParam.split(',').filter(a => a));

  const mutedTypesParam = params.get('mutedTypes');
  if (mutedTypesParam) MUTED_TYPES = new Set(mutedTypesParam.split(',').filter(t => t));

  // Dark mode & font handled in initializeTheme()

  const typeMetaParam = params.get('typeMeta');

  TYPE_META_OVERRIDES = new Map();
  if (typeMetaParam) {
    try {
      const typeObj = JSON.parse(decodeURIComponent(typeMetaParam));
      Object.entries(typeObj).forEach(([code, meta]) => {
        if (meta && meta.color) {
          const norm = normalizeHexColor(meta.color);
          if (norm) TYPE_META_OVERRIDES.set(code, { color: norm });
        }
      });
    } catch (e) { console.error('Failed to parse typeMeta from URL:', e); }
  }
}

/* Write state back to URL hash (so it‚Äôs shareable/bookmarkable) */
function saveStateToURL() {
  const params = new URLSearchParams();

  const mutedArray = Array.from(MUTED_ACCOUNTS);
  if (mutedArray.length > 0) params.set('muted', mutedArray.join(','));

  const mutedTypesArray = Array.from(MUTED_TYPES);
  if (mutedTypesArray.length > 0) params.set('mutedTypes', mutedTypesArray.join(','));

  if (DARK_MODE) params.set('darkMode', 'true');
  
  // Save Font Preference
  if (CURRENT_FONT_INDEX > 0) {
    params.set('font', CURRENT_FONT_INDEX);
  }

  const typeMetaObj = {};
  TYPE_META_OVERRIDES.forEach((meta, typeCode) => {
    if (meta.color) typeMetaObj[typeCode] = { color: meta.color };
  });
  if (Object.keys(typeMetaObj).length > 0) params.set('typeMeta', encodeURIComponent(JSON.stringify(typeMetaObj)));

  window.location.hash = params.toString();
}

/* Per-account mute toggling */
function toggleAccountMute(accountName) {
  if (MUTED_ACCOUNTS.has(accountName)) MUTED_ACCOUNTS.delete(accountName);
  else MUTED_ACCOUNTS.add(accountName);
  saveStateToURL();
  renderAll();
}

/* Utility: is a given account in the muted set? */
function isAccountMuted(accountName) { return MUTED_ACCOUNTS.has(accountName); }

/* Per-type ‚Äúmute‚Äù toggle (hides all accounts of that type) */
function toggleTypeMute(typeCode) {
  if (MUTED_TYPES.has(typeCode)) MUTED_TYPES.delete(typeCode);
  else MUTED_TYPES.add(typeCode);
  saveStateToURL();
  renderAll();
}

/* Utility: is a given type in the muted set? */
function isTypeMuted(typeCode) { return MUTED_TYPES.has(typeCode); }

/* Derived: account is globally hidden if either the specific account
   or its type is muted.
*/
function isAccountGloballyHidden(account) {
  if (isAccountMuted(account.name)) return true;
  const t = account.type || 'bk';
  return isTypeMuted(t);
}

/* ============================================
    RENDERING
    - high-level "renderAll" orchestrates the UI updates.
   ============================================ */
function renderAll() {
  renderSummary();
  renderInterestSummary();
  renderStatusbar();
  renderCCMetrics();
  renderChart();
  renderTypeSummary();
  renderAccounts();
  renderScore();
}

/* Compute and display CC LIMIT / CC DEBT from snapshot + meta */
function renderCCMetrics() {
  const limitEl = document.getElementById('cc-limit-value');
  const debtEl = document.getElementById('cc-debt-value');

  if (!limitEl || !debtEl || !SNAP || !SNAP.accounts || !SNAP.series) return;

  let totalLimit = 0;           // sum of all CC limits
  let totalDebtMagnitude = 0;   // sum of CC debt as positive numbers
  let totalDebtRaw = 0;         // sum of CC balances as stored (e.g., -500, -500 => -1000)

  SNAP.accounts.forEach(a => {
    if (a.type !== 'cc') return;

    const series = SNAP.series[a.name] || {};
    const last = Number(series.last ?? 0);

    // limits from ACCOUNT_METADATA (Edit Account modal / AccountMeta sheet)
    const meta = ACCOUNT_METADATA.get(a.name) || {};
    if (typeof meta.limit === 'number' && !isNaN(meta.limit)) {
      totalLimit += meta.limit;
    }

    if (!isNaN(last)) {
      // raw sum of CC values (can be negative) ‚Üí CC DEBT
      totalDebtRaw += last;

      // magnitude of debt (only when negative) ‚Üí used to subtract from limits
      if (last < 0) {
        totalDebtMagnitude += Math.abs(last);
      }
    }
  });

  // CC LIMIT = sum of limits minus ‚Äúmagnitude of CC debt‚Äù
  const availableCredit = totalLimit - totalDebtMagnitude;

  // Display:
  //   CC LIMIT ‚Üí availableCredit (can go negative if over total limit)
  //   CC DEBT  ‚Üí raw combined CC value, e.g. -1000
  limitEl.textContent = formatMoney(availableCredit);
  debtEl.textContent = formatMoney(totalDebtRaw);
}

/* Render the big ‚Äúassets | debts‚Äù summary at top-left */
function renderSummary() {
  const summaryEl = document.getElementById('financial-summary');
  if (!summaryEl || !SNAP || !SNAP.accounts) return;

  if (!SNAP.dateAxis || SNAP.dateAxis.length === 0) {
    summaryEl.innerHTML = 'No Data';
    return;
  }

  let assets = 0, debts = 0;
  SNAP.accounts.forEach(a => {
    if (isAccountGloballyHidden(a)) return;
    const s = SNAP.series[a.name] || {};
    const last = s?.last ?? 0;
    if (last >= 0) assets += last;
    else debts += Math.abs(last);
  });

  const assetClass = assets > debts ? 'bold-value' : '';
  const debtClass = debts > assets ? 'bold-value' : '';
  const assetString = `<span class="summary-asset ${assetClass}">${formatMoney(assets)}</span>`;
  const debtString = `<span class="summary-debt ${debtClass}">${formatMoney(debts)}</span>`;
  summaryEl.innerHTML = `${assetString} <span style="font-weight: 300;">|</span> ${debtString}`;
}

/* Render interest summary (earnings/costs) based on APR √ó timeframe */
function renderInterestSummary() {
  const summaryEl = document.getElementById('interest-summary');
  if (!summaryEl || !SNAP || !SNAP.accounts) return;
  let totalEarnings = 0, totalCosts = 0, periodLabel = '';

  SNAP.accounts.forEach(a => {
    if (isAccountGloballyHidden(a)) return;
    const s = SNAP.series[a.name] || {};
    const last = s?.last ?? 0;
    const apr = a.apr || 0;
    if (apr === 0 || last === 0) return;
    const dailyRate = (last * apr) / 365;
    let interestAmount = 0;

    /* Map timeframe selection to daily multipliers */
    switch (TIMEFRAME) {
      case 'today': interestAmount = dailyRate * 1; periodLabel = '/dy'; break;
      case '7d': interestAmount = dailyRate * 7; periodLabel = '/wk'; break;
      case '14d': interestAmount = dailyRate * 14; periodLabel = '/2w'; break;
      case '30d': interestAmount = dailyRate * 30; periodLabel = '/mo'; break;
      case '90d': interestAmount = dailyRate * 90; periodLabel = '/qt'; break;
      case '1y': case 'ytd': case 'all': interestAmount = last * apr; periodLabel = '/yr'; break;
    }

    if (interestAmount > 0) totalEarnings += interestAmount;
    else totalCosts += interestAmount;
  });

  if (Math.abs(totalEarnings) < 0.01 && Math.abs(totalCosts) < 0.01) {
    summaryEl.innerHTML = '';
    return;
  }

  const earningsStr = totalEarnings >= 0.01 ? `<span class="interest-earned">+${formatMoney(totalEarnings)}${periodLabel}</span>` : '';
  const costsStr = Math.abs(totalCosts) >= 0.01 ? `<span class="interest-cost">${formatMoney(totalCosts)}${periodLabel}</span>` : '';
  const displayParts = [];
  if (earningsStr) displayParts.push(earningsStr);
  if (costsStr) displayParts.push(costsStr);

  if (displayParts.length > 0) summaryEl.innerHTML = `Interest: ${displayParts.join(' <span style="font-weight: 300;">|</span> ')}`;
  else summaryEl.innerHTML = '';
}

/* Render type summary row (toolbar), including totals by type and mute checkboxes */
function renderTypeSummary() {
  const container = document.getElementById('typeFilterRow');
  if (!container || !SNAP || !SNAP.accounts) return;
  container.hidden = false;
  container.innerHTML = '';

  const typeTotals = {};
  const typeMeta = SNAP.typeMeta || {};
  Object.keys(typeMeta).forEach(code => { typeTotals[code] = 0; });

  /* Aggregate last values by type, excluding muted accounts but not type mutes yet */
  SNAP.accounts.forEach(a => {
    const s = SNAP.series[a.name] || {};
    const last = s?.last ?? 0;
    const typeCode = a.type || 'bk';
    if (typeTotals[typeCode] == null) typeTotals[typeCode] = 0;
    if (isAccountMuted(a.name)) return;
    typeTotals[typeCode] += last;
  });

  const metaKeys = Object.keys(typeTotals);
  const preferredOrder = ['bk', 'cc', 'bill', 'ii', 'sv'];
  const orderedCodes = [];
  preferredOrder.forEach(code => { if (metaKeys.includes(code)) orderedCodes.push(code); });
  metaKeys.forEach(code => { if (!orderedCodes.includes(code)) orderedCodes.push(code); });

  orderedCodes.forEach(typeKey => {
    const total = typeTotals[typeKey] || 0;
    const meta = typeMeta[typeKey] || {};
    const labelBase = TYPE_LABELS[typeKey] || meta.label || typeKey;
    const label = labelBase.toUpperCase();
    const colorClass = total >= 0 ? 'positive' : 'negative';
    const signPrefix = total > 0 ? '+' : '';
    const typeColor = getTypeEffectiveColor(typeKey);

    const typeItem = document.createElement('div');
    typeItem.className = 'type-item';
    if (isTypeMuted(typeKey)) typeItem.classList.add('muted');

    const valueEl = document.createElement('div');
    valueEl.className = 'type-value ' + colorClass;
    valueEl.textContent = `${signPrefix}${formatMoney(total)}`;
    typeItem.appendChild(valueEl);

    const labelEl = document.createElement('div');
    labelEl.className = 'type-label';
    labelEl.textContent = label;
    labelEl.style.color = typeColor;
    labelEl.title = 'Double-click to change this Type color';
    labelEl.addEventListener('dblclick', () => showEditTypeModal(typeKey, label));
    typeItem.appendChild(labelEl);

    const toggleLabel = document.createElement('label');
    toggleLabel.className = 'type-toggle-label';
    const cb = document.createElement('input');
    cb.type = 'checkbox';
    cb.dataset.typeCode = typeKey;
    cb.checked = !isTypeMuted(typeKey);
    cb.addEventListener('change', () => toggleTypeMute(typeKey));
    toggleLabel.appendChild(cb);
    typeItem.appendChild(toggleLabel);
    container.appendChild(typeItem);
  });
}

/* Render top ratio bar (asset vs debt) under the chart */
function renderStatusbar() {
  const ratioAsset = document.getElementById('ratio-asset');
  const ratioDebt = document.getElementById('ratio-debt');

  if (!SNAP || !SNAP.totals || !SNAP.dateAxis) return;
  if (SNAP.dateAxis.length === 0) return;

  let assets = 0, debts = 0;
  SNAP.accounts.forEach(a => {
    if (isAccountGloballyHidden(a)) return;
    const s = SNAP.series[a.name] || {};
    const last = s?.last ?? 0;
    if (last >= 0) assets += last;
    else debts += Math.abs(last);
  });

  const total = assets + debts;
  if (total === 0) { 
    if(ratioAsset) ratioAsset.style.width = '100%';
    if(ratioDebt) ratioDebt.style.width = '0%';
    return; 
  }

  if (ratioAsset && ratioDebt) {
    const assetPct = (assets / total) * 100;
    const debtPct = (debts / total) * 100;
    ratioAsset.style.width = `${assetPct}%`;
    ratioDebt.style.width = `${debtPct}%`;
  }
}

/* ============================================
    CHART RENDERING (MULTI-SLIDE)
    - Slide 0: stacked bar chart
    - Slide 1: multi-line chart
    - Slide 2: donut charts
   ============================================ */
function renderChart() {
  if (!SNAP || !window.google || !google.visualization) return;
  const chartContainer = document.getElementById('chart');
  if (!chartContainer) return;

  const labels = SNAP.dateAxis;
  if (!labels || labels.length === 0) {
    chartContainer.innerHTML = '<div style="text-align:center; padding-top: 20px; color: var(--c-fg);">No data for this timeframe.</div>';
    renderChartPager();
    return;
  }

  chartContainer.innerHTML = '';
  switch (CHART_SLIDE) {
    case 0: renderBarChart(chartContainer, labels); break;
    case 1: renderLineChartAllAccounts(chartContainer, labels); break;
    case 2: renderDonutCharts(chartContainer); break;
  }
  renderChartPager();

  // Add simple left/right swipe gestures on mobile
  let touchStartX = null;
  const SWIPE_THRESHOLD = 40;
  chartContainer.addEventListener('touchstart', (e) => {
    if (e.touches.length === 1) touchStartX = e.touches[0].clientX;
  });
  chartContainer.addEventListener('touchend', (e) => {
    if (touchStartX == null) return;
    const endX = e.changedTouches[0].clientX;
    const diff = endX - touchStartX;
    touchStartX = null;
    if (Math.abs(diff) > SWIPE_THRESHOLD) {
      if (diff < 0 && CHART_SLIDE < MAX_CHART_SLIDE) setChartSlide(CHART_SLIDE + 1);
      else if (diff > 0 && CHART_SLIDE > 0) setChartSlide(CHART_SLIDE - 1);
    }
  });
}

/* Slide 1: stacked bar chart (Totals/Types/Per-account) */
function renderBarChart(container, labels) {
  const styles = getComputedStyle(document.documentElement);
  const pos = styles.getPropertyValue('--c-pos').trim();
  const neg = styles.getPropertyValue('--c-neg').trim();
  const fg = styles.getPropertyValue('--c-fg').trim();
  const textStyle = { color: fg, fontName: 'system-ui' };

  const data = new google.visualization.DataTable();
  data.addColumn('string', 'Date');
  let rows = [];

  if (MODE === 'totals') {
    data.addColumn('number', 'Assets');
    data.addColumn('number', 'Debts');
    for (let i = 0; i < labels.length; i++) {
      let assets = 0, debts = 0;
      SNAP.accounts.forEach(a => {
        if (isAccountGloballyHidden(a)) return;
        const v = SNAP.series[a.name]?.monthly?.[i] ?? 0;
        if (v >= 0) assets += v; else debts += v;
      });
      rows.push([labels[i], assets, debts]);
    }
  } else if (MODE === 'types') {
    const typeSeries = SNAP.typeSeries || {};
    const typeMeta = SNAP.typeMeta || {};
    const seriesKeys = Object.keys(typeSeries);
    const preferredOrder = ['bk', 'cc', 'bill', 'ii', 'sv'];
    const orderedCodes = [];
    preferredOrder.forEach(code => { if (seriesKeys.includes(code)) orderedCodes.push(code); });
    seriesKeys.forEach(code => { if (!orderedCodes.includes(code)) orderedCodes.push(code); });

    const visibleTypes = orderedCodes.filter(code => !isTypeMuted(code));
    visibleTypes.forEach(code => {
      const baseLabel = TYPE_LABELS[code] || typeMeta[code]?.label || code;
      data.addColumn('number', baseLabel);
    });
    for (let i = 0; i < labels.length; i++) {
      const row = [labels[i]];
      visibleTypes.forEach(code => {
        const seriesArr = typeSeries[code] || [];
        const v = Number(seriesArr[i] ?? 0);
        row.push(v);
      });
      rows.push(row);
    }
  } else {
    const visibleAccounts = SNAP.accounts.filter(a => !isAccountGloballyHidden(a));
    visibleAccounts.forEach(a => data.addColumn('number', a.name));
    for (let i = 0; i < labels.length; i++) {
      const row = [labels[i]];
      visibleAccounts.forEach(a => {
        const v = SNAP.series[a.name]?.monthly?.[i] ?? 0;
        row.push(Number(v));
      });
      rows.push(row);
    }
  }
  data.addRows(rows);

  let minV = 0, maxV = 0;
  for (const r of rows) {
    for (let i = 1; i < r.length; i++) {
      const v = Number(r[i]) || 0;
      if (v < minV) minV = v;
      if (v > maxV) maxV = v;
    }
  }
  const maxAbs = Math.max(Math.abs(minV), Math.abs(maxV), 100);

  let chartColors;
  if (MODE === 'totals') {
    chartColors = [pos, neg];
  } else if (MODE === 'types') {
    const typeSeries = SNAP.typeSeries || {};
    const seriesKeys = Object.keys(typeSeries);
    const preferredOrder = ['bk', 'cc', 'bill', 'ii', 'sv'];
    const orderedCodes = [];
    preferredOrder.forEach(code => { if (seriesKeys.includes(code)) orderedCodes.push(code); });
    seriesKeys.forEach(code => { if (!orderedCodes.includes(code)) orderedCodes.push(code); });
    const visibleTypes = orderedCodes.filter(code => !isTypeMuted(code));
    chartColors = visibleTypes.map(code => getTypeEffectiveColor(code));
  } else {
    const visibleAccounts = SNAP.accounts.filter(a => !isAccountGloballyHidden(a));
    chartColors = visibleAccounts.map(a => {
      const meta = ACCOUNT_METADATA.get(a.name) || {};
      const baseColor = meta.color || a.color;
      if (baseColor) return normalizeHexColor(baseColor) || (a.kind === 'debt' ? neg : pos);
      return a.kind === 'debt' ? neg : pos;
    });
  }

  const options = {
    height: Math.max(240, Math.round(window.innerHeight * 0.30)),
    backgroundColor: { fill: 'transparent' },
    chartArea: { width: '90%', height: '70%' },
    legend: { position: 'top', alignment: 'center', textStyle: textStyle },
    hAxis: { slantedText: false, textStyle: textStyle, showTextEvery: labels.length > 30 ? Math.ceil(labels.length / 15) : 1 },
    vAxis: { viewWindow: { min: -maxAbs * 1.05, max: maxAbs * 1.05 }, baseline: 0, baselineColor: fg, gridlines: { color: fg, opacity: 0.1 }, textStyle: textStyle },
    isStacked: true,
    colors: chartColors,
    animation: { duration: 500, easing: 'out' }
  };
  const chart = new google.visualization.ColumnChart(container);
  chart.draw(data, options);
}

/* Slide 2: multi-line chart of all visible accounts */
function renderLineChartAllAccounts(container, labels) {
  const data = new google.visualization.DataTable();
  data.addColumn('string', 'Date');
  const visibleAccounts = SNAP.accounts.filter(a => !isAccountGloballyHidden(a));
  visibleAccounts.forEach(a => data.addColumn('number', a.name));
  const rows = [];
  for (let i = 0; i < labels.length; i++) {
    const row = [labels[i]];
    visibleAccounts.forEach(a => {
      const v = SNAP.series[a.name]?.monthly?.[i] ?? 0;
      row.push(Number(v));
    });
    rows.push(row);
  }
  data.addRows(rows);
  const styles = getComputedStyle(document.documentElement);
  const pos = styles.getPropertyValue('--c-pos').trim();
  const neg = styles.getPropertyValue('--c-neg').trim();
  const fg = styles.getPropertyValue('--c-fg').trim();
  const textStyle = { color: fg, fontName: 'system-ui' };
  const chartColors = visibleAccounts.map(a => {
    const meta = ACCOUNT_METADATA.get(a.name) || {};
    const baseColor = meta.color || a.color;
    if (baseColor) return normalizeHexColor(baseColor) || (a.kind === 'debt' ? neg : pos);
    return a.kind === 'debt' ? neg : pos;
  });
  const options = {
    height: Math.max(260, Math.round(window.innerHeight * 0.30)),
    backgroundColor: { fill: 'transparent' },
    chartArea: { width: '88%', height: '70%' },
    legend: { position: 'top', alignment: 'center', textStyle },
    hAxis: { textStyle, showTextEvery: labels.length > 30 ? Math.ceil(labels.length / 15) : 1 },
    vAxis: { baselineColor: fg, gridlines: { color: fg, opacity: 0.1 }, textStyle },
    colors: chartColors,
    curveType: 'function', lineWidth: 8, pointSize: 0, animation: { duration: 500, easing: 'out' }
  };
  const chart = new google.visualization.LineChart(container);
  chart.draw(data, options);
}

/* Slide 3: donut charts (by type, all accounts, debt-only) */
function renderDonutCharts(container) {
  const styles = getComputedStyle(document.documentElement);
  const fg = styles.getPropertyValue('--c-fg').trim();
  container.innerHTML = '';
  
  const wrap = document.createElement('div');
  wrap.style.cssText = 'display:flex; flex-wrap:wrap; justify-content:center; align-items:center; gap:12px; width:100%;';
  
  const typeDiv = document.createElement('div');
  const allDiv = document.createElement('div');
  const debtDiv = document.createElement('div');
  
  const commonStyle = 'flex: 1 1 260px; min-width: 260px; max-width: 400px; height: 260px;';
  typeDiv.style.cssText = commonStyle;
  allDiv.style.cssText = commonStyle;
  debtDiv.style.cssText = commonStyle;
  
  wrap.appendChild(typeDiv);
  wrap.appendChild(allDiv);
  wrap.appendChild(debtDiv);
  
  container.appendChild(wrap);

  /* Donut 1: By Type (absolute values) */
  const typeData = new google.visualization.DataTable();
  typeData.addColumn('string', 'Type'); typeData.addColumn('number', 'Value');
  const typeTotals = {};
  SNAP.accounts.forEach(a => { if (isAccountGloballyHidden(a)) return; const last = SNAP.series[a.name]?.last ?? 0; const t = a.type || 'bk'; if (!typeTotals[t]) typeTotals[t]=0; typeTotals[t]+=last; });
  Object.entries(typeTotals).forEach(([code, total]) => { if (total !== 0) typeData.addRow([TYPE_LABELS[code] || code, Math.abs(total)]); });
  new google.visualization.PieChart(typeDiv).draw(typeData, { title: 'By Type', titleTextStyle: { color: fg, fontName: 'system-ui', fontSize: 12 }, backgroundColor: 'transparent', legend: { position: 'right', textStyle: { color: fg, fontName: 'system-ui', fontSize: 10 } }, pieHole: 0.6, chartArea: { width: '80%', height: '80%' } });

  /* Donut 2: All accounts (absolute values) */
  const allData = new google.visualization.DataTable();
  allData.addColumn('string', 'Account'); allData.addColumn('number', 'Value');
  SNAP.accounts.forEach(a => { if (isAccountGloballyHidden(a)) return; const last = SNAP.series[a.name]?.last ?? 0; if (last !== 0) allData.addRow([a.name, Math.abs(last)]); });
  new google.visualization.PieChart(allDiv).draw(allData, { title: 'All Accounts', titleTextStyle: { color: fg, fontName: 'system-ui', fontSize: 12 }, backgroundColor: 'transparent', legend: { position: 'right', textStyle: { color: fg, fontName: 'system-ui', fontSize: 10 } }, pieHole: 0.6, chartArea: { width: '80%', height: '80%' } });

  /* Donut 3: Debt-only accounts (absolute value of negative balances) */
  const debtData = new google.visualization.DataTable();
  debtData.addColumn('string', 'Account'); debtData.addColumn('number', 'Value');
  SNAP.accounts.forEach(a => { if (isAccountGloballyHidden(a)) return; const last = SNAP.series[a.name]?.last ?? 0; if (last < 0) debtData.addRow([a.name, Math.abs(last)]); });
  new google.visualization.PieChart(debtDiv).draw(debtData, { title: 'Debt Accounts', titleTextStyle: { color: fg, fontName: 'system-ui', fontSize: 12 }, backgroundColor: 'transparent', legend: { position: 'right', textStyle: { color: fg, fontName: 'system-ui', fontSize: 10 } }, pieHole: 0.6, chartArea: { width: '80%', height: '80%' } });
}

/* Set active chart slide and re-render */
function setChartSlide(index) {
  if (index < 0) index = 0; if (index > MAX_CHART_SLIDE) index = MAX_CHART_SLIDE;
  if (index === CHART_SLIDE) return;
  CHART_SLIDE = index;
  renderChart();
}

/* Simple dot pager under chart to choose slide 0/1/2 */
function renderChartPager() {
  const pager = document.getElementById('chart-pager');
  if (!pager) return;
  pager.innerHTML = '';
  const wrap = document.createElement('div');
  wrap.style.cssText = 'display:flex; justify-content:center; align-items:center; gap:8px; padding:6px 0';
  for (let i = 0; i <= MAX_CHART_SLIDE; i++) {
    const dot = document.createElement('button');
    dot.type = 'button';
    dot.style.cssText = `width:8px; height:8px; border-radius:50%; border:1px solid var(--c-fg); background:${i === CHART_SLIDE ? 'var(--c-fg)' : 'transparent'}; padding:0; cursor:pointer; opacity:${i === CHART_SLIDE ? '1' : '0.5'}`;
    dot.onclick = => setChartSlide(i);
    wrap.appendChild(dot);
  }
  pager.appendChild(wrap);
}

/* Helper: sign label for positive or negative values */
const signOf = (n) => (Number(n) < 0 ? 'neg' : 'pos');

/* Compact money formatter: integer-only, custom minus sign */
function formatMoney(n) {
  const val = Number(n) || 0;
  const sign = val < 0 ? '‚àí' : '';
  const abs = Math.abs(val);
  const displayValue = Math.trunc(abs);
  return `${sign}${displayValue.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}`;
}

/* Compute utilization-based color for CC limit label */
function getLimitColor(currentBalance, limit) {
  const absBalance = Math.abs(currentBalance);
  const utilization = absBalance / limit;
  if (currentBalance >= 0) return '#4c8036';
  if (utilization > 1.0) return '#d85140';
  const startColor = { r: 76, g: 128, b: 54 };
  const endColor = { r: 160, g: 45, b: 42 };
  const r = Math.round(startColor.r + (endColor.r - startColor.r) * utilization);
  const g = Math.round(startColor.g + (endColor.g - startColor.g) * utilization);
  const b = Math.round(startColor.b + (endColor.b - startColor.b) * utilization);
  return `rgb(${r}, ${g}, ${b})`;
}

/* Render all account rows (name, value, meta, input, mute, chips, ratio bar) */
function renderAccounts() {
  const root = document.getElementById('accounts');
  root.innerHTML = '';
  if (!SNAP || !SNAP.accounts) return;

  SNAP.accounts.forEach(a => {
    const s = SNAP.series[a.name] || {};
    const last = s?.last ?? 0;
    const row = document.createElement('div'); row.className = 'row';
    const left = document.createElement('div'); left.className = 'left';
    const right = document.createElement('div'); right.className = 'right';
    const accountDetails = document.createElement('div'); accountDetails.className = 'account-details';

    /* Identity block: last value + name (with optional long-press actions) */
    const identityWrap = document.createElement('div');
    identityWrap.style.cssText = 'display:flex; align-items:baseline; gap:10px; flex-wrap:nowrap; min-width:0';

    const lastEl = document.createElement('span');
    lastEl.className = 'lastval';
    lastEl.textContent = formatMoney(last);
    lastEl.dataset.sign = signOf(last);

    const nameEl = document.createElement('span');
    nameEl.className = 'name';
    nameEl.textContent = a.name;

    // Apply account color / link behavior as before
    const meta = ACCOUNT_METADATA.get(a.name) || {};
    const effectiveColor = meta.color || a.color;
    if (effectiveColor) {
      const norm = normalizeHexColor(effectiveColor);
      if (norm) nameEl.style.color = norm;
    }
    if (meta.link) {
      nameEl.style.textDecoration = 'underline';
      nameEl.style.textDecorationStyle = 'dotted';
      nameEl.title = 'Open account link';
      nameEl.onclick = () => {
        if (LONG_PRESS_TIMER) clearTimeout(LONG_PRESS_TIMER);
        window.open(meta.link, '_blank', 'noopener');
      };
    }

    // Long-press menu logic: open account menu on hold
    let pressStartTime = 0;
    const startLongPress = () => {
      pressStartTime = Date.now();
      LONG_PRESS_TIMER = setTimeout(() => showAccountMenu(a.name), LONG_PRESS_DURATION);
    };
    const clearLongPress = () => {
      if (LONG_PRESS_TIMER) {
        clearTimeout(LONG_PRESS_TIMER);
        LONG_PRESS_TIMER = null;
      }
    };
    nameEl.onmousedown = nameEl.ontouchstart = startLongPress;
    nameEl.onmouseup = nameEl.onmouseleave = nameEl.ontouchend = clearLongPress;

    identityWrap.append(lastEl, nameEl);
    accountDetails.append(identityWrap);

    // NEW: meta column that stacks LIMIT + APR to the right of the name
    const metaWrap = document.createElement('div');
    metaWrap.className = 'account-meta';

    // LIMIT (only for CC with a limit)
    if (a.type === 'cc' && meta.limit) {
      const limitEl = document.createElement('span');
      limitEl.className = 'limit';
      const limitValue = meta.limit;
      limitEl.style.color = getLimitColor(last, limitValue);
      limitEl.textContent = `$${limitValue.toLocaleString()}`;
      metaWrap.appendChild(limitEl);
    }

    // APR + interest line, always available
    const aprEl = document.createElement('span');
    aprEl.className = 'apr';
    const apr = a.apr || 0;
    let interestAmount = 0;
    let periodLabel = '';

    if (apr > 0 && last !== 0) {
      const dailyRate = (last * apr) / 365;
      switch (TIMEFRAME) {
        case 'today': interestAmount = dailyRate * 1; periodLabel = '/dy'; break;
        case '7d':    interestAmount = dailyRate * 7; periodLabel = '/wk'; break;
        case '14d':   interestAmount = dailyRate * 14; periodLabel = '/2w'; break;
        case '30d':   interestAmount = dailyRate * 30; periodLabel = '/mo'; break;
        case '90d':   interestAmount = dailyRate * 90; periodLabel = '/qt'; break;
        case '1y':
        case 'ytd':
        case 'all':   interestAmount = last * apr; periodLabel = '/yr'; break;
      }
    }

    let aprHTML = `APR: ${(apr * 100).toFixed(2)}%`;
    if (Math.abs(interestAmount) >= 0.01) {
      const sign = interestAmount >= 0 ? '+' : '';
      const color = interestAmount >= 0 ? 'var(--c-pos)' : 'var(--c-neg)';
      aprHTML += `<br><span style="color: ${color}">${sign}${formatMoney(interestAmount)}${periodLabel}</span>`;
    }
    aprEl.innerHTML = aprHTML;
    metaWrap.appendChild(aprEl);

    // Append the stacked meta block to the right of name
    accountDetails.appendChild(metaWrap);

    /* Input line: numeric field + mute slider */
    const inputLine = document.createElement('div'); inputLine.className = 'input-line';
    const inp = document.createElement('input'); inp.type = 'number'; inp.placeholder = 'Add value‚Ä¶'; inp.step = '0.01'; inp.dataset.accountName = a.name;
    if (last > 0) inp.style.backgroundColor = 'var(--c-tint-pos)';
    else if (last < 0) inp.style.backgroundColor = 'var(--c-tint-neg)';
    else inp.style.backgroundColor = 'var(--c-input-bg)';

    /* Submit single entry on Enter key */
    inp.onkeydown = async (ev) => { if (ev.key === 'Enter') await submitEntries([{ account: a.name, value: inp.value, inputEl: inp }]); };

    const muteWrapper = document.createElement('label'); muteWrapper.className = 'mute-checkbox';
    const muteCheck = document.createElement('input'); muteCheck.type = 'checkbox'; muteCheck.checked = !isAccountMuted(a.name);
    muteCheck.onchange = () => toggleAccountMute(a.name);
    const muteSlider = document.createElement('span'); muteSlider.className = 'mute-checkbox-slider';
    muteWrapper.append(muteCheck, muteSlider);
    inputLine.append(inp, muteWrapper);
    left.append(accountDetails, inputLine);

    if (isAccountMuted(a.name)) row.classList.add('muted');

    /* Right side: value chips + per-account ratio bar */
    const vals = document.createElement('div');
    vals.className = 'values';

    // newest on the left, oldest on the right
    const lastN = s.lastN || [];
    lastN.slice().reverse().forEach(v => {
      const isObject = (typeof v === 'object' && v !== null && v.value !== undefined);
      const val = Number(isObject ? v.value : v);
      const date = isObject ? v.date : null;
      const readableValue = formatMoney(val);

      const chip = document.createElement('span');
      chip.className = 'chip';
      chip.dataset.sign = signOf(val);
      chip.textContent = readableValue;

      if (date) {
        chip.onclick = () => showEditChipModal(a.name, date, val, readableValue);
      } else {
        chip.classList.add('no-delete');
        chip.title = 'Old data format';
      }

      vals.appendChild(chip);
    });

    right.appendChild(vals);

    /* Per-account little ratio bar made of block characters for mobile */
    const bar = document.createElement('h4'); bar.className = 'ratio-bar';
    const assetSpan = document.createElement('span'); assetSpan.style.color = 'var(--c-pos)';
    const debtSpan = document.createElement('span'); debtSpan.style.color = 'var(--c-neg)';
    const lastIndex = SNAP.dateAxis.length - 1;
    const totalAssets = Number(SNAP.totals.assets?.[lastIndex]) || 0;
    const totalDebts = Math.abs(Number(SNAP.totals.debts?.[lastIndex]) || 0);

    if (last >= 0 && totalAssets > 0) {
      const blocks = Math.round((last / totalAssets) * 10);
      if (blocks >= 1) assetSpan.textContent = '‚ñà '.repeat(blocks);
    } else if (last < 0 && totalDebts > 0) {
      const blocks = Math.round((Math.abs(last) / totalDebts) * 10);
      if (blocks >= 1) debtSpan.textContent = '‚ñà '.repeat(blocks);
    }
    bar.append(assetSpan, debtSpan);
    right.appendChild(bar);

    row.append(left, right);
    root.appendChild(row);
  });
}

/* ============================================
    SUBMISSION
    - SubmitAll collects all non-empty inputs and sends
      them to backend submit route in bulk.
   ============================================ */
async function submitAll() {
  const entries = [];
  document.querySelectorAll('.row .left input[type="number"]').forEach(inp => {
    const v = inp.value.trim();
    if (v !== '') entries.push({ account: inp.dataset.accountName, value: Number(v), inputEl: inp });
  });
  if (entries.length === 0) { showToast('No values entered.', 'info'); return; }
  await submitEntries(entries);
}

/* Lowest-level submit function: handles network, statuses, refresh. */
async function submitEntries(entries) {
  if (IS_LOADING) return;
  setLoading(true, 'Submitting‚Ä¶');
  entries.forEach(e => e.inputEl?.classList.add('submitting'));

  try {
    const validEntries = entries.filter(e => e.account && !isNaN(e.value));
    if (validEntries.length === 0) throw new Error('No valid entries');

    const body = new URLSearchParams({ payload: JSON.stringify({ entries: validEntries }) });
    const res = await fetch(`${API_BASE}?route=submit`, { method: 'POST', body });
    const text = await res.text();
    const j = JSON.parse(text);
    if (!j.ok) throw new Error(j.error || 'Unknown error');

    showToast('Saved!', 'success');
    entries.forEach(e => {
      e.inputEl?.classList.add('submitted-ok');
      e.inputEl.value = '';
      setTimeout(() => e.inputEl?.classList.remove('submitted-ok'), 800);
    });
    await fetchSnapshot();
  } catch (e) {
    console.error(e);
    showToast('Submit failed', 'error');
  } finally {
    setLoading(false);
    entries.forEach(e => e.inputEl?.classList.remove('submitting'));
  }
}

/* ============================================
    INITIALIZATION
    - DOMContentLoaded wires up all event handlers
      and loads Google Charts + initial snapshot.
   ============================================ */
document.addEventListener('DOMContentLoaded', () => {
  loadStateFromURL();
  initializeTheme();
  initDarkMode();

  /* Replace placeholder sheet link with actual sheet ID if configured */
  const sheetLink = document.querySelector('footer a[href*="spreadsheets"]');
  if (sheetLink && SHEET_ID && SHEET_ID !== 'YOUR_SHEET_ID_HERE') {
    sheetLink.href = `https://docs.google.com/spreadsheets/d/${SHEET_ID}`;
  }

  document.getElementById('refresh').addEventListener('click', fetchSnapshot);
  document.getElementById('submitAll').addEventListener('click', submitAll);

  /* Chart mode radios */
  document.querySelectorAll('input[name="mode"]').forEach(r => {
    r.addEventListener('change', (e) => { MODE = e.target.value; renderChart(); });
  });

  /* Timeframe selector triggers new snapshot from backend */
  document.getElementById('timeframe').addEventListener('change', (e) => { TIMEFRAME = e.target.value; fetchSnapshot(); });

  /* Modal cancel/backdrop click handlers */
  document.getElementById('delete-btn-cancel').addEventListener('click', hideDeleteConfirm);
  document.getElementById('delete-modal-backdrop').addEventListener('click', hideDeleteConfirm);
  document.getElementById('edit-chip-cancel').addEventListener('click', hideEditChipModal);
  document.getElementById('edit-chip-modal-backdrop').addEventListener('click', hideEditChipModal);
  document.getElementById('account-menu-cancel').addEventListener('click', hideAccountMenu);
  document.getElementById('account-menu-modal-backdrop').addEventListener('click', hideAccountMenu);
  document.getElementById('edit-account-cancel').addEventListener('click', hideEditAccountModal);
  document.getElementById('edit-account-modal-backdrop').addEventListener('click', hideEditAccountModal);
  document.getElementById('edit-type-cancel').addEventListener('click', hideEditTypeModal);
  document.getElementById('edit-type-modal-backdrop').addEventListener('click', hideEditTypeModal);

  // Font Switcher Event Listeners
  document.getElementById('font-prev').addEventListener('click', () => cycleFont('prev'));
  document.getElementById('font-next').addEventListener('click', () => cycleFont('next'));

  // Recalculate chart sizes on resize
  window.addEventListener('resize', renderChart);
  
  // Initialize score from snapshot (once loaded)
  renderScore();
  document.getElementById('score-display').addEventListener('click', showEditScoreModal);

  // Lazy-load Google Charts and then fetch snapshot
  if (window.google && google.charts) {
    google.charts.load('current', { packages: ['corechart'] });
    google.charts.setOnLoadCallback(fetchSnapshot);
  } else {
    const s = document.createElement('script');
    s.src = 'https://www.gstatic.com/charts/loader.js';
    s.onload = () => { 
      google.charts.load('current', { packages: ['corechart'] });
      google.charts.setOnLoadCallback(fetchSnapshot);
    };
    document.head.appendChild(s);
  }
});
</script>
</body>
</html>
