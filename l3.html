<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Ledger ‚Äî Accounts & Chart (v2.5)</title>

<style>
/* ============================================
      CSS VARIABLES & DESIGN TOKENS
   ============================================ */
:root {
  /* --- DAY MODE (Default) --- */
  --maxw: 1400px;
  
  /* Semantic Colors */
  --c-pos: #4c8036;          /* Bright Green */
  --c-neg: #a02d2a;          /* Bright Red */
  
  /* Base Palette */
  --c-black: #000000;
  --c-white: #ffffff;
  --c-bg: #ffffff;
  --c-fg: #000000;
  --c-border: #000000;
  
  /* Accent/Tint Colors */
  --c-tint-pos: #f7f9f4;     /* Pale Green BG */
  --c-tint-neg: #f9f4f4;     /* Pale Red BG */
  --c-muted: #e8e8e8;        /* Light Grey Mute/Slider BG */
  --c-overlimit: #d85140;    /* Dark Red (CC Overlimit) */
  --c-input-bg: #ffffff;
  
  /* UI Components */
  --c-input-border: #000000;
  --c-header-bg: #ffffff;
  --c-statusbar-bg: #ffffff;
  --c-toast-bg: #000000;
  --c-toast-fg: #ffffff;
  --c-modal-bg: #ffffff;
  --c-modal-border: #000000;
  --c-modal-fg: #000000;
  
  --radius: 10px;
  --gap: 12px;
}

:root.dark-mode {
  /* --- NIGHT MODE (Greyscale with Sobering Tints) --- */
  
  /* Semantic Colors (THE FAINT TINTS) */
  --c-pos: #dbe6d7;          /* Muted White/Green for Positive */
  --c-neg: #f6eaea;          /* Muted White/Red for Negative */
  
  /* Base Palette (Almost Black/White Inversion) */
  --c-black: #ffffff;        /* Base color for primary UI elements (sliders, etc.) */
  --c-white: #1a1a1a;        /* Inverse of c-black */
  --c-bg: #111111;           /* Deep Black Background */
  --c-fg: #e0e0e0;           /* Off-White Foreground Text */
  --c-border: #404040;       /* Dark Grey Border */
  
  /* Accent/Tint Colors (Faint Whisps) */
  --c-tint-pos: #1a1e11;     /* Very dark, faint green tint for input background */
  --c-tint-neg: #201a1a;     /* Very dark, faint red tint for input background */
  --c-muted: #333333;        /* Dark Grey Mute/Slider BG */
  --c-overlimit: #ff7766;    /* Soft Red (CC Overlimit) */
  
  /* UI Components */
  --c-input-bg: #181818;
  --c-input-border: #505050;
  --c-header-bg: #161616;
  --c-statusbar-bg: #161616;
  --c-toast-bg: #333333;
  --c-toast-fg: #e0e0e0;
  --c-modal-bg: #222222;
  --c-modal-border: #505050;
  --c-modal-fg: #e0e0e0;
}

/* ============================================
      BASE LAYOUT
   ============================================ */
html, body { 
  height: 100%; 
  margin: 0; 
  background: var(--c-bg); 
  color: var(--c-fg); 
}

body {
  font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
  font-size: 18px;
  line-height: 1.5;
  transition: background-color 0.3s ease, color 0.3s ease;
}

.wrap { 
  width: 90vw; 
  max-width: var(--maxw); 
  margin: 0 auto; 
  padding: 0px;
}

a {
  color: var(--c-fg); 
  text-decoration: underline;
}

/* ============================================
      HEADER & TOOLBAR
   ============================================ */
header { 
  position: sticky; 
  top: 0; 
  background: var(--c-header-bg); 
  z-index: 5; 
  border-bottom: 1px solid var(--c-border);
  padding-bottom: 1rem;
  transition: background-color 0.3s ease;
}

.toolbar { 
  display: flex; 
  gap: var(--gap); 
  align-items: flex-start;
  justify-content: space-between;
  padding: 6px 24px 10px 24px;
  flex-wrap: nowrap; 
  width: 100%;
  box-sizing: border-box;
}

/* Left side: big numbers */
.financial-group {
  display: flex;
  gap: var(--gap);
  align-items: baseline;
  flex-wrap: wrap;
  min-width: 0;
  flex-shrink: 1;
}

/* Right side: type filters + controls */
.toolbar-right {
  display: flex;
  flex-direction: column;
  align-items: flex-end;
  gap: 6px;
  flex-shrink: 0;
  max-width: 60%;
}

/* Dark mode toggle */
.dark-mode-toggle {
  display: flex;
  align-items: center;
  gap: 8px;
}

.dark-mode-toggle label {
  font-size: 0.75rem;
  font-weight: 300;
  cursor: pointer;
  white-space: nowrap;
}

/* Toggle switch */
.toggle-switch {
  position: relative;
  width: 44px;
  height: 24px;
  flex-shrink: 0;
}

.toggle-switch input[type="checkbox"] {
  position: absolute;
  opacity: 0;
  width: 100%;
  height: 100%;
  cursor: pointer;
  z-index: 2;
  margin: 0;
}

.toggle-switch-slider {
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: var(--c-border);
  border: none;
  border-radius: 999px;
  transition: background 0.3s ease;
  pointer-events: none;
  box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.15);
}

.toggle-switch-slider::before {
  content: '';
  position: absolute;
  height: 18px;
  width: 18px;
  left: 3px;
  bottom: 3px;
  background: var(--c-white);
  border: none;
  border-radius: 50%;
  transition: transform 0.3s ease;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
}

.toggle-switch input[type="checkbox"]:checked + .toggle-switch-slider {
  background: var(--c-pos);
}

.toggle-switch input[type="checkbox"]:checked + .toggle-switch-slider::before {
  transform: translateX(20px);
  background: var(--c-fg); /* White slider dot in dark mode */
}

.toggle-switch input[type="checkbox"]:focus + .toggle-switch-slider {
  outline: 2px solid var(--c-pos);
  outline-offset: 1px;
}

/* Type filter row now lives in the toolbar */
.type-filter-row {
  display: flex;
  flex-wrap: wrap;
  justify-content: flex-end;
  gap: 0.35rem;
}

/* Controls row under type filters */
.toolbar-controls {
  display: flex;
  gap: 0.6rem;
  align-items: center;
  flex-wrap: wrap;
  justify-content: flex-end;
}

/* Make the controls fonts compact */
.toolbar label { 
  font-size: 0.8rem;
  font-weight: 300;
  cursor: pointer;
  color: var(--c-fg);
}

.toolbar select {
  font-size: 0.8rem;
  font-weight: 300;
  padding: 4px 6px;
  border: 1px solid var(--c-input-border);
  border-radius: 4px;
  background: var(--c-input-bg);
  color: var(--c-fg);
  transition: background-color 0.3s ease, border-color 0.3s ease;
}

/* ============================================
      FINANCIAL SUMMARY
   ============================================ */
#financial-summary {
  font-size: 5rem;
  font-weight: 300;
  white-space: nowrap;
  line-height: 1.1;
  flex-shrink: 1;
  min-width: 0;
  color: var(--c-fg);
}

#financial-summary .bold-value {
  font-weight: 700;
}

#interest-summary {
  font-size: 2rem;
  font-weight: 300;
  white-space: nowrap;
  line-height: 1.1;
  flex-shrink: 1;
  min-width: 0;
  opacity: 0.9;
}

.interest-earned {
  color: var(--c-pos);
}

.interest-cost {
  color: var(--c-neg);
}

.summary-debt {
  color: var(--c-neg);
}

.summary-asset {
  color: var(--c-pos);
}

/* ============================================
      CHART CONTAINER
   ============================================ */
#chart { 
  height: 30vh; 
  width: 100%; 
  margin: 0;
  padding: 0;
  background: var(--c-bg); /* Ensure container matches body BG */
}

/* ============================================
      GLOBAL STATUSBAR (‚ñà character)
   ============================================ */
#statusbar {
  line-height: 3;
  font-size: larger;
  text-align: center;
  padding: 0.5rem 12px 0 12px;
  letter-spacing: -0.15em;
  overflow-x: auto;
  overflow-y: hidden;
  white-space: nowrap;
  word-break: keep-all;
  background: var(--c-statusbar-bg);
  width: 100%;
  box-sizing: border-box;
  transition: background-color 0.3s ease;
}

.status-positive {
  color: var(--c-pos);
}

.status-negative {
  color: var(--c-neg);
}

hr.divider {
  border: none;
  border-top: 1px solid var(--c-border);
  margin-top: 1rem;
  transition: border-color 0.3s ease;
}

/* ============================================
      ACCOUNT ROWS
   ============================================ */
.accounts { 
  display: grid; 
  grid-template-columns: 1fr; 
  gap: var(--gap); 
}

.row { 
  display: flex; 
  align-items: flex-start; 
  justify-content: space-between; 
  border-bottom: 1px solid var(--c-border);
  padding: 12px 0; 
  gap: 12px; 
  transition: opacity 0.3s ease;
}
/* ... (rest of account rows CSS unchanged) ... */

/* ============================================
      INPUT FIELDS
   ============================================ */
input[type="number"], input[type="date"], input[type="text"], input[type="url"],
.modal-form-group select {
  width: 10rem;
  max-width: 10rem;
  padding: .7rem .8rem;
  font-size: 1.1rem;
  border: 2px solid var(--c-input-border);
  border-radius: var(--radius);
  background: var(--c-input-bg);
  color: var(--c-fg);
  outline: none;
  transition: background-color 0.3s ease, border-color 0.3s ease;
}

input[type="number"]::placeholder,
input[type="date"]::placeholder,
input[type="text"]::placeholder,
input[type="url"]::placeholder {
  color: var(--c-fg);
  opacity: 0.6;
}
/* ... (rest of input field CSS unchanged) ... */

@keyframes flash-green {
  0% { box-shadow: 0 0 0 2px var(--c-pos) inset; }
  100% { box-shadow: 0 0 0 0px var(--c-pos) inset; }
}

.values [data-sign="pos"], .lastval[data-sign="pos"] { color: var(--c-pos); }
.values [data-sign="neg"], .lastval[data-sign="neg"] { color: var(--c-neg); }

/* ============================================
      BUTTONS
   ============================================ */
button {
  padding: .7rem 1rem;
  font-size: 1rem;
  font-weight: 300;
  border: 2px solid var(--c-input-border);
  color: var(--c-fg);
  background: var(--c-input-bg);
  cursor: pointer;
  border-radius: var(--radius);
  transition: background-color 0.3s ease, border-color 0.3s ease;
}
/* ... (rest of button CSS unchanged) ... */

/* ============================================
      VALUE CHIPS (editable)
   ============================================ */
.chip {
  padding: .25rem .6rem;
  border-radius: 999px;
  border: 1px solid var(--c-input-border);
  font-variant-numeric: tabular-nums;
  font-size: .95rem;
  cursor: pointer;
  user-select: none;
  flex-shrink: 0;
  transition: all 0.2s ease;
  color: var(--c-fg);
  background: var(--c-input-bg);
}

.chip:hover {
  background: var(--c-pos);
  color: var(--c-white);
  transform: scale(1.05);
}
/* ... (rest of chip CSS unchanged) ... */

/* ============================================
      FOOTER
   ============================================ */
.security-notice {
  font-size: 0.7rem;
  background: var(--c-tint-pos);
  padding: 10px 14px;
  border-radius: 8px;
  margin: 16px auto 8px;
  max-width: 900px;
  border-left: 3px solid var(--c-pos);
  text-align: left;
  line-height: 1.5;
  color: var(--c-fg);
  transition: background-color 0.3s ease;
}

.security-notice strong {
  font-weight: 700;
  color: var(--c-pos);
}
/* ... (rest of footer CSS unchanged) ... */

/* ============================================
      MODALS
   ============================================ */
.modal-backdrop {
  background: rgba(0, 0, 0, 0.7);
}

.modal.show {
  /* Fix: Ensure modal backgrounds update */
  background: var(--c-modal-bg);
  color: var(--c-modal-fg);
  border-color: var(--c-modal-border);
}

/* Delete modal */
#delete-btn-confirm {
  background: var(--c-neg);
  color: var(--c-white);
  border-color: var(--c-neg);
}
#delete-btn-confirm:hover {
  background: color-mix(in srgb, var(--c-neg) 80%, black);
  border-color: color-mix(in srgb, var(--c-neg) 80%, black);
  text-decoration: none;
}
/* ... (rest of modal buttons rely on variables) ... */

/* ============================================
      TYPE SUMMARY ITEMS (in toolbar)
   ============================================ */
.type-item {
  display: inline-flex;
  flex-direction: column;
  align-items: center;
  gap: 0.08rem;
  font-size: 0.8rem;
  padding: 0.25rem 0.4rem;
  border-radius: 12px;
  min-width: 96px;
  color: var(--c-fg);
}

.type-item.muted {
  opacity: 0.4;
}

.type-item .type-value {
  font-weight: 600;
  white-space: nowrap;
  font-size: 0.8rem;
}

.type-item .type-value.positive {
  color: var(--c-pos);
}

.type-item .type-value.negative {
  color: var(--c-neg);
}

.type-item .type-label {
  font-weight: 500;
  letter-spacing: 0.06em;
  font-size: 0.7rem;
  cursor: pointer;
}

.type-toggle-label {
  font-size: 0.65rem;
  display: flex;
  align-items: center;
  gap: 0.25rem;
  color: var(--c-fg);
}

.type-toggle-label input[type="checkbox"] {
  margin: 0;
}
/* ... (rest of type summary CSS unchanged) ... */

/* ============================================
      MUTED ACCOUNT STATE
   ============================================ */
.row.muted {
  opacity: 0.5;
}

.row.muted * {
  /* Use FG color for muted text to respect dark/light mode */
  color: var(--c-fg) !important; 
  opacity: 0.3 !important;
  border-color: var(--c-muted) !important;
  background-color: transparent !important;
}

.row.muted .name {
  color: var(--c-fg) !important;
  opacity: 0.6 !important; /* Keep names slightly more visible */
}

/* ... (rest of muted CSS unchanged) ... */

/* ============================================
      MOBILE RESPONSIVE
   ============================================ */
/* ... (mobile CSS unchanged) ... */
</style>
</head>
<body>
<!-- Toast notification -->
<div id="toast" role="status" aria-live="polite"></div>

<!-- Delete confirmation modal -->
<div id="delete-modal-backdrop" class="modal-backdrop"></div>
<div id="delete-modal" class="modal" role="alertdialog" aria-modal="true" aria-labelledby="delete-modal-title">
  <h3 id="delete-modal-title">Delete Entry?</h3>
  <p>Do you really want to delete this entry?</p>
  <span id="delete-modal-details" class="modal-details"></span>
  <div id="delete-modal-buttons" class="modal-buttons">
    <button id="delete-btn-cancel">Cancel</button>
    <button id="delete-btn-confirm">Yes, Delete</button>
  </div>
</div>

<!-- Edit chip modal -->
<div id="edit-chip-modal-backdrop" class="modal-backdrop"></div>
<div id="edit-chip-modal" class="modal" role="dialog" aria-modal="true" aria-labelledby="edit-chip-modal-title">
  <h3 id="edit-chip-modal-title">Edit Entry</h3>
  <div class="modal-form-group">
    <label for="edit-chip-value">Value:</label>
    <input type="number" id="edit-chip-value" step="0.01" placeholder="Enter value">
  </div>
  <div class="modal-form-group">
    <label for="edit-chip-date">Date:</label>
    <input type="date" id="edit-chip-date">
  </div>
  <span id="edit-chip-details" class="modal-details"></span>
  <div id="edit-chip-buttons" class="modal-buttons">
    <button id="edit-chip-delete">Delete</button>
    <button id="edit-chip-cancel">Cancel</button>
    <button id="edit-chip-save">Save</button>
  </div>
</div>

<!-- Account menu modal -->
<div id="account-menu-modal-backdrop" class="modal-backdrop"></div>
<div id="account-menu-modal" class="modal" role="dialog" aria-modal="true" aria-labelledby="account-menu-modal-title">
  <h3 id="account-menu-modal-title">Account Actions</h3>
  <p id="account-menu-account-name" style="font-weight: 600; font-size: 1.2rem; margin-bottom: 1rem;"></p>
  <div id="account-menu-buttons" class="modal-buttons">
    <button id="account-menu-edit">‚úèÔ∏è Edit Account Settings</button>
    <button id="account-menu-delete">üóëÔ∏è Delete Account</button>
    <button id="account-menu-add">‚ûï Add New Account Below</button>
    <button id="account-menu-cancel">Cancel</button>
  </div>
</div>

<!-- Edit Account modal -->
<div id="edit-account-modal-backdrop" class="modal-backdrop"></div>
<div id="edit-account-modal" class="modal" role="dialog" aria-modal="true" aria-labelledby="edit-account-modal-title">
  <h3 id="edit-account-modal-title">Edit Account</h3>
  <p id="edit-account-name" style="font-weight: 600; font-size: 1.1rem; margin-bottom: 1rem;"></p>

  <div class="modal-form-group">
    <label for="edit-account-type">Type:</label>
    <select id="edit-account-type">
      <option value="bk">Banks</option>
      <option value="cc">CreditCards</option>
      <option value="bill">Bills</option>
      <option value="ii">Investments</option>
      <option value="sv">Savings</option>
    </select>
  </div>

  <div class="modal-form-group">
    <label for="edit-account-color">Account Color (hex):</label>
    <div style="display:flex; gap:8px; align-items:center;">
      <input type="color" id="edit-account-color-picker" style="flex:0 0 40px; padding:0; border-radius:50%; border:1px solid var(--c-input-border); height:40px;">
      <input type="text" id="edit-account-color" placeholder="#4c8036" style="flex:1;">
    </div>
  </div>

  <div class="modal-form-group">
    <label for="edit-account-link">Account Link (login URL, etc.):</label>
    <input type="url" id="edit-account-link" placeholder="https://...">
  </div>

  <div class="modal-form-group">
    <label for="edit-account-limit">Credit Limit (for CC accounts):</label>
    <input type="number" id="edit-account-limit" step="1" placeholder="e.g. 5000">
  </div>

  <div class="modal-form-group">
    <label for="edit-account-apr">APR (as decimal, e.g. 0.29 for 29%):</label>
    <input type="number" id="edit-account-apr" step="0.01" placeholder="e.g. 0.29">
  </div>

  <div class="modal-form-group">
    <label for="edit-account-value">Current Value:</label>
    <input type="number" id="edit-account-value" step="0.01" placeholder="Current balance">
  </div>

  <div id="edit-account-buttons" class="modal-buttons">
    <button id="edit-account-cancel">Cancel</button>
    <button id="edit-account-save">Save Changes</button>
  </div>
</div>

<!-- Edit Type Color modal -->
<div id="edit-type-modal-backdrop" class="modal-backdrop"></div>
<div id="edit-type-modal" class="modal" role="dialog" aria-modal="true" aria-labelledby="edit-type-modal-title">
  <h3 id="edit-type-modal-title">Edit Type Color</h3>
  <p id="edit-type-name" style="font-weight:600; font-size:1.0rem; margin-bottom:1rem;"></p>
  <div class="modal-form-group">
    <label for="edit-type-color">Type Color (hex):</label>
    <div style="display:flex; gap:8px; align-items:center;">
      <input type="color" id="edit-type-color-picker" style="flex:0 0 40px; padding:0; border-radius:50%; border:1px solid var(--c-input-border); height:40px;">
      <input type="text" id="edit-type-color" placeholder="#4c8036" style="flex:1;">
    </div>
  </div>
  <div class="modal-buttons">
    <button id="edit-type-cancel">Cancel</button>
    <button id="edit-type-save">Save</button>
  </div>
</div>

<!-- Main header -->
<header>
  <div class="toolbar">
    <div class="financial-group">
      <div id="financial-summary"></div>
      <div id="interest-summary"></div>
    </div>

    <div class="toolbar-right">
      <!-- Dark mode toggle -->
      <div class="dark-mode-toggle">
        <label for="dark-mode-checkbox">Nite Mode</label>
        <label class="toggle-switch">
          <input type="checkbox" id="dark-mode-checkbox" aria-label="Toggle dark mode">
          <span class="toggle-switch-slider"></span>
        </label>
      </div>

      <!-- Type filters now in the top toolbar, no "Types" title -->
      <div id="typeFilterRow" class="type-filter-row"></div>

      <div class="toolbar-controls">
        <label for="timeframe">Timeframe:</label>
        <select id="timeframe">
          <option value="ytd" selected>This Calendar Year</option>
          <option value="today">Today</option>
          <option value="7d">Last 7 Days</option>
          <option value="14d">Last 14 Days</option>
          <option value="30d">Last 30 Days</option>
          <option value="90d">Last 90 Days</option>
          <option value="1y">Last Year (12mo)</option>
          <option value="all">All Time</option>
        </select>

        <label><input type="radio" name="mode" value="totals" checked> Totals</label>
        <label><input type="radio" name="mode" value="types"> Type</label>
        <label><input type="radio" name="mode" value="accounts"> Per-account</label>

        <button id="refresh" aria-label="Refresh data">Refresh</button>
        <button id="submitAll">Submit All</button>
      </div>
    </div>
  </div>
  <hr>
  <div id="chart"></div>
  <hr>
  <!-- Statusbar -->
  <section id="statusbar"></section>
</header>

<hr class="wrap divider">

<main class="wrap">
  <section id="accounts" class="accounts"></section>

  <!-- Footer -->
  <footer>
    <div class="security-notice">
      üîí <strong>Privacy First:</strong> No login credentials or personally identifiable 
      information is stored in this application. All data resides in your Google Sheet. 
      Your financial footprint, your control.
    </div>

    <small>
      <b>v2.5 Features:</b> CC limits ‚Ä¢ Edit account settings ‚Ä¢ Type summaries in toolbar ‚Ä¢ Type color overrides ‚Ä¢ Mute/unmute accounts & types ‚Ä¢ Dark mode üåô<br>
      <a href="https://docs.google.com/spreadsheets/d/YOUR_SHEET_ID_HERE" target="_blank" rel="noopener">üìä Open Google Sheet</a>
    </small>
  </footer>
</main>

<script>
/* ============================================
    CONFIGURATION
   ============================================ */
// !!! IMPORTANT: REPLACE THESE WITH YOUR DEPLOYED VALUES !!!
const API_BASE = 'https://script.google.com/macros/s/AKfycbzWd8KkkoQf6eqXOpC42TRGeByhmY2d4s6ag4KH7iUDPt6txr5pu41E0F7qar6kVjSmWg/exec';
const SHEET_ID = '1v5Xc57U77arzf-JUqe85Iwwh-9Z1i1u0Rcmyrans9o8/edit?usp=sharing';

/* ============================================
    APPLICATION STATE
   ============================================ */
let SNAP = null;
let MODE = 'totals';
let TIMEFRAME = 'ytd';
let IS_LOADING = false;
let TOAST_TIMER = null;
let LONG_PRESS_TIMER = null;
const LONG_PRESS_DURATION = 500;

let MUTED_ACCOUNTS = new Set();
let MUTED_TYPES = new Set();
let DARK_MODE = false;

const TYPE_LABELS = {
  'bk': 'Banks',
  'cc': 'CreditCards',
  'bill': 'Bills',
  'ii': 'Investments',
  'sv': 'Savings'
};

let ACCOUNT_METADATA = new Map();  
let TYPE_META_OVERRIDES = new Map(); 

/* ============================================
    DARK MODE
   ============================================ */
function toggleDarkMode() {
  DARK_MODE = !DARK_MODE;
  const root = document.documentElement;
  
  if (DARK_MODE) {
    root.classList.add('dark-mode');
  } else {
    root.classList.remove('dark-mode');
  }
  
  document.getElementById('dark-mode-checkbox').checked = DARK_MODE;
  saveStateToURL();
  
  // RENDER FIX: Force chart and components to redraw with new colors
  renderAll();
}

function initDarkMode() {
  const checkbox = document.getElementById('dark-mode-checkbox');
  checkbox.addEventListener('change', toggleDarkMode);
  
  if (DARK_MODE) {
    document.documentElement.classList.add('dark-mode');
    checkbox.checked = true;
  }
}

/* ============================================
    UI UTILITIES (showToast, setLoading, etc.)
   ============================================ */
function showToast(msg, type = 'info', duration = 3000) {
  const el = document.getElementById('toast');
  if (!el) return;

  if (TOAST_TIMER) clearTimeout(TOAST_TIMER);

  el.textContent = msg;
  el.dataset.type = type;
  el.classList.add('show');

  TOAST_TIMER = setTimeout(() => el.classList.remove('show'), duration);
}

function setLoading(loading, message) {
  IS_LOADING = loading;

  document.getElementById('refresh').disabled = loading;
  document.getElementById('submitAll').disabled = loading;

  document.querySelectorAll('.row .left input[type="number"]').forEach(inp => {
    inp.disabled = loading;
    inp.classList.toggle('submitting', loading);
  });

  if (message && !document.getElementById('delete-modal-backdrop').classList.contains('show')) {
    showToast(message, 'info', loading ? 10000 : 3000);
  }
}

/* ... (All Modal Functions: showDeleteConfirm, hideDeleteConfirm, etc. remain here) ... */

function normalizeHexColor(value) {
  if (!value) return null;
  let v = value.trim();
  if (!v) return null;
  if (v[0] !== '#') v = '#' + v;
  if (!/^#[0-9A-Fa-f]{6}$/.test(v)) return null;
  return v.toUpperCase();
}

function getTypeEffectiveColor(typeCode) {
  const override = TYPE_META_OVERRIDES.get(typeCode);
  if (override && override.color) return override.color;

  const metaAPI = SNAP?.typeMeta?.[typeCode];
  if (metaAPI && metaAPI.color) return normalizeHexColor(metaAPI.color) || null;

  // Fallback to bright day colors if no color is defined (as per original types.csv)
  if (typeCode === 'cc' || typeCode === 'bill') return '#a02d2a'; 
  return '#4c8036';
}

/* ============================================
    DATA FETCHING (fetchSnapshot, submitEntries, etc.)
   ============================================ */
async function fetchSnapshot() {
  if (IS_LOADING) return;
  setLoading(true, 'Loading snapshot‚Ä¶');

  try {
    const res = await fetch(`${API_BASE}?route=snapshot&ts=${Date.now()}&timeframe=${TIMEFRAME}`);
    const text = await res.text();

    let j;
    try { 
      j = JSON.parse(text); 
    } catch {
      console.error('Non-JSON response:', text); 
      // This is the error the user sees if the API_BASE is incorrect or fails
      showToast('Error: API returned non-JSON. Please check SCRIPT_URL deployment.', 'error', 8000);
      setLoading(false);
      return;
    }

    if (!j.ok) {
      console.error('Snapshot error:', j); 
      showToast('Error: ' + (j.error || 'snapshot failed'), 'error', 5000);
      setLoading(false);
      return;
    }

    SNAP = j;
    setLoading(false);
    renderAll();

  } catch (err) {
    console.error('Fetch failed:', err); 
    setLoading(false);
    showToast('Fetch failed (check console/network tab)', 'error', 5000);
  }
}

/* ============================================
    RENDERING (renderChart, renderAccounts, etc.)
   ============================================ */

function renderChart() {
  if (!SNAP || !window.google || !google.visualization) return;

  const labels = SNAP.dateAxis; 
  if (!labels || labels.length === 0) {
    // FIX: Use CSS variable for color
    document.getElementById('chart').innerHTML =
      '<div style="text-align:center; padding-top: 20px; color: var(--c-fg);">No data for this timeframe.</div>';
    return;
  }

  const styles = getComputedStyle(document.documentElement);
  const pos   = styles.getPropertyValue('--c-pos').trim();
  const neg   = styles.getPropertyValue('--c-neg').trim();
  const fg    = styles.getPropertyValue('--c-fg').trim();
  const bg    = styles.getPropertyValue('--c-bg').trim();
  const textStyle = { color: fg, fontName: 'system-ui' };

  const data = new google.visualization.DataTable();
  data.addColumn('string', 'Date'); 
  let rows = [];

  if (MODE === 'totals') {
    data.addColumn('number', 'Assets');
    data.addColumn('number', 'Debts');

    for (let i = 0; i < labels.length; i++) { 
      let assets = 0;
      let debts = 0;

      SNAP.accounts.forEach(a => {
        if (isAccountGloballyHidden(a)) return;
        const v = SNAP.series[a.name]?.monthly?.[i] ?? 0;
        if (v >= 0) {
          assets += v;
        } else {
          debts += v;
        }
      });

      rows.push([labels[i], assets, debts]);
    }
  } else if (MODE === 'types') {
    const typeSeries = SNAP.typeSeries || {};
    const typeMeta = SNAP.typeMeta || {};
    const seriesKeys = Object.keys(typeSeries);
    const visibleTypes = Object.keys(typeSeries).filter(code => !isTypeMuted(code));

    visibleTypes.forEach(code => {
      const baseLabel = TYPE_LABELS[code] || typeMeta[code]?.label || code;
      data.addColumn('number', baseLabel);
    });

    for (let i = 0; i < labels.length; i++) {
      const row = [labels[i]];
      visibleTypes.forEach(code => {
        const seriesArr = typeSeries[code] || [];
        const v = Number(seriesArr[i] ?? 0);
        row.push(v);
      });
      rows.push(row);
    }
  } else {
    const visibleAccounts = SNAP.accounts.filter(a => !isAccountGloballyHidden(a));
    visibleAccounts.forEach(a => data.addColumn('number', a.name));

    for (let i = 0; i < labels.length; i++) {
      const row = [labels[i]]; 
      visibleAccounts.forEach(a => {
        const v = SNAP.series[a.name]?.monthly?.[i] ?? 0;
        row.push(Number(v));
      });
      rows.push(row);
    }
  }

  data.addRows(rows);

  let minV = 0, maxV = 0;
  for (const r of rows) {
    for (let i = 1; i < r.length; i++) {
      const v = Number(r[i]) || 0;
      if (v < minV) minV = v;
      if (v > maxV) maxV = v;
    }
  }
  const maxAbs = Math.max(Math.abs(minV), Math.abs(maxV), 100);

  let chartColors;
  if (MODE === 'totals') {
    chartColors = [pos, neg];
  } else if (MODE === 'types') {
    const visibleTypes = Object.keys(SNAP.typeSeries || {}).filter(code => !isTypeMuted(code));
    chartColors = visibleTypes.map(code => getTypeEffectiveColor(code));
  } else {
    const visibleAccounts = SNAP.accounts.filter(a => !isAccountGloballyHidden(a));
    chartColors = visibleAccounts.map(a => {
      const meta = ACCOUNT_METADATA.get(a.name) || {};
      const baseColor = meta.color || a.color;
      // Use original color for custom accounts, fall back to faint semantic colors
      if (baseColor) return normalizeHexColor(baseColor) || (a.kind === 'debt' ? neg : pos);
      return a.kind === 'debt' ? neg : pos;
    });
  }

  const options = {
    height: Math.max(240, Math.round(window.innerHeight * 0.30)),
    backgroundColor: { fill: 'transparent' }, 
    chartArea: { width: '90%', height: '70%', backgroundColor: 'transparent' },
    legend: { position: 'top', alignment: 'center', textStyle: textStyle },
    hAxis: { 
      slantedText: false, 
      textStyle: textStyle,
      showTextEvery: labels.length > 30 ? Math.ceil(labels.length / 15) : 1
    },
    vAxis: { 
      viewWindow: { min: -maxAbs * 1.05, max: maxAbs * 1.05 }, 
      baseline: 0, 
      baselineColor: fg,
      gridlines: { color: fg, opacity: 0.1 },
      textStyle: textStyle
    },
    isStacked: true,
    colors: chartColors,
    animation: {
      duration: 500,
      easing: 'out'
    }
  };

  const chart = new google.visualization.ColumnChart(document.getElementById('chart'));
  chart.draw(data, options);
}

function renderAccounts() {
  const root = document.getElementById('accounts');
  root.innerHTML = '';
  if (!SNAP || !SNAP.accounts) return;

  const styles = getComputedStyle(document.documentElement);
  const pos_base = styles.getPropertyValue('--c-pos').trim();
  const neg_base = styles.getPropertyValue('--c-neg').trim();

  SNAP.accounts.forEach(a => {
    // ... (rest of account rendering logic is here, but removed for brevity) ...

    // --- Account Name Color ---
    const meta = ACCOUNT_METADATA.get(a.name) || {};
    const effectiveColor = meta.color || a.color;
    if (effectiveColor) {
      const norm = normalizeHexColor(effectiveColor);
      if (norm) nameEl.style.color = norm;
    } else {
      nameEl.style.color = fg;
    }
    
    // --- Input Field Tinting ---
    if (last > 0) {
      inp.style.backgroundColor = 'var(--c-tint-pos)';
    } else if (last < 0) {
      inp.style.backgroundColor = 'var(--c-tint-neg)';
    } else {
      inp.style.backgroundColor = 'var(--c-input-bg)';
    }
    
    // ... (rest of renderAccounts logic continues, using pos_base and neg_base for interest/limit) ...
  });
}
// Note: Due to file length constraints, the full, supporting modal/state functions are not repeated, 
// but they rely on the same updated CSS variables.
</script>
