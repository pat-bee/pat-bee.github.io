<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Ledger â€” Accounts & Chart (v2.5)</title>

<!-- Google Fonts Import (Removed Inconsolata) -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Geologica:wght@100..900&family=Patrick+Hand&display=swap" rel="stylesheet">

<style>
/* ============================================
      CSS VARIABLES & DESIGN TOKENS
   ============================================ */
:root {
  --maxw: 1400px;
  --c-pos: #4c8036;
  --c-neg: #a02d2a;
  --c-black: #000000;
  --c-white: #ffffff;
  --c-bg: #ffffff;
  --c-fg: #000000;
  --c-border: #000000;
  --radius: 10px;
  --gap: 12px;
  --c-tint-pos: #f7f9f4;
  --c-tint-neg: #f9f4f4;
  --c-muted: #e8e8e8;
  --c-overlimit: #d85140;
  --c-input-bg: #ffffff;
  --c-input-border: #000000;
  --c-header-bg: #ffffff;
  --c-statusbar-bg: #ffffff;
  --c-toast-bg: #000000;
  --c-toast-fg: #ffffff;
  --c-modal-bg: #ffffff;
  --c-modal-border: #000000;
  --c-modal-fg: #000000;
  
  /* Default Font Family Variable - Changed to Geologica */
  --font-current: "Geologica", system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
}

:root.dark-mode {
  --c-pos: #7cbf5f;
  --c-neg: #ff6b5f;
  --c-black: #ffffff;
  --c-white: #1a1a1a;
  --c-bg: #1a1a1a;
  --c-fg: #e0e0e0;
  --c-border: #404040;
  --c-tint-pos: #1a3a0f;
  --c-tint-neg: #3a1a1a;
  --c-muted: #333333;
  --c-input-bg: #2a2a2a;
  --c-input-border: #505050;
  --c-header-bg: #222222;
  --c-statusbar-bg: #222222;
  --c-toast-bg: #333333;
  --c-toast-fg: #e0e0e0;
  --c-modal-bg: #2a2a2a;
  --c-modal-border: #505050;
  --c-modal-fg: #e0e0e0;
}

/* ============================================
      BASE LAYOUT
   ============================================ */
html, body { 
  height: 100%; 
  margin: 0; 
  background: var(--c-bg); 
  color: var(--c-fg); 
}

body {
  font-family: var(--font-current);
  font-size: 18px;
  line-height: 1.5;
  transition: background-color 0.3s ease, color 0.3s ease, font-family 0.2s ease;
}

.wrap { 
  width: 90vw; 
  max-width: var(--maxw); 
  margin: 0 auto; 
  padding: 0px;
}

a {
  color: var(--c-black);
  text-decoration: underline;
}

/* ============================================
      HEADER & TOOLBAR
   ============================================ */
header { 
  position: sticky; 
  top: 0; 
  background: var(--c-header-bg); 
  z-index: 5; 
  border-bottom: 1px solid var(--c-border);
  padding-bottom: 1rem;
  transition: background-color 0.3s ease;
}

.toolbar { 
  display: flex; 
  gap: var(--gap); 
  align-items: flex-start;
  justify-content: space-between;
  padding: 6px 24px 10px 24px;
  flex-wrap: nowrap; 
  width: 100%;
  box-sizing: border-box;
}

/* Left side: big numbers */
.financial-group {
  display: flex;
  gap: var(--gap);
  align-items: baseline;
  flex-wrap: wrap;
  min-width: 0;
  flex-shrink: 1;
}

/* Right side: type filters + controls */
.toolbar-right {
  display: flex;
  flex-direction: column;
  align-items: flex-end;
  gap: 6px;
  flex-shrink: 0;
  max-width: 60%;
}

/* Type filter row */
.type-filter-row {
  display: flex;
  flex-wrap: wrap;
  justify-content: flex-end;
  gap: 0.35rem;
}

/* Controls row */
.toolbar-controls {
  display: flex;
  gap: 0.6rem;
  align-items: center;
  flex-wrap: wrap;
  justify-content: flex-end;
}

/* Make the controls fonts compact */
.toolbar label { 
  font-size: 0.8rem;
  font-weight: 300;
  cursor: pointer;
  color: var(--c-fg);
}

.toolbar select {
  font-size: 0.8rem;
  font-weight: 300;
  padding: 4px 6px;
  border: 1px solid var(--c-input-border);
  border-radius: 4px;
  background: var(--c-input-bg);
  color: var(--c-fg);
  font-family: var(--font-current);
  transition: background-color 0.3s ease, border-color 0.3s ease;
}

/* ============================================
      FINANCIAL SUMMARY
   ============================================ */
#financial-summary {
  font-size: 5rem;
  font-weight: 300;
  white-space: nowrap;
  line-height: 1.1;
  flex-shrink: 1;
  min-width: 0;
  color: var(--c-fg);
}

#financial-summary .bold-value {
  font-weight: 700;
}

#interest-summary {
  font-size: 2rem;
  font-weight: 300;
  white-space: nowrap;
  line-height: 1.1;
  flex-shrink: 1;
  min-width: 0;
  opacity: 0.9;
}

.interest-earned { color: var(--c-pos); }
.interest-cost { color: var(--c-neg); }
.summary-debt { color: var(--c-neg); }
.summary-asset { color: var(--c-pos); }

/* ============================================
      CHART CONTAINER
   ============================================ */
#chart { 
  min-height: 30vh; 
  width: 100%; 
  margin: 0;
  padding: 0;
  overflow: hidden; 
  display: flex;    
  flex-direction: column;
  justify-content: center;
  align-items: center;
}
#chart-pager {
  text-align: center;
}
#chart-pager button {
  background: var(--c-input-bg);
  color: var(--c-fg);
  border: 1px solid var(--c-input-border);
  padding: 0.5rem 1rem;
  font-size: 1rem;
  cursor: pointer;
  margin: 0.5rem 0.25rem;
  border-radius: var(--radius);
  transition: background-color 0.3s ease, transform 0.15s ease;
  font-family: var(--font-current);
}
#chart-pager button:hover {
  background-color: var(--c-muted);
  transform: scale(1.05);
}
#chart-pager button:active {
  transform: scale(0.95);
}

/* ============================================
      ACCOUNTS SECTION
   ============================================ */
main { padding: 1rem; }

.row { 
  display: flex; 
  border-bottom: 1px solid var(--c-border); 
  padding: 1rem;
  transition: background-color 0.3s ease, opacity 0.3s ease;
}

.row.muted {
  opacity: 0.3;
}

.left { 
  flex: 1; 
  min-width: 0; 
  margin-right: 1rem;
}

.right { 
  flex: 1.5; 
  display: flex; 
  flex-direction: column; 
  justify-content: flex-start;
  gap: 0.75rem;
}

.account-details { 
  margin-bottom: 0.4rem; 
  display: flex; 
  flex-direction: column; 
  gap: 0.4rem;
}

.lastval { 
  font-size: 1.5rem; 
  font-weight: 700; 
  white-space: nowrap; 
  margin-right: 10px;
}

.lastval[data-sign='neg'] { color: var(--c-neg); }
.lastval[data-sign='pos'] { color: var(--c-pos); }

.name { 
  font-size: 1.2rem; 
  font-weight: 300; 
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
  user-select: none;
  cursor: default;
  flex-shrink: 1;
  min-width: 0;
}

.limit {
  font-size: 0.9rem;
  font-weight: 300;
  margin-left: 2.5rem;
  transition: color 0.3s ease;
}

.apr {
  font-size: 0.85rem;
  font-weight: 300;
  margin-left: 2.5rem;
  color: var(--c-fg);
  opacity: 0.7;
  line-height: 1.3;
}

.input-line { 
  display: flex; 
  gap: 0.5rem; 
  align-items: center;
  margin-left: 2.5rem;
}

.input-line input { 
  flex: 1; 
  border: 1px solid var(--c-input-border); 
  border-radius: var(--radius);
  padding: 0.4rem; 
  font-size: 0.9rem; 
  background: var(--c-input-bg);
  color: var(--c-fg);
  transition: background-color 0.3s ease, border-color 0.3s ease, opacity 0.3s ease;
  font-family: var(--font-current);
}

.input-line input.submitting { opacity: 0.5; }
.input-line input.submitted-ok { 
  animation: flash-green 0.8s ease;
}

@keyframes flash-green {
  0%, 100% { background-color: var(--c-input-bg); }
  50% { background-color: var(--c-pos); }
}

/* ============================================
      MUTE CHECKBOX (TOGGLE STYLE)
   ============================================ */
.mute-checkbox {
  position: relative;
  display: inline-block;
  width: 44px;
  height: 24px;
  flex-shrink: 0;
}

.mute-checkbox input {
  opacity: 0;
  width: 0;
  height: 0;
}

.mute-checkbox-slider {
  position: absolute;
  cursor: pointer;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background-color: var(--c-muted);
  transition: .4s;
  border-radius: 24px;
}

.mute-checkbox-slider:before {
  position: absolute;
  content: "";
  height: 18px;
  width: 18px;
  left: 3px;
  bottom: 3px;
  background-color: white;
  transition: .4s;
  border-radius: 50%;
}

.mute-checkbox input:checked + .mute-checkbox-slider {
  background-color: var(--c-pos);
}

.mute-checkbox input:checked + .mute-checkbox-slider:before {
  transform: translateX(20px);
}

/* ============================================
      VALUES & CHIPS
   ============================================ */
.values { 
  display: flex; 
  flex-wrap: wrap; 
  gap: 0.4rem;
  padding: 0.1rem 0;
}

.chip { 
  display: inline-block; 
  padding: 0.3rem 0.6rem; 
  background: var(--c-muted); 
  color: var(--c-fg); 
  border-radius: 1rem; 
  font-size: 0.85rem; 
  font-weight: 400;
  transition: transform 0.2s ease, background-color 0.3s ease;
  cursor: pointer;
  user-select: none;
}

.chip:hover {
  transform: scale(1.05);
  background: var(--c-border);
}

.chip.no-delete {
  cursor: default;
  opacity: 0.7;
}

.chip.no-delete:hover {
  transform: none;
  background: var(--c-muted);
}

.chip[data-sign='pos'] { color: var(--c-pos); font-weight: 500; }
.chip[data-sign='neg'] { color: var(--c-neg); font-weight: 500; }

/* ============================================
      RATIO BAR
   ============================================ */
.ratio-bar { 
  font-size: 0.7rem; 
  line-height: 1; 
  margin: 0; 
  padding: 0;
  display: flex;
  gap: 0.2rem;
  font-family: monospace;
  letter-spacing: -0.1em;
}

/* ============================================
      TYPE FILTER CHIPS
   ============================================ */
.type-chip {
  display: inline-block;
  padding: 0.25rem 0.5rem;
  background: var(--c-muted);
  color: var(--c-fg);
  border-radius: 1rem;
  font-size: 0.75rem;
  font-weight: 400;
  cursor: pointer;
  user-select: none;
  transition: all 0.3s ease;
  border: 2px solid transparent;
}

.type-chip.active {
  background: var(--c-black);
  color: var(--c-white);
  transform: scale(1.05);
}

.type-chip:hover {
  transform: scale(1.1);
  border-color: var(--c-border);
}

/* ============================================
      STATUS BAR (FOOTER)
   ============================================ */
footer { 
  position: sticky; 
  bottom: 0; 
  background: var(--c-statusbar-bg); 
  padding: 0.6rem 1rem; 
  border-top: 1px solid var(--c-border);
  z-index: 3;
  transition: background-color 0.3s ease;
  display: flex;
  justify-content: space-between;
  align-items: center;
  gap: 0.5rem;
}

.status-left {
  display: flex;
  gap: 0.5rem;
  align-items: center;
  flex: 1;
}

.status-center {
  display: flex;
  gap: 0.25rem;
  align-items: center;
  justify-content: center;
  flex-shrink: 0;
}

.status-right {
  display: flex;
  gap: 0.5rem;
  align-items: center;
  justify-content: flex-end;
  flex: 1;
}

button { 
  cursor: pointer; 
  font-family: var(--font-current);
}

#submitAll, #refresh { 
  padding: 0.3rem 0.8rem; 
  font-size: 0.9rem; 
  font-weight: 400;
  border: 1px solid var(--c-input-border); 
  border-radius: var(--radius); 
  background: var(--c-input-bg);
  color: var(--c-fg);
  transition: background-color 0.3s ease, transform 0.15s ease;
}

#submitAll:hover, #refresh:hover { 
  background: var(--c-muted); 
  transform: scale(1.05);
}

#submitAll:active, #refresh:active {
  transform: scale(0.95);
}

#score-display {
  font-size: 1.1rem;
  font-weight: 700;
  color: var(--c-fg);
  padding: 0.2rem 0.6rem;
  border-radius: var(--radius);
  background: var(--c-muted);
  cursor: pointer;
  transition: background-color 0.3s ease, transform 0.15s ease;
  user-select: none;
}

#score-display:hover {
  transform: scale(1.05);
  background: var(--c-border);
}

/* Font switcher buttons */
.font-switcher {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  font-size: 0.9rem;
  font-weight: 300;
}

#font-prev, #font-next {
  padding: 0.2rem 0.5rem;
  font-size: 0.9rem;
  border: 1px solid var(--c-input-border);
  border-radius: 4px;
  background: var(--c-input-bg);
  color: var(--c-fg);
  cursor: pointer;
  transition: background-color 0.3s ease, transform 0.15s ease;
}

#font-prev:hover, #font-next:hover {
  background: var(--c-muted);
  transform: scale(1.05);
}

#font-name {
  min-width: 140px;
  text-align: center;
  font-weight: 400;
  color: var(--c-fg);
}

footer .links { 
  font-size: 0.8rem; 
  display: flex; 
  gap: 0.8rem;
  align-items: center;
}

footer .links a { 
  color: var(--c-fg); 
  opacity: 0.7;
  transition: opacity 0.3s ease;
}

footer .links a:hover {
  opacity: 1;
}

/* ============================================
      LOADING SPINNER & TOAST
   ============================================ */
.loading { 
  position: fixed; 
  top: 50%; 
  left: 50%; 
  transform: translate(-50%, -50%); 
  background: var(--c-toast-bg); 
  color: var(--c-toast-fg); 
  padding: 1rem 2rem; 
  border-radius: var(--radius); 
  z-index: 100;
  font-weight: 300;
  font-size: 1rem;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
}

.toast {
  position: fixed;
  bottom: 100px;
  left: 50%;
  transform: translateX(-50%);
  background: var(--c-toast-bg);
  color: var(--c-toast-fg);
  padding: 0.8rem 1.5rem;
  border-radius: var(--radius);
  z-index: 100;
  font-size: 0.9rem;
  font-weight: 400;
  opacity: 0;
  transition: opacity 0.3s ease;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
}

.toast.show { opacity: 1; }
.toast.success { background: var(--c-pos); }
.toast.error { background: var(--c-neg); }
.toast.info { background: var(--c-toast-bg); }

/* ============================================
      DARK MODE TOGGLE (COMPACT EMOJI)
   ============================================ */
.dark-mode-toggle {
  position: fixed;
  bottom: 10px;
  right: 10px;
  width: 40px;
  height: 40px;
  border-radius: 50%;
  background: var(--c-muted);
  border: 2px solid var(--c-border);
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  font-size: 1.3rem;
  transition: transform 0.3s ease, background-color 0.3s ease;
  z-index: 10;
  user-select: none;
}

.dark-mode-toggle:hover {
  transform: scale(1.1);
  background: var(--c-border);
}

/* ============================================
      MODAL STYLES (GENERIC)
   ============================================ */
.modal-backdrop {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.5);
  z-index: 50;
  opacity: 0;
  transition: opacity 0.3s ease;
}

.modal-backdrop.show {
  display: block;
  opacity: 1;
}

.modal {
  display: none;
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%) scale(0.8);
  background: var(--c-modal-bg);
  color: var(--c-modal-fg);
  padding: 2rem;
  border-radius: var(--radius);
  border: 2px solid var(--c-modal-border);
  box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
  z-index: 51;
  max-width: 400px;
  width: 90%;
  opacity: 0;
  transition: opacity 0.3s ease, transform 0.3s ease;
}

.modal.show {
  display: block;
  opacity: 1;
  transform: translate(-50%, -50%) scale(1);
}

.modal h3 {
  margin-top: 0;
  margin-bottom: 1rem;
  font-size: 1.3rem;
  font-weight: 500;
}

.modal p {
  margin: 1rem 0;
  font-size: 1rem;
  line-height: 1.4;
}

.modal input {
  width: 100%;
  padding: 0.5rem;
  font-size: 1rem;
  border: 1px solid var(--c-input-border);
  border-radius: 6px;
  background: var(--c-input-bg);
  color: var(--c-fg);
  box-sizing: border-box;
  font-family: var(--font-current);
}

.modal-buttons {
  display: flex;
  gap: 1rem;
  justify-content: flex-end;
  margin-top: 1.5rem;
}

.modal button {
  padding: 0.5rem 1rem;
  font-size: 0.95rem;
  border: 1px solid var(--c-input-border);
  border-radius: 6px;
  background: var(--c-input-bg);
  color: var(--c-fg);
  cursor: pointer;
  transition: background-color 0.3s ease, transform 0.15s ease;
  font-family: var(--font-current);
}

.modal button:hover {
  background: var(--c-muted);
  transform: scale(1.05);
}

.modal button.danger {
  background: var(--c-neg);
  color: var(--c-white);
  border-color: var(--c-neg);
}

.modal button.danger:hover {
  background: #d03633;
}

/* ============================================
      RESPONSIVE DESIGN
   ============================================ */
@media (max-width: 768px) {
  .toolbar { 
    flex-direction: column; 
    align-items: stretch;
    gap: 0.5rem;
  }
  
  .toolbar-right {
    align-items: stretch;
    max-width: 100%;
  }
  
  .type-filter-row {
    justify-content: flex-start;
  }
  
  .toolbar-controls {
    justify-content: flex-start;
  }
  
  #financial-summary { font-size: 3rem; }
  #interest-summary { font-size: 1.5rem; }
  
  .row { flex-direction: column; }
  .left { margin-right: 0; margin-bottom: 1rem; }
  .right { flex: 1; }
  
  footer {
    flex-direction: column;
    gap: 0.8rem;
    align-items: stretch;
  }
  
  .status-left, .status-center, .status-right {
    justify-content: center;
  }
  
  .links { 
    justify-content: center;
    flex-wrap: wrap;
  }
}
</style>
</head>
<body>
<header>
  <div class="toolbar wrap">
    <div class="financial-group">
      <div id="financial-summary"></div>
      <div id="interest-summary"></div>
    </div>
    
    <div class="toolbar-right">
      <div class="type-filter-row" id="type-filters">
        <!-- Type filters populated by JS -->
      </div>
      
      <div class="toolbar-controls">
        <label>âŒš<input type="radio" name="mode" value="donut" checked/> Donut</label>
        <label><input type="radio" name="mode" value="line"/> Line</label>
        <label><input type="radio" name="mode" value="area"/> Area</label>
        <label><input type="radio" name="mode" value="bar"/> Bar</label>
        <label for="timeframe">ðŸ“…</label>
        <select id="timeframe">
          <option value="today">Today</option>
          <option value="7d" selected>7 Days</option>
          <option value="14d">14 Days</option>
          <option value="30d">30 Days</option>
          <option value="90d">90 Days</option>
          <option value="ytd">YTD</option>
          <option value="1y">1 Year</option>
          <option value="all">All</option>
        </select>
      </div>
    </div>
  </div>
</header>

<section id="chart">
  <!-- Chart populated by JS -->
</section>
<div id="chart-pager"></div>

<main class="wrap">
  <section id="accounts">
    <!-- Accounts populated by JS -->
  </section>
</main>

<footer>
  <div class="status-left">
    <button id="submitAll">â¬† Submit All</button>
    <button id="refresh">â†» Refresh</button>
  </div>
  
  <div class="status-center">
    <div id="score-display">000</div>
  </div>
  
  <div class="status-right">
    <div class="font-switcher">
      <button id="font-prev" title="next font">&lt;</button>
      <span id="font-name">Geologica</span>
      <button id="font-next" title="next font">&gt;</button>
    </div>
    <div class="links">
      <a href="https://docs.google.com/spreadsheets" target="_blank">Sheet</a>
      <a href="https://github.com" target="_blank">GitHub</a>
    </div>
  </div>
</footer>

<!-- Dark Mode Toggle -->
<div class="dark-mode-toggle" id="dark-mode-toggle">ðŸŒ™</div>

<!-- Loading Spinner -->
<div class="loading" id="loading" style="display:none;">Loadingâ€¦</div>

<!-- Toast Notification -->
<div class="toast" id="toast"></div>

<!-- Delete Confirmation Modal -->
<div class="modal-backdrop" id="delete-modal-backdrop"></div>
<div class="modal" id="delete-confirm">
  <h3>Delete Entry?</h3>
  <p id="delete-confirm-text"></p>
  <div class="modal-buttons">
    <button id="delete-btn-confirm" class="danger">Delete</button>
    <button id="delete-btn-cancel">Cancel</button>
  </div>
</div>

<!-- Edit Chip Modal -->
<div class="modal-backdrop" id="edit-chip-modal-backdrop"></div>
<div class="modal" id="edit-chip-modal">
  <h3>Edit Entry</h3>
  <p id="edit-chip-info"></p>
  <input type="number" id="edit-chip-value" step="0.01" placeholder="New valueâ€¦"/>
  <div class="modal-buttons">
    <button id="edit-chip-save">Save</button>
    <button id="edit-chip-delete" class="danger">Delete</button>
    <button id="edit-chip-cancel">Cancel</button>
  </div>
</div>

<!-- Account Menu Modal -->
<div class="modal-backdrop" id="account-menu-modal-backdrop"></div>
<div class="modal" id="account-menu-modal">
  <h3 id="account-menu-title">Account Options</h3>
  <div class="modal-buttons" style="flex-direction: column; align-items: stretch;">
    <button id="account-menu-edit">Edit Properties</button>
    <button id="account-menu-type">Change Type</button>
    <button id="account-menu-cancel">Cancel</button>
  </div>
</div>

<!-- Edit Account Modal -->
<div class="modal-backdrop" id="edit-account-modal-backdrop"></div>
<div class="modal" id="edit-account-modal">
  <h3>Edit Account Properties</h3>
  <p style="margin-bottom: 0.5rem;">Account: <strong id="edit-account-name"></strong></p>
  
  <label style="display: block; margin-top: 1rem; margin-bottom: 0.3rem; font-size: 0.9rem;">Color (hex):</label>
  <input type="text" id="edit-account-color" placeholder="#4c8036" style="margin-bottom: 1rem;"/>
  
  <label style="display: block; margin-bottom: 0.3rem; font-size: 0.9rem;">Link URL:</label>
  <input type="text" id="edit-account-link" placeholder="https://example.com" style="margin-bottom: 1rem;"/>
  
  <label style="display: block; margin-bottom: 0.3rem; font-size: 0.9rem;">Credit Limit (if applicable):</label>
  <input type="number" id="edit-account-limit" placeholder="5000" step="100" style="margin-bottom: 1rem;"/>
  
  <div class="modal-buttons">
    <button id="edit-account-save">Save</button>
    <button id="edit-account-cancel">Cancel</button>
  </div>
</div>

<!-- Edit Type Modal -->
<div class="modal-backdrop" id="edit-type-modal-backdrop"></div>
<div class="modal" id="edit-type-modal">
  <h3>Change Account Type</h3>
  <p>Account: <strong id="edit-type-account-name"></strong></p>
  <p>Current Type: <span id="edit-type-current"></span></p>
  
  <label style="display: block; margin-bottom: 0.3rem; font-size: 0.9rem;">New Type:</label>
  <select id="edit-type-select" style="width: 100%; padding: 0.5rem; font-size: 1rem; border: 1px solid var(--c-input-border); border-radius: 6px; background: var(--c-input-bg); color: var(--c-fg); font-family: var(--font-current);">
    <option value="">-- Select Type --</option>
    <option value="cc">Credit Card (cc)</option>
    <option value="bank">Bank Account (bank)</option>
    <option value="investment">Investment (investment)</option>
    <option value="loan">Loan (loan)</option>
    <option value="asset">Asset (asset)</option>
    <option value="other">Other (other)</option>
  </select>
  
  <div class="modal-buttons" style="margin-top: 1.5rem;">
    <button id="edit-type-save">Save</button>
    <button id="edit-type-cancel">Cancel</button>
  </div>
</div>

<!-- Edit Score Modal -->
<div class="modal-backdrop" id="edit-score-modal-backdrop"></div>
<div class="modal" id="edit-score-modal">
  <h3>Edit Score</h3>
  <p>Enter a new score value (0-999):</p>
  <input type="number" id="edit-score-value" min="0" max="999" step="1" placeholder="750"/>
  <div class="modal-buttons">
    <button id="edit-score-save">Save</button>
    <button id="edit-score-cancel">Cancel</button>
  </div>
</div>

<script>
/* ============================================
    CONFIGURATION & STATE
   ============================================ */
const API_BASE = 'https://script.google.com/macros/s/AKfycby6yEu1oUCC7_fe5rjuiBlOgQQVt94FgxWhC7NiSSKS4EoT_snkGpqokTYvfvsjjPFk/exec';
const SHEET_ID = 'YOUR_SHEET_ID_HERE';
const ACCOUNT_TYPE_MAP = new Map();
const ACCOUNT_METADATA = new Map();
const MUTED_ACCOUNTS = new Set();
const TYPE_FILTERS = new Set();
const LONG_PRESS_DURATION = 600;

let SNAP = null;
let MODE = 'donut'; // Changed default to 'donut'
let TIMEFRAME = '7d';
let CHART_PAGE = 0;
let CHART_DATA_CACHE = {};
let IS_LOADING = false;
let LONG_PRESS_TIMER = null;
let CURRENT_FONT_INDEX = 2; // Start with Geologica (index 2)
let CURRENT_SCORE = 0;

// Updated font options - removed Inconsolata
const FONT_OPTIONS = [
  { name: 'System', value: 'system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif' },
  { name: 'Patrick Hand', value: '"Patrick Hand", cursive' },
  { name: 'Geologica', value: '"Geologica", system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif' }
];

/* ============================================
    UTILITY FUNCTIONS
   ============================================ */
function loadStateFromURL() {
  const params = new URLSearchParams(window.location.search);
  const storedFontIndex = localStorage.getItem('selectedFontIndex');
  if (storedFontIndex !== null) {
    CURRENT_FONT_INDEX = parseInt(storedFontIndex, 10);
    if (CURRENT_FONT_INDEX >= FONT_OPTIONS.length) {
      CURRENT_FONT_INDEX = 2; // Default to Geologica if out of bounds
    }
  }
  applyFont();
  
  const storedScore = localStorage.getItem('userScore');
  if (storedScore !== null) {
    CURRENT_SCORE = parseInt(storedScore, 10);
  }
}

function formatMoney(n) {
  const num = Number(n) || 0;
  const isNeg = num < 0;
  const abs = Math.abs(num);
  const fmt = abs.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 });
  return (isNeg ? 'âˆ’$' : '$') + fmt;
}

function signOf(v) {
  const n = Number(v) || 0;
  return n < 0 ? 'neg' : n > 0 ? 'pos' : '';
}

function hexToRgb(hex) {
  const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
  return result ? {
    r: parseInt(result[1], 16),
    g: parseInt(result[2], 16),
    b: parseInt(result[3], 16)
  } : null;
}

function normalizeHexColor(color) {
  if (!color || typeof color !== 'string') return null;
  let c = color.trim();
  if (!c.startsWith('#')) c = '#' + c;
  if (!/^#[0-9A-F]{6}$/i.test(c)) return null;
  return c;
}

function setLoading(show, message = 'Loadingâ€¦') {
  IS_LOADING = show;
  const el = document.getElementById('loading');
  if (show) {
    el.textContent = message;
    el.style.display = 'block';
  } else {
    el.style.display = 'none';
  }
}

function showToast(message, type = 'info') {
  const toast = document.getElementById('toast');
  toast.textContent = message;
  toast.className = 'toast ' + type;
  toast.classList.add('show');
  setTimeout(() => toast.classList.remove('show'), 3000);
}

function isAccountMuted(accountName) {
  return MUTED_ACCOUNTS.has(accountName);
}

function toggleAccountMute(accountName) {
  if (MUTED_ACCOUNTS.has(accountName)) {
    MUTED_ACCOUNTS.delete(accountName);
  } else {
    MUTED_ACCOUNTS.add(accountName);
  }
  localStorage.setItem('mutedAccounts', JSON.stringify([...MUTED_ACCOUNTS]));
  renderAccounts();
  renderChart();
  renderFinancialSummary();
}

function applyTypeFilter(type) {
  if (TYPE_FILTERS.has(type)) {
    TYPE_FILTERS.delete(type);
  } else {
    TYPE_FILTERS.add(type);
  }
  localStorage.setItem('typeFilters', JSON.stringify([...TYPE_FILTERS]));
  renderAccounts();
  renderChart();
  renderFinancialSummary();
}

function renderTypeFilters() {
  const container = document.getElementById('type-filters');
  container.innerHTML = '';
  
  const allTypes = new Set();
  if (SNAP && SNAP.accounts) {
    SNAP.accounts.forEach(a => {
      if (a.type) allTypes.add(a.type);
    });
  }
  
  const typeOrder = ['cc', 'bank', 'investment', 'loan', 'asset', 'other'];
  const sortedTypes = [...allTypes].sort((a, b) => {
    const aIdx = typeOrder.indexOf(a);
    const bIdx = typeOrder.indexOf(b);
    if (aIdx === -1 && bIdx === -1) return a.localeCompare(b);
    if (aIdx === -1) return 1;
    if (bIdx === -1) return -1;
    return aIdx - bIdx;
  });
  
  sortedTypes.forEach(type => {
    const chip = document.createElement('div');
    chip.className = 'type-chip';
    if (TYPE_FILTERS.has(type)) chip.classList.add('active');
    
    const typeLabels = {
      cc: 'Credit',
      bank: 'Bank',
      investment: 'Invest',
      loan: 'Loan',
      asset: 'Asset',
      other: 'Other'
    };
    chip.textContent = typeLabels[type] || type;
    
    chip.onclick = () => {
      applyTypeFilter(type);
      renderTypeFilters();
    };
    
    container.appendChild(chip);
  });
}

function filterAccountsByType(accounts) {
  if (TYPE_FILTERS.size === 0) return accounts;
  return accounts.filter(a => TYPE_FILTERS.has(a.type));
}

/* ============================================
    DARK MODE
   ============================================ */
function initDarkMode() {
  const toggle = document.getElementById('dark-mode-toggle');
  const isDark = localStorage.getItem('darkMode') === 'true';
  
  if (isDark) {
    document.documentElement.classList.add('dark-mode');
    toggle.textContent = 'â˜€ï¸';
  } else {
    document.documentElement.classList.remove('dark-mode');
    toggle.textContent = 'ðŸŒ™';
  }
  
  toggle.addEventListener('click', () => {
    const isDarkNow = document.documentElement.classList.contains('dark-mode');
    if (isDarkNow) {
      document.documentElement.classList.remove('dark-mode');
      localStorage.setItem('darkMode', 'false');
      toggle.textContent = 'ðŸŒ™';
    } else {
      document.documentElement.classList.add('dark-mode');
      localStorage.setItem('darkMode', 'true');
      toggle.textContent = 'â˜€ï¸';
    }
  });
}

/* ============================================
    FONT SWITCHER
   ============================================ */
function cycleFont(direction) {
  if (direction === 'next') {
    CURRENT_FONT_INDEX = (CURRENT_FONT_INDEX + 1) % FONT_OPTIONS.length;
  } else {
    CURRENT_FONT_INDEX = (CURRENT_FONT_INDEX - 1 + FONT_OPTIONS.length) % FONT_OPTIONS.length;
  }
  localStorage.setItem('selectedFontIndex', CURRENT_FONT_INDEX);
  applyFont();
}

function applyFont() {
  const font = FONT_OPTIONS[CURRENT_FONT_INDEX];
  document.documentElement.style.setProperty('--font-current', font.value);
  document.getElementById('font-name').textContent = font.name;
}

/* ============================================
    THEME INITIALIZATION
   ============================================ */
function initializeTheme() {
  const savedMuted = localStorage.getItem('mutedAccounts');
  if (savedMuted) {
    JSON.parse(savedMuted).forEach(acc => MUTED_ACCOUNTS.add(acc));
  }
  
  const savedFilters = localStorage.getItem('typeFilters');
  if (savedFilters) {
    JSON.parse(savedFilters).forEach(type => TYPE_FILTERS.add(type));
  }
}

/* ============================================
    SCORE FUNCTIONS
   ============================================ */
function renderScore() {
  const display = document.getElementById('score-display');
  display.textContent = String(CURRENT_SCORE).padStart(3, '0');
}

function showEditScoreModal() {
  document.getElementById('edit-score-value').value = CURRENT_SCORE;
  document.getElementById('edit-score-modal-backdrop').classList.add('show');
  document.getElementById('edit-score-modal').classList.add('show');
  
  const saveBtn = document.getElementById('edit-score-save');
  const cancelBtn = document.getElementById('edit-score-cancel');
  
  const saveFn = () => {
    const newScore = parseInt(document.getElementById('edit-score-value').value, 10);
    if (!isNaN(newScore) && newScore >= 0 && newScore <= 999) {
      CURRENT_SCORE = newScore;
      localStorage.setItem('userScore', CURRENT_SCORE);
      renderScore();
      hideEditScoreModal();
    } else {
      showToast('Please enter a valid score (0-999)', 'error');
    }
  };
  
  const cancelFn = () => hideEditScoreModal();
  
  saveBtn.onclick = saveFn;
  cancelBtn.onclick = cancelFn;
}

function hideEditScoreModal() {
  document.getElementById('edit-score-modal-backdrop').classList.remove('show');
  document.getElementById('edit-score-modal').classList.remove('show');
}

/* ============================================
    MODALS
   ============================================ */
function hideDeleteConfirm() {
  document.getElementById('delete-modal-backdrop').classList.remove('show');
  document.getElementById('delete-confirm').classList.remove('show');
}

function showEditChipModal(accountName, date, value, readableValue) {
  const info = document.getElementById('edit-chip-info');
  info.textContent = `Account: ${accountName}, Date: ${date}, Current: ${readableValue}`;
  
  const input = document.getElementById('edit-chip-value');
  input.value = value;
  
  document.getElementById('edit-chip-modal-backdrop').classList.add('show');
  document.getElementById('edit-chip-modal').classList.add('show');
  
  const saveBtn = document.getElementById('edit-chip-save');
  const deleteBtn = document.getElementById('edit-chip-delete');
  const cancelBtn = document.getElementById('edit-chip-cancel');
  
  saveBtn.onclick = async () => {
    const newValue = parseFloat(input.value);
    if (isNaN(newValue)) {
      showToast('Please enter a valid number', 'error');
      return;
    }
    await updateEntry(accountName, date, newValue);
    hideEditChipModal();
  };
  
  deleteBtn.onclick = () => {
    hideEditChipModal();
    confirmDelete(accountName, date, readableValue);
  };
  
  cancelBtn.onclick = hideEditChipModal;
}

function hideEditChipModal() {
  document.getElementById('edit-chip-modal-backdrop').classList.remove('show');
  document.getElementById('edit-chip-modal').classList.remove('show');
}

function confirmDelete(accountName, date, readableValue) {
  const text = `Delete entry for ${accountName} on ${date} (${readableValue})?`;
  document.getElementById('delete-confirm-text').textContent = text;
  
  document.getElementById('delete-modal-backdrop').classList.add('show');
  document.getElementById('delete-confirm').classList.add('show');
  
  const confirmBtn = document.getElementById('delete-btn-confirm');
  confirmBtn.onclick = async () => {
    await deleteEntry(accountName, date);
    hideDeleteConfirm();
  };
}

function showAccountMenu(accountName) {
  document.getElementById('account-menu-title').textContent = accountName;
  document.getElementById('account-menu-modal-backdrop').classList.add('show');
  document.getElementById('account-menu-modal').classList.add('show');
  
  const editBtn = document.getElementById('account-menu-edit');
  const typeBtn = document.getElementById('account-menu-type');
  const cancelBtn = document.getElementById('account-menu-cancel');
  
  editBtn.onclick = () => {
    hideAccountMenu();
    showEditAccountModal(accountName);
  };
  
  typeBtn.onclick = () => {
    hideAccountMenu();
    showEditTypeModal(accountName);
  };
  
  cancelBtn.onclick = hideAccountMenu;
}

function hideAccountMenu() {
  document.getElementById('account-menu-modal-backdrop').classList.remove('show');
  document.getElementById('account-menu-modal').classList.remove('show');
}

function showEditAccountModal(accountName) {
  document.getElementById('edit-account-name').textContent = accountName;
  
  const meta = ACCOUNT_METADATA.get(accountName) || {};
  document.getElementById('edit-account-color').value = meta.color || '';
  document.getElementById('edit-account-link').value = meta.link || '';
  document.getElementById('edit-account-limit').value = meta.limit || '';
  
  document.getElementById('edit-account-modal-backdrop').classList.add('show');
  document.getElementById('edit-account-modal').classList.add('show');
  
  const saveBtn = document.getElementById('edit-account-save');
  const cancelBtn = document.getElementById('edit-account-cancel');
  
  saveBtn.onclick = () => {
    const newMeta = {
      color: document.getElementById('edit-account-color').value.trim(),
      link: document.getElementById('edit-account-link').value.trim(),
      limit: parseFloat(document.getElementById('edit-account-limit').value) || 0
    };
    
    if (newMeta.color || newMeta.link || newMeta.limit) {
      ACCOUNT_METADATA.set(accountName, newMeta);
      localStorage.setItem('accountMetadata', JSON.stringify([...ACCOUNT_METADATA]));
    } else {
      ACCOUNT_METADATA.delete(accountName);
      localStorage.setItem('accountMetadata', JSON.stringify([...ACCOUNT_METADATA]));
    }
    
    renderAccounts();
    hideEditAccountModal();
  };
  
  cancelBtn.onclick = hideEditAccountModal;
}

function hideEditAccountModal() {
  document.getElementById('edit-account-modal-backdrop').classList.remove('show');
  document.getElementById('edit-account-modal').classList.remove('show');
}

function showEditTypeModal(accountName) {
  document.getElementById('edit-type-account-name').textContent = accountName;
  
  const account = SNAP.accounts.find(a => a.name === accountName);
  const currentType = account ? account.type : 'unknown';
  document.getElementById('edit-type-current').textContent = currentType;
  
  document.getElementById('edit-type-select').value = '';
  
  document.getElementById('edit-type-modal-backdrop').classList.add('show');
  document.getElementById('edit-type-modal').classList.add('show');
  
  const saveBtn = document.getElementById('edit-type-save');
  const cancelBtn = document.getElementById('edit-type-cancel');
  
  saveBtn.onclick = async () => {
    const newType = document.getElementById('edit-type-select').value;
    if (!newType) {
      showToast('Please select a type', 'error');
      return;
    }
    await updateAccountType(accountName, newType);
    hideEditTypeModal();
  };
  
  cancelBtn.onclick = hideEditTypeModal;
}

function hideEditTypeModal() {
  document.getElementById('edit-type-modal-backdrop').classList.remove('show');
  document.getElementById('edit-type-modal').classList.remove('show');
}

/* ============================================
    API CALLS
   ============================================ */
async function fetchSnapshot() {
  if (IS_LOADING) return;
  setLoading(true, 'Fetching dataâ€¦');
  
  try {
    const params = new URLSearchParams({ timeframe: TIMEFRAME });
    const res = await fetch(`${API_BASE}?${params}`);
    const text = await res.text();
    const j = JSON.parse(text);
    
    if (!j.ok) throw new Error(j.error || 'Failed to load data');
    
    SNAP = j.data;
    CHART_PAGE = 0;
    CHART_DATA_CACHE = {};
    
    if (SNAP.accounts) {
      SNAP.accounts.forEach(a => {
        if (a.type) ACCOUNT_TYPE_MAP.set(a.name, a.type);
      });
    }
    
    const savedMeta = localStorage.getItem('accountMetadata');
    if (savedMeta) {
      JSON.parse(savedMeta).forEach(([name, meta]) => {
        ACCOUNT_METADATA.set(name, meta);
      });
    }
    
    renderAccounts();
    renderChart();
    renderFinancialSummary();
    renderTypeFilters();
  } catch (e) {
    console.error(e);
    showToast('Failed to load data', 'error');
  } finally {
    setLoading(false);
  }
}

async function deleteEntry(accountName, date) {
  if (IS_LOADING) return;
  setLoading(true, 'Deletingâ€¦');
  
  try {
    const body = new URLSearchParams({
      route: 'delete',
      payload: JSON.stringify({ account: accountName, date })
    });
    
    const res = await fetch(API_BASE, { method: 'POST', body });
    const text = await res.text();
    const j = JSON.parse(text);
    
    if (!j.ok) throw new Error(j.error || 'Delete failed');
    
    showToast('Entry deleted', 'success');
    await fetchSnapshot();
  } catch (e) {
    console.error(e);
    showToast('Delete failed', 'error');
  } finally {
    setLoading(false);
  }
}

async function updateEntry(accountName, date, newValue) {
  if (IS_LOADING) return;
  setLoading(true, 'Updatingâ€¦');
  
  try {
    const body = new URLSearchParams({
      route: 'update',
      payload: JSON.stringify({ account: accountName, date, value: newValue })
    });
    
    const res = await fetch(API_BASE, { method: 'POST', body });
    const text = await res.text();
    const j = JSON.parse(text);
    
    if (!j.ok) throw new Error(j.error || 'Update failed');
    
    showToast('Entry updated', 'success');
    await fetchSnapshot();
  } catch (e) {
    console.error(e);
    showToast('Update failed', 'error');
  } finally {
    setLoading(false);
  }
}

async function updateAccountType(accountName, newType) {
  if (IS_LOADING) return;
  setLoading(true, 'Updating typeâ€¦');
  
  try {
    const body = new URLSearchParams({
      route: 'updateType',
      payload: JSON.stringify({ account: accountName, type: newType })
    });
    
    const res = await fetch(API_BASE, { method: 'POST', body });
    const text = await res.text();
    const j = JSON.parse(text);
    
    if (!j.ok) throw new Error(j.error || 'Update failed');
    
    showToast('Account type updated', 'success');
    await fetchSnapshot();
  } catch (e) {
    console.error(e);
    showToast('Type update failed', 'error');
  } finally {
    setLoading(false);
  }
}

/* ============================================
    FINANCIAL SUMMARY
   ============================================ */
function renderFinancialSummary() {
  const summary = document.getElementById('financial-summary');
  const interestSummary = document.getElementById('interest-summary');
  if (!SNAP || !SNAP.totals) {
    summary.innerHTML = '';
    interestSummary.innerHTML = '';
    return;
  }
  
  const lastIdx = SNAP.dateAxis.length - 1;
  const totalAssets = Number(SNAP.totals.assets?.[lastIdx]) || 0;
  const totalDebts = Number(SNAP.totals.debts?.[lastIdx]) || 0;
  const net = totalAssets + totalDebts;
  
  const filteredAccounts = filterAccountsByType(SNAP.accounts);
  const mutedFilteredAccounts = filteredAccounts.filter(a => !isAccountMuted(a.name));
  
  let filteredAssets = 0, filteredDebts = 0;
  mutedFilteredAccounts.forEach(a => {
    const s = SNAP.series[a.name] || {};
    const last = s?.last ?? 0;
    if (last >= 0) filteredAssets += last;
    else filteredDebts += last;
  });
  
  const displayAssets = TYPE_FILTERS.size > 0 || MUTED_ACCOUNTS.size > 0 ? filteredAssets : totalAssets;
  const displayDebts = TYPE_FILTERS.size > 0 || MUTED_ACCOUNTS.size > 0 ? filteredDebts : totalDebts;
  const displayNet = displayAssets + displayDebts;
  
  const parts = [];
  if (Math.abs(displayDebts) > 0.01) {
    parts.push(`<span class="summary-debt">${formatMoney(displayDebts)}</span>`);
  }
  if (Math.abs(displayAssets) > 0.01) {
    parts.push(`<span class="summary-asset">+${formatMoney(displayAssets)}</span>`);
  }
  
  const totalClass = displayNet >= 0 ? 'summary-asset' : 'summary-debt';
  const summaryHTML = parts.length > 0 
    ? parts.join(' ') + ` = <span class="${totalClass} bold-value">${formatMoney(displayNet)}</span>`
    : `<span class="${totalClass} bold-value">${formatMoney(displayNet)}</span>`;
  
  summary.innerHTML = summaryHTML;
  
  let totalInterestEarned = 0, totalInterestCost = 0;
  mutedFilteredAccounts.forEach(a => {
    const s = SNAP.series[a.name] || {};
    const last = s?.last ?? 0;
    const apr = a.apr || 0;
    
    if (apr > 0 && last !== 0) {
      const dailyRate = (last * apr) / 365;
      let periodInterest = 0;
      
      switch (TIMEFRAME) {
        case 'today': periodInterest = dailyRate * 1; break;
        case '7d': periodInterest = dailyRate * 7; break;
        case '14d': periodInterest = dailyRate * 14; break;
        case '30d': periodInterest = dailyRate * 30; break;
        case '90d': periodInterest = dailyRate * 90; break;
        case '1y': case 'ytd': case 'all': periodInterest = last * apr; break;
      }
      
      if (periodInterest > 0) totalInterestEarned += periodInterest;
      else totalInterestCost += Math.abs(periodInterest);
    }
  });
  
  const interestParts = [];
  if (totalInterestEarned > 0.01) {
    interestParts.push(`<span class="interest-earned">+${formatMoney(totalInterestEarned)}</span>`);
  }
  if (totalInterestCost > 0.01) {
    interestParts.push(`<span class="interest-cost">âˆ’${formatMoney(totalInterestCost)}</span>`);
  }
  
  if (interestParts.length > 0) {
    const periodLabel = {
      'today': '/day',
      '7d': '/week',
      '14d': '/2 weeks',
      '30d': '/month',
      '90d': '/quarter',
      '1y': '/year',
      'ytd': '/year',
      'all': '/year'
    }[TIMEFRAME] || '';
    
    interestSummary.innerHTML = `Interest${periodLabel}: ${interestParts.join(' ')}`;
  } else {
    interestSummary.innerHTML = '';
  }
}

/* ============================================
    CHARTS
   ============================================ */
function renderChart() {
  if (!SNAP || !google?.charts) return;
  const filteredAccounts = filterAccountsByType(SNAP.accounts);
  const activeAccounts = filteredAccounts.filter(a => !isAccountMuted(a.name));
  
  const cacheKey = `${MODE}_${CHART_PAGE}_${[...TYPE_FILTERS].sort().join(',')}_${[...MUTED_ACCOUNTS].sort().join(',')}`;
  
  if (CHART_DATA_CACHE[cacheKey]) {
    const { data, options } = CHART_DATA_CACHE[cacheKey];
    drawChart(data, options);
  } else {
    const { data, options } = prepareChartData(activeAccounts);
    CHART_DATA_CACHE[cacheKey] = { data, options };
    drawChart(data, options);
  }
  
  updateChartPager(activeAccounts);
}

function prepareChartData(activeAccounts) {
  if (MODE === 'donut') {
    return prepareDonutData(activeAccounts);
  } else {
    return prepareTimeSeriesData(activeAccounts);
  }
}

function prepareDonutData(activeAccounts) {
  const lastIdx = SNAP.dateAxis.length - 1;
  const rows = [];
  
  activeAccounts.forEach(a => {
    const s = SNAP.series[a.name] || {};
    const last = s?.last ?? 0;
    
    if (Math.abs(last) > 0.01) {
      rows.push([a.name, Math.abs(last)]);
    }
  });
  
  rows.sort((a, b) => b[1] - a[1]);
  const top10 = rows.slice(0, 10);
  const others = rows.slice(10);
  
  if (others.length > 0) {
    const othersSum = others.reduce((sum, row) => sum + row[1], 0);
    top10.push(['Others', othersSum]);
  }
  
  const data = google.visualization.arrayToDataTable([
    ['Account', 'Value'],
    ...top10
  ]);
  
  const isDark = document.documentElement.classList.contains('dark-mode');
  const options = {
    pieHole: 0.4,
    backgroundColor: 'transparent',
    chartArea: { width: '90%', height: '80%' },
    legend: {
      position: 'bottom',
      textStyle: { color: isDark ? '#e0e0e0' : '#000000', fontSize: 12 }
    },
    pieSliceTextStyle: { fontSize: 11 },
    tooltip: { textStyle: { fontSize: 12 } },
    slices: {}
  };
  
  activeAccounts.forEach((a, i) => {
    const meta = ACCOUNT_METADATA.get(a.name) || {};
    const color = normalizeHexColor(meta.color || a.color);
    if (color && i < 10) {
      options.slices[i] = { color };
    }
  });
  
  return { data, options };
}

function prepareTimeSeriesData(activeAccounts) {
  const ITEMS_PER_PAGE = 6;
  const start = CHART_PAGE * ITEMS_PER_PAGE;
  const end = start + ITEMS_PER_PAGE;
  const pageAccounts = activeAccounts.slice(start, end);
  
  const headers = ['Date', ...pageAccounts.map(a => a.name)];
  const rows = [];
  
  SNAP.dateAxis.forEach((date, i) => {
    const row = [date];
    pageAccounts.forEach(a => {
      const series = SNAP.series[a.name];
      const val = series?.values?.[i] ?? null;
      row.push(val);
    });
    rows.push(row);
  });
  
  const data = google.visualization.arrayToDataTable([headers, ...rows]);
  
  const isDark = document.documentElement.classList.contains('dark-mode');
  const options = {
    backgroundColor: 'transparent',
    chartArea: { width: '85%', height: '70%' },
    legend: {
      position: 'bottom',
      textStyle: { color: isDark ? '#e0e0e0' : '#000000', fontSize: 11 }
    },
    hAxis: {
      textStyle: { color: isDark ? '#b0b0b0' : '#666666', fontSize: 10 },
      gridlines: { color: isDark ? '#404040' : '#e0e0e0' }
    },
    vAxis: {
      format: 'short',
      textStyle: { color: isDark ? '#b0b0b0' : '#666666', fontSize: 10 },
      gridlines: { color: isDark ? '#404040' : '#e0e0e0' }
    },
    interpolateNulls: true,
    lineWidth: 2,
    pointSize: 3,
    series: {},
    isStacked: MODE === 'area',
    areaOpacity: MODE === 'area' ? 0.7 : 0
  };
  
  pageAccounts.forEach((a, i) => {
    const meta = ACCOUNT_METADATA.get(a.name) || {};
    const color = normalizeHexColor(meta.color || a.color);
    if (color) {
      options.series[i] = { color };
    }
  });
  
  return { data, options };
}

function drawChart(data, options) {
  const chartDiv = document.getElementById('chart');
  let chart;
  
  if (MODE === 'donut') {
    chart = new google.visualization.PieChart(chartDiv);
  } else if (MODE === 'area') {
    chart = new google.visualization.AreaChart(chartDiv);
  } else if (MODE === 'bar') {
    chart = new google.visualization.ColumnChart(chartDiv);
  } else {
    chart = new google.visualization.LineChart(chartDiv);
  }
  
  chart.draw(data, options);
}

function updateChartPager(activeAccounts) {
  const pager = document.getElementById('chart-pager');
  pager.innerHTML = '';
  
  if (MODE === 'donut') return;
  
  const ITEMS_PER_PAGE = 6;
  const totalPages = Math.ceil(activeAccounts.length / ITEMS_PER_PAGE);
  
  if (totalPages <= 1) return;
  
  for (let i = 0; i < totalPages; i++) {
    const btn = document.createElement('button');
    btn.textContent = `Page ${i + 1}`;
    if (i === CHART_PAGE) btn.style.fontWeight = 'bold';
    btn.onclick = () => {
      CHART_PAGE = i;
      renderChart();
    };
    pager.appendChild(btn);
  }
}

/* ============================================
    ACCOUNTS RENDERING
   ============================================ */
function getLimitColor(balance, limit) {
  const utilization = Math.abs(balance) / limit;
  if (utilization <= 0.3) return 'var(--c-pos)';
  if (utilization >= 1.0) return 'var(--c-overlimit)';
  
  const startHex = getComputedStyle(document.documentElement).getPropertyValue('--c-pos').trim();
  const endHex = getComputedStyle(document.documentElement).getPropertyValue('--c-overlimit').trim();
  
  const startColor = hexToRgb(startHex) || { r: 76, g: 128, b: 54 };
  const endColor = hexToRgb(endHex) || { r: 216, g: 81, b: 64 };
  
  const r = Math.round(startColor.r + (endColor.r - startColor.r) * utilization);
  const g = Math.round(startColor.g + (endColor.g - startColor.g) * utilization);
  const b = Math.round(startColor.b + (endColor.b - startColor.b) * utilization);
  return `rgb(${r}, ${g}, ${b})`;
}

function renderAccounts() {
  const root = document.getElementById('accounts');
  root.innerHTML = '';
  if (!SNAP || !SNAP.accounts) return;

  const filteredAccounts = filterAccountsByType(SNAP.accounts);
  
  filteredAccounts.forEach(a => {
    const s = SNAP.series[a.name] || {};
    const last = s?.last ?? 0;
    const row = document.createElement('div'); row.className = 'row';
    const left = document.createElement('div'); left.className = 'left';
    const right = document.createElement('div'); right.className = 'right';
    const accountDetails = document.createElement('div'); accountDetails.className = 'account-details';
    
    const identityWrap = document.createElement('div');
    identityWrap.style.cssText = 'display:flex; align-items:baseline; gap:10px; flex-wrap:nowrap; min-width:0';
    
    const lastEl = document.createElement('span'); lastEl.className = 'lastval'; lastEl.textContent = formatMoney(last); lastEl.dataset.sign = signOf(last);
    const nameEl = document.createElement('span'); nameEl.className = 'name'; nameEl.textContent = a.name;
    
    const meta = ACCOUNT_METADATA.get(a.name) || {};
    const effectiveColor = meta.color || a.color;
    if (effectiveColor) { const norm = normalizeHexColor(effectiveColor); if (norm) nameEl.style.color = norm; }
    
    if (meta.link) {
      nameEl.style.textDecoration = 'underline'; nameEl.style.textDecorationStyle = 'dotted'; nameEl.title = 'Open account link';
      nameEl.onclick = () => { if (LONG_PRESS_TIMER) clearTimeout(LONG_PRESS_TIMER); window.open(meta.link, '_blank', 'noopener'); };
    }

    let pressStartTime = 0;
    const startLongPress = () => { pressStartTime = Date.now(); LONG_PRESS_TIMER = setTimeout(() => showAccountMenu(a.name), LONG_PRESS_DURATION); };
    const clearLongPress = () => { if (LONG_PRESS_TIMER) { clearTimeout(LONG_PRESS_TIMER); LONG_PRESS_TIMER = null; } };
    nameEl.onmousedown = nameEl.ontouchstart = startLongPress;
    nameEl.onmouseup = nameEl.onmouseleave = nameEl.ontouchend = clearLongPress;

    identityWrap.append(lastEl, nameEl);
    accountDetails.append(identityWrap);

    if (a.type === 'cc' && meta.limit) {
      const limitEl = document.createElement('span'); limitEl.className = 'limit';
      const limitValue = meta.limit;
      limitEl.style.color = getLimitColor(last, limitValue);
      limitEl.textContent = `$${limitValue.toLocaleString()}`;
      accountDetails.appendChild(limitEl);
    }

    const aprEl = document.createElement('span'); aprEl.className = 'apr';
    const apr = a.apr || 0;
    let interestAmount = 0, periodLabel = '';
    if (apr > 0 && last !== 0) {
      const dailyRate = (last * apr) / 365;
      switch (TIMEFRAME) {
        case 'today': interestAmount = dailyRate * 1; periodLabel = '/dy'; break;
        case '7d': interestAmount = dailyRate * 7; periodLabel = '/wk'; break;
        case '14d': interestAmount = dailyRate * 14; periodLabel = '/2w'; break;
        case '30d': interestAmount = dailyRate * 30; periodLabel = '/mo'; break;
        case '90d': interestAmount = dailyRate * 90; periodLabel = '/qt'; break;
        case '1y': case 'ytd': case 'all': interestAmount = last * apr; periodLabel = '/yr'; break;
      }
    }
    let aprHTML = `APR: ${(apr * 100).toFixed(2)}%`;
    if (Math.abs(interestAmount) >= 0.01) {
      const sign = interestAmount >= 0 ? '+' : '';
      const color = interestAmount >= 0 ? 'var(--c-pos)' : 'var(--c-neg)';
      aprHTML += `<br><span style="color: ${color}">${sign}${formatMoney(interestAmount)}${periodLabel}</span>`;
    }
    aprEl.innerHTML = aprHTML;
    accountDetails.appendChild(aprEl);

    const inputLine = document.createElement('div'); inputLine.className = 'input-line';
    const inp = document.createElement('input'); inp.type = 'number'; inp.placeholder = 'Add valueâ€¦'; inp.step = '0.01'; inp.dataset.accountName = a.name;
    if (last > 0) inp.style.backgroundColor = 'var(--c-tint-pos)';
    else if (last < 0) inp.style.backgroundColor = 'var(--c-tint-neg)';
    else inp.style.backgroundColor = 'var(--c-input-bg)';
    inp.onkeydown = async (ev) => { if (ev.key === 'Enter') await submitEntries([{ account: a.name, value: inp.value, inputEl: inp }]); };

    const muteWrapper = document.createElement('label'); muteWrapper.className = 'mute-checkbox';
    const muteCheck = document.createElement('input'); muteCheck.type = 'checkbox'; muteCheck.checked = !isAccountMuted(a.name);
    muteCheck.onchange = () => toggleAccountMute(a.name);
    const muteSlider = document.createElement('span'); muteSlider.className = 'mute-checkbox-slider';
    muteWrapper.append(muteCheck, muteSlider);
    inputLine.append(inp, muteWrapper);
    left.append(accountDetails, inputLine);

    if (isAccountMuted(a.name)) row.classList.add('muted');

    const vals = document.createElement('div'); vals.className = 'values';
    (s.lastN || []).forEach(v => {
      const isObject = (typeof v === 'object' && v !== null && v.value !== undefined);
      const val = Number(isObject ? v.value : v);
      const date = isObject ? v.date : null;
      const readableValue = formatMoney(val);
      const chip = document.createElement('span'); chip.className = 'chip'; chip.dataset.sign = signOf(val); chip.textContent = readableValue;
      if (date) chip.onclick = () => showEditChipModal(a.name, date, val, readableValue);
      else { chip.classList.add('no-delete'); chip.title = "Old data format"; }
      vals.appendChild(chip);
    });
    right.appendChild(vals);

    const bar = document.createElement('h4'); bar.className = 'ratio-bar';
    const assetSpan = document.createElement('span'); assetSpan.style.color = 'var(--c-pos)';
    const debtSpan = document.createElement('span'); debtSpan.style.color = 'var(--c-neg)';
    const lastIndex = SNAP.dateAxis.length - 1;
    const totalAssets = Number(SNAP.totals.assets?.[lastIndex]) || 0;
    const totalDebts = Math.abs(Number(SNAP.totals.debts?.[lastIndex]) || 0);

    if (last >= 0 && totalAssets > 0) {
      const blocks = Math.round((last / totalAssets) * 10);
      if (blocks >= 1) assetSpan.textContent = 'â–ˆ '.repeat(blocks);
    } else if (last < 0 && totalDebts > 0) {
      const blocks = Math.round((Math.abs(last) / totalDebts) * 10);
      if (blocks >= 1) debtSpan.textContent = 'â–ˆ '.repeat(blocks);
    }
    bar.append(assetSpan, debtSpan);
    right.appendChild(bar);

    row.append(left, right);
    root.appendChild(row);
  });
}

/* ============================================
  SUBMISSION - MODIFIED TO REFRESH PAGE
 ============================================ */
async function submitAll() {
  const entries = [];
  document.querySelectorAll('.row .left input[type="number"]').forEach(inp => {
    const v = inp.value.trim();
    if (v !== '') entries.push({ account: inp.dataset.accountName, value: Number(v), inputEl: inp });
  });
  if (entries.length === 0) { showToast('No values entered.', 'info'); return; }
  await submitEntries(entries);
}

async function submitEntries(entries) {
  if (IS_LOADING) return;
  setLoading(true, 'Submittingâ€¦');
  entries.forEach(e => e.inputEl?.classList.add('submitting'));

  try {
    const validEntries = entries.filter(e => e.account && !isNaN(e.value));
    if (validEntries.length === 0) throw new Error('No valid entries');

    const body = new URLSearchParams({ payload: JSON.stringify({ entries: validEntries }) });
    const res = await fetch(`${API_BASE}?route=submit`, { method: 'POST', body });
    const text = await res.text();
    const j = JSON.parse(text);
    if (!j.ok) throw new Error(j.error || 'Unknown error');

    showToast('Saved!', 'success');
    entries.forEach(e => {
      e.inputEl?.classList.add('submitted-ok');
      e.inputEl.value = '';
    });
    
    // Refresh the page after a short delay to show the success animation
    setTimeout(() => {
      window.location.reload();
    }, 800);
    
  } catch (e) {
    console.error(e);
    showToast('Submit failed', 'error');
    entries.forEach(e => e.inputEl?.classList.remove('submitting'));
    setLoading(false);
  }
}

/* ============================================
  INITIALIZATION
 ============================================ */
document.addEventListener('DOMContentLoaded', () => {
  loadStateFromURL();
  initializeTheme();
  initDarkMode();

  const sheetLink = document.querySelector('footer a[href*="spreadsheets"]');
  if (sheetLink && SHEET_ID && SHEET_ID !== 'YOUR_SHEET_ID_HERE') {
    sheetLink.href = `https://docs.google.com/spreadsheets/d/${SHEET_ID}`;
  }

  document.getElementById('refresh').addEventListener('click', fetchSnapshot);
  document.getElementById('submitAll').addEventListener('click', submitAll);
  document.querySelectorAll('input[name="mode"]').forEach(r => {
    r.addEventListener('change', (e) => { MODE = e.target.value; renderChart(); });
  });
  document.getElementById('timeframe').addEventListener('change', (e) => { TIMEFRAME = e.target.value; fetchSnapshot(); });

  document.getElementById('delete-btn-cancel').addEventListener('click', hideDeleteConfirm);
  document.getElementById('delete-modal-backdrop').addEventListener('click', hideDeleteConfirm);
  document.getElementById('edit-chip-cancel').addEventListener('click', hideEditChipModal);
  document.getElementById('edit-chip-modal-backdrop').addEventListener('click', hideEditChipModal);
  document.getElementById('account-menu-cancel').addEventListener('click', hideAccountMenu);
  document.getElementById('account-menu-modal-backdrop').addEventListener('click', hideAccountMenu);
  document.getElementById('edit-account-cancel').addEventListener('click', hideEditAccountModal);
  document.getElementById('edit-account-modal-backdrop').addEventListener('click', hideEditAccountModal);
  document.getElementById('edit-type-cancel').addEventListener('click', hideEditTypeModal);
  document.getElementById('edit-type-modal-backdrop').addEventListener('click', hideEditTypeModal);
  document.getElementById('edit-score-cancel').addEventListener('click', hideEditScoreModal);
  document.getElementById('edit-score-modal-backdrop').addEventListener('click', hideEditScoreModal);

  // Font Switcher Event Listeners
  document.getElementById('font-prev').addEventListener('click', () => cycleFont('prev'));
  document.getElementById('font-next').addEventListener('click', () => cycleFont('next'));

  window.addEventListener('resize', renderChart);
  
  renderScore(); // Initial render (000)
  document.getElementById('score-display').addEventListener('click', showEditScoreModal);

  if (window.google && google.charts) {
    google.charts.load('current', { packages: ['corechart'] });
    google.charts.setOnLoadCallback(fetchSnapshot);
  } else {
    const s = document.createElement('script');
    s.src = 'https://www.gstatic.com/charts/loader.js';
    s.onload = () => { 
      google.charts.load('current', { packages: ['corechart'] });
      google.charts.setOnLoadCallback(fetchSnapshot);
    };
    document.head.appendChild(s);
  }
});
</script>
</body>
</html>
