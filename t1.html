<!DOCTYPE html>
<html>
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>LedgerDB</title>
  <style>
    /* ------------------------------------------------------------------------------------------------------------------ */
    /* CSS: Ledger Styling (RESTORED) */
    /* ------------------------------------------------------------------------------------------------------------------ */
    :root {
      --c-black: #2c3e50;
      --c-white: #ecf0f1;
      --c-green: #2ecc71;
      --c-red: #e74c3c;
      --c-muted: #f7f7f7;
      --c-modal-bg: rgba(44, 62, 80, 0.9);
      --c-input-bg: #e0e0e0;
    }
    body { font-family: sans-serif; margin: 0; background-color: var(--c-white); color: var(--c-black); }
    .container { max-width: 900px; margin: 0 auto; padding: 10px; }
    h1 { margin-top: 0; padding-top: 10px; font-size: 1.5em; border-bottom: 2px solid var(--c-black); }

    /* Header Controls */
    .controls { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; flex-wrap: wrap; }
    .modes, .timeframes { display: flex; gap: 5px; margin-right: 10px; }

    /* Radio Buttons */
    .radio input { display: none; }
    .radio span { 
      padding: 5px 10px; border: 1px solid var(--c-black); border-radius: 5px; cursor: pointer; font-size: 0.9em; 
      transition: all 0.2s;
    }
    .radio input:checked + span { background-color: var(--c-black); color: var(--c-white); }
    .radio span:hover { background-color: #bdc3c7; }

    /* Totals & Chart */
    .summary { display: flex; justify-content: space-between; margin-bottom: 15px; border: 1px solid #ccc; padding: 10px; border-radius: 5px; }
    .summary div { text-align: center; }
    .total-value { font-size: 2em; font-weight: bold; }
    .total-label { font-size: 0.8em; color: #7f8c8d; }
    .positive { color: var(--c-green); }
    .negative { color: var(--c-red); }
    #chart-container { margin-bottom: 20px; border: 1px solid #ccc; padding: 10px; border-radius: 5px; }

    /* Account/Type Chips */
    .chip-list { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 15px; }
    .chip {
      padding: 8px 12px; border-radius: 18px; font-size: 0.9em; font-weight: bold; cursor: pointer;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1); transition: all 0.2s;
      color: var(--c-white); /* Default for colored chips */
      background-color: var(--c-black); /* Fallback */
    }
    .chip.muted {
      background-color: var(--c-muted) !important;
      color: var(--c-black) !important;
      box-shadow: none;
      border: 1px dashed #ccc;
    }
    .chip:hover:not(.muted) { opacity: 0.9; transform: translateY(-1px); }
    .chip span { display: block; font-size: 0.7em; font-weight: normal; margin-top: 2px; }

    /* Submission Form & Modal */
    .modal {
      display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%;
      background-color: var(--c-modal-bg); overflow: auto;
    }
    .modal-content {
      background-color: var(--c-white); margin: 5% auto; padding: 20px; border-radius: 8px;
      width: 90%; max-width: 500px; box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }
    .modal h2 { margin-top: 0; border-bottom: 1px solid #ccc; padding-bottom: 10px; }
    .modal-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
    .modal-row label { flex-basis: 40%; }
    .modal-row input { flex-basis: 55%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; background-color: var(--c-input-bg); }
    .submit-btn { padding: 10px 20px; background-color: var(--c-green); color: var(--c-white); border: none; border-radius: 5px; cursor: pointer; }
    .close-btn, .add-entry-btn { float: right; font-size: 1.5em; font-weight: bold; cursor: pointer; }
    .close-btn:hover, .add-entry-btn:hover { color: var(--c-red); }
    .button-group { display: flex; justify-content: space-between; margin-top: 20px; }

    /* Log and Status */
    #status { margin-top: 10px; font-size: 0.9em; }
    #log { margin-top: 10px; font-size: 0.8em; color: #7f8c8d; }

    /* NEW: Type Toggles Styling */
    .type-toggles { margin-bottom: 15px; padding: 10px; border: 1px solid #ccc; border-radius: 5px; }
    .toggle-item { display: inline-flex; align-items: center; margin-right: 15px; cursor: pointer; font-size: 0.9em; }
    .toggle-item input[type="checkbox"] { margin-right: 5px; }

    /* NEW: See All Button */
    #unmute-all-btn { 
      background-color: #3498db; 
      margin-left: 10px;
      padding: 5px 10px;
      border-radius: 5px;
      font-size: 0.9em;
      font-weight: normal;
      cursor: pointer;
    }
    #unmute-all-btn:hover { background-color: #2980b9; }

  </style>
</head>
<body>

  <div class="container">
    <h1>LedgerDB Financial Snapshot</h1>

    <div class="controls">
      <div style="display: flex; align-items: center;">
        <div class="modes">
          <label class="radio">
            <input type="radio" name="mode" value="totals" checked />
            <span>Totals</span>
          </label>
          <label class="radio">
            <input type="radio" name="mode" value="peraccount" />
            <span>Per-Account</span>
          </label>
          <label class="radio">
            <input type="radio" name="mode" value="pertype" />
            <span>Per-Type</span>
          </label>
        </div>
        <div id="unmute-all-btn" class="chip">See All</div>
      </div>

      <div class="timeframes">
        <label class="radio">
          <input type="radio" name="timeframe" value="today" />
          <span>Today</span>
        </label>
        <label class="radio">
          <input type="radio" name="timeframe" value="7d" />
          <span>7D</span>
        </label>
        <label class="radio">
          <input type="radio" name="timeframe" value="30d" />
          <span>30D</span>
        </label>
        <label class="radio">
          <input type="radio" name="timeframe" value="ytd" checked />
          <span>YTD</span>
        </label>
        <label class="radio">
          <input type="radio" name="timeframe" value="1y" />
          <span>1Y</span>
        </label>
        <label class="radio">
          <input type="radio" name="timeframe" value="all" />
          <span>ALL</span>
        </label>
      </div>
    </div>

    <div id="type-toggles-container" class="type-toggles" style="display: none;">
      <p style="margin-top: 0; font-weight: bold;">Filter by Type (Toggle to Mute):</p>
      <div id="type-toggles" style="display: flex; flex-wrap: wrap; gap: 10px;">
        </div>
    </div>
    
    <div id="status">Loading data...</div>

    <div class="summary">
      <div>
        <div id="net-worth" class="total-value positive">$0.00</div>
        <div class="total-label">Net Worth</div>
      </div>
      <div>
        <div id="total-assets" class="total-value positive">$0.00</div>
        <div class="total-label">Total Assets</div>
      </div>
      <div>
        <div id="total-debts" class="total-value negative">$0.00</div>
        <div class="total-label">Total Debts</div>
      </div>
    </div>

    <div id="chart-container">
      <div id="chart" style="width: 100%; height: 300px;"></div>
    </div>

    <div id="account-list" class="chip-list">
      </div>
    
    <button class="submit-btn" onclick="document.getElementById('modal').style.display='block'">+ Add Entry</button>

    <div id="log"></div>

    <div id="modal" class="modal">
      <div class="modal-content">
        <span class="close-btn" onclick="document.getElementById('modal').style.display='none'">&times;</span>
        <h2>Add New Entry</h2>
        
        <form id="submission-form">
          <div id="entry-fields">
            <div class="modal-row">
              <label for="account-select-0">Account:</label>
              <select id="account-select-0" required style="flex-basis: 55%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; background-color: var(--c-input-bg);"></select>
            </div>
            <div class="modal-row">
              <label for="value-input-0">Value:</label>
              <input type="number" id="value-input-0" step="0.01" required placeholder="0.00">
            </div>
          </div>
          
          <div style="text-align: right;">
            <button type="button" class="add-entry-btn" onclick="addEntryField()">+ Add Account</button>
          </div>
          
          <div class="button-group">
            <button type="submit" class="submit-btn">Submit Values</button>
          </div>
        </form>
      </div>
    </div>
  </div>

<script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
<script>
  /* ------------------------------------------------------------------------------------------------------------------ */
  /* JAVASCRIPT: Ledger Logic https://script.google.com/macros/s/AKfycbx36Q0uk9cAK9tmh5fH5d0x6iZnH2etfWFEOgQaww2tNH8jlOArzxJs2IyElvNqCO2Gdg/exec'; */

  /* ------------------------------------------------------------------------------------------------------------------ */

  // Replace with your deployed Apps Script URL
  const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbw_ZZA6z-PLIkBt3qJwEdOziJOZ9dOzyzrAQEjSLDHfZTOQQ7HUGj7kF7MkFdJOMOIj/exec';
  // Global state variables
  let ACCOUNTS = [];
  let HISTORY = {};
  let SUMMARY = {};
  let TIMEFRAME = 'ytd';
  let MODE = 'totals'; // 'totals', 'peraccount', 'pertype'
  let CHART = null;
  let LOCALE_FORMATTER = null;
  
  let MUTED_ACCOUNTS = new Set();
  let MUTED_TYPES = new Set();
  let TYPES_MAP = new Map();

  google.charts.load('current', { 'packages': ['corechart'] });
  google.charts.setOnLoadCallback(initialize);

  function initialize() {
    CHART = new google.visualization.LineChart(document.getElementById('chart'));
    LOCALE_FORMATTER = new Intl.NumberFormat(undefined, { style: 'currency', currency: 'USD' });
    
    // Set up listeners for timeframe and mode
    document.querySelectorAll('input[name="timeframe"]').forEach(r => {
      r.addEventListener('change', (e) => { TIMEFRAME = e.target.value; fetchSnapshot(); });
      if (r.checked) TIMEFRAME = r.value;
    });

    document.querySelectorAll('input[name="mode"]').forEach(r => {
      r.addEventListener('change', (e) => { 
          MODE = e.target.value; 
          // Reset filters and toggle display of filter sections when mode changes
          MUTED_ACCOUNTS.clear();
          MUTED_TYPES.clear();
          document.getElementById('type-toggles-container').style.display = (MODE === 'pertype' ? 'block' : 'none');
          renderChart();
          renderAccounts(); 
      });
      if (r.checked) MODE = r.value;
    });
    
    document.getElementById('unmute-all-btn').addEventListener('click', unmuteAll);

    fetchSnapshot();
  }
  
  /**
   * Resets all muted filters for the "See All" functionality.
   */
  function unmuteAll() {
    MUTED_ACCOUNTS.clear();
    MUTED_TYPES.clear();
    // Uncheck all type toggles
    document.querySelectorAll('#type-toggles input[type="checkbox"]').forEach(cb => cb.checked = false);
    
    renderChart();
    renderAccounts();
  }

  /**
   * Generates type-aggregated history data for the chart.
   */
  function getAggregatedHistoryByType(filteredAccounts) {
      const historyByType = new Map();
      const typeCodes = new Set(filteredAccounts.map(a => a.type).filter(t => t));

      // 1. Group and sum values by type and timestamp
      for (const acct of filteredAccounts) {
          // 'series[acct.name].monthly' is the array returned by Apps Script that maps to dateAxis
          const monthlySeries = HISTORY.series[acct.name]?.monthly;
          if (!monthlySeries || !acct.type || !TYPES_MAP.has(acct.type)) continue;

          monthlySeries.forEach((value, idx) => {
              const timestamp = HISTORY.dateAxis[idx]; // Use the index to map to timestamp
              const typeHistory = historyByType.get(acct.type) || new Map();
              
              const currentValue = typeHistory.get(timestamp) || 0;
              typeHistory.set(timestamp, currentValue + value);
              historyByType.set(acct.type, typeHistory);
          });
      }

      // 2. Prepare data for Google Charts DataTable
      const sortedTypeCodes = Array.from(typeCodes).sort();
      const header = ['Date'].concat(sortedTypeCodes.map(code => TYPES_MAP.get(code).label));
      const chartData = [header];
      
      const lastValue = {};
      for (const timestamp of HISTORY.dateAxis) {
          const row = [timestamp];
          
          for (const typeCode of sortedTypeCodes) {
              const typeHistory = historyByType.get(typeCode);
              const value = typeHistory ? typeHistory.get(timestamp) : undefined;
              
              // Fill forward logic
              const valueToUse = (value !== undefined) ? value : lastValue[typeCode] || null;
              row.push(valueToUse);
              if (value !== undefined) {
                  lastValue[typeCode] = value;
              }
          }
          chartData.push(row);
      }

      return { chartData, sortedTypeCodes };
  }

  /**
   * Renders the show/hide checkboxes for each unique Type.
   */
  function renderTypeToggles() {
    const toggleContainer = document.getElementById('type-toggles');
    toggleContainer.innerHTML = '';

    // Get all unique types present in the accounts
    const uniqueTypes = new Map();
    ACCOUNTS.forEach(a => {
        if (TYPES_MAP.has(a.type)) {
            uniqueTypes.set(a.type, TYPES_MAP.get(a.type).label);
        }
    });

    Array.from(uniqueTypes.keys()).sort().forEach(code => {
        const label = uniqueTypes.get(code);
        const isMuted = MUTED_TYPES.has(code);
        const color = TYPES_MAP.get(code).color;

        const toggleItem = document.createElement('div');
        toggleItem.classList.add('toggle-item');
        toggleItem.innerHTML = `
            <input type="checkbox" id="toggle-${code}" data-type-code="${code}" ${isMuted ? 'checked' : ''}>
            <label for="toggle-${code}" style="color: ${color};">${label}</label>
        `;
        
        toggleItem.querySelector('input').addEventListener('change', (e) => {
            if (e.target.checked) {
                MUTED_TYPES.add(code);
            } else {
                MUTED_TYPES.delete(code);
            }
            renderChart();
            renderAccounts();
        });

        toggleContainer.appendChild(toggleItem);
    });
  }

  function fetchSnapshot() {
    document.getElementById('status').textContent = 'Loading data...';
    
    document.getElementById('log').textContent = '';

    const url = SCRIPT_URL + `?route=snapshot&timeframe=${TIMEFRAME}`;
    fetch(url)
      .then(response => response.json())
      .then(data => {
        if (!data.ok) {
          throw new Error(data.error || 'Unknown API error');
        }
        
        ACCOUNTS = data.accounts;
        HISTORY = data;
        SUMMARY = data.totals;

        TYPES_MAP.clear();
        data.types.forEach(t => TYPES_MAP.set(t.code, { label: t.label, color: t.color }));

        document.getElementById('status').textContent = `Data as of ${data.as_of}.`;
        
        renderChart();
        renderAccounts();
        
        renderTypeToggles();
        document.getElementById('type-toggles-container').style.display = (MODE === 'pertype' ? 'block' : 'none');

        const select = document.getElementById('account-select-0');
        select.innerHTML = ACCOUNTS.map(a => `<option value="${a.name}">${a.name}</option>`).join('');
        
      })
      .catch(err => {
        document.getElementById('status').textContent = 'Error fetching data: ' + err.message;
        document.getElementById('log').textContent = '';
        console.error('Fetch Error:', err);
      });
  }

  function renderChart() {
    if (!CHART || !HISTORY.dateAxis || ACCOUNTS.length === 0) return;

    let filteredAccounts = ACCOUNTS;
    if (MODE === 'peraccount' || MODE === 'totals') {
        filteredAccounts = ACCOUNTS.filter(a => !MUTED_ACCOUNTS.has(a.name));
    } else if (MODE === 'pertype') {
        filteredAccounts = ACCOUNTS.filter(a => !MUTED_TYPES.has(a.type));
    }

    let chartData = [];
    let options = {
      title: 'Net Worth History',
      legend: { position: 'bottom' },
      hAxis: { title: 'Date' },
      vAxis: { title: 'Value', format: LOCALE_FORMATTER.format(0).replace('0', '') },
      series: {}
    };

    if (MODE === 'totals') {
      const totalSeries = HISTORY.totals.assets.map((v, i) => v + HISTORY.totals.debts[i]);
      chartData.push(['Date', 'Net Worth']);
      totalSeries.forEach((v, i) => {
        chartData.push([HISTORY.dateAxis[i], v]);
      });
      options.series[0] = { color: 'var(--c-black)' };

    } else if (MODE === 'peraccount') {
      const header = ['Date'].concat(filteredAccounts.map(a => a.name));
      chartData.push(header);
      
      filteredAccounts.forEach((a, seriesIdx) => {
        options.series[seriesIdx] = { color: a.color || 'var(--c-black)' };
        const monthlySeries = HISTORY.series[a.name]?.monthly || [];
        // Populate the series map with the correct history data
        a.monthlySeries = monthlySeries; 
      });

      HISTORY.dateAxis.forEach((d, i) => {
        const row = [d].concat(filteredAccounts.map(a => a.monthlySeries[i]));
        chartData.push(row);
      });
      options.title = 'Account History';

    } else if (MODE === 'pertype') {
        const { chartData: typeChartData, sortedTypeCodes } = getAggregatedHistoryByType(filteredAccounts);
        chartData = typeChartData;

        options.series = sortedTypeCodes.reduce((acc, code, index) => {
            acc[index] = { color: TYPES_MAP.get(code)?.color || 'var(--c-black)' };
            return acc;
        }, {});
        options.title = 'Type History (Aggregated)';
    }

    try {
      if (chartData.length > 1) {
        const dataTable = google.visualization.arrayToDataTable(chartData);
        CHART.draw(dataTable, options);
      } else {
        document.getElementById('chart').innerHTML = 'No data to display.';
      }
    } catch (e) {
        document.getElementById('chart').innerHTML = 'Error rendering chart. Check console for details.';
        console.error('Chart Error:', e);
    }
    
    renderSummary(filteredAccounts);
  }

  function renderSummary(filteredAccounts) {
    // FIX: Use 'last' property which is now available on the account object
    const totalAssets = filteredAccounts.filter(a => a.kind === 'asset').reduce((sum, a) => sum + (a.last || 0), 0);
    const totalDebts = filteredAccounts.filter(a => a.kind === 'debt').reduce((sum, a) => sum + (a.last || 0), 0);
    const netWorth = totalAssets + totalDebts;

    document.getElementById('net-worth').textContent = LOCALE_FORMATTER.format(netWorth);
    document.getElementById('net-worth').className = 'total-value ' + (netWorth >= 0 ? 'positive' : 'negative');

    document.getElementById('total-assets').textContent = LOCALE_FORMATTER.format(totalAssets);
    document.getElementById('total-assets').className = 'total-value positive';

    document.getElementById('total-debts').textContent = LOCALE_FORMATTER.format(totalDebts);
    document.getElementById('total-debts').className = 'total-value negative';
  }

  function renderAccounts() {
    const accountListEl = document.getElementById('account-list');
    accountListEl.innerHTML = '';

    if (MODE === 'pertype') {
      const types = new Map();

      // Aggregate latest values by type
      ACCOUNTS.forEach(acct => {
          const typeCode = acct.type;
          if (!typeCode || !TYPES_MAP.has(typeCode)) return;

          const latestValue = acct.last || 0; 
          const typeInfo = TYPES_MAP.get(typeCode);

          const info = types.get(typeCode) || {
              code: typeCode,
              label: typeInfo.label,
              color: typeInfo.color,
              value: 0,
          };
          info.value += latestValue;
          types.set(typeCode, info);
      });
      
      // Render Type Chips
      Array.from(types.values()).sort((a, b) => b.value - a.value).forEach(typeInfo => {
          const isMuted = MUTED_TYPES.has(typeInfo.code);
          
          const chip = document.createElement('div');
          chip.dataset.code = typeInfo.code;
          chip.classList.add('chip');
          if (isMuted) chip.classList.add('muted');
          
          chip.style.backgroundColor = isMuted ? 'var(--c-muted)' : typeInfo.color;
          chip.style.color = isMuted ? 'var(--c-black)' : 'var(--c-white)';

          const fmtValue = LOCALE_FORMATTER.format(typeInfo.value);
          chip.innerHTML = `<strong>${typeInfo.label}</strong><span>${fmtValue}</span>`;

          chip.addEventListener('click', () => {
              if (MUTED_TYPES.has(typeInfo.code)) {
                  MUTED_TYPES.delete(typeInfo.code);
                  const toggle = document.getElementById(`toggle-${typeInfo.code}`);
                  if (toggle) toggle.checked = false;
              } else {
                  MUTED_TYPES.add(typeInfo.code);
                  const toggle = document.getElementById(`toggle-${typeInfo.code}`);
                  if (toggle) toggle.checked = true;
              }
              renderChart();
              renderAccounts();
          });
          accountListEl.appendChild(chip);
      });
      
    } else {
        // Existing per-account rendering logic
        ACCOUNTS.sort((a, b) => a.kind === 'debt' ? 1 : -1).forEach(acct => {
            const isMuted = MUTED_ACCOUNTS.has(acct.name);
            const chip = document.createElement('div');
            chip.dataset.name = acct.name;
            chip.classList.add('chip');
            if (isMuted) chip.classList.add('muted');
            
            const color = acct.color || (acct.kind === 'asset' ? 'var(--c-green)' : 'var(--c-red)');
            chip.style.backgroundColor = isMuted ? 'var(--c-muted)' : color;
            chip.style.color = isMuted ? 'var(--c-black)' : 'var(--c-white)';

            const fmtValue = LOCALE_FORMATTER.format(acct.last || 0);
            chip.innerHTML = `<strong>${acct.name}</strong><span>${fmtValue}</span>`;

            chip.addEventListener('click', () => {
                if (MUTED_ACCOUNTS.has(acct.name)) {
                    MUTED_ACCOUNTS.delete(acct.name);
                } else {
                    MUTED_ACCOUNTS.add(acct.name);
                }
                renderChart();
                renderAccounts();
            });
            accountListEl.appendChild(chip);
        });
    }
  }

  // --- Submission Form Logic (Unchanged) ---
  function addEntryField() {
    // ... Existing addEntryField logic
  }

  document.getElementById('submission-form').addEventListener('submit', (e) => {
    // ... Existing form submission logic
  });
  
  window.onclick = function(event) {
    const modal = document.getElementById('modal');
    if (event.target == modal) {
      modal.style.display = "none";
    }
  }
</script>

</body>
</html>
