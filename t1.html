<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Ledger — Accounts &amp; Chart (v3.0 – Type View)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Google Charts -->
  <script src="https://www.gstatic.com/charts/loader.js"></script>

  <style>
    :root {
      --bg: #05060a;
      --fg: #f5f5f5;
      --accent: #8ace00;
      --muted: #888;
      --border: #2b2b35;
      --card: #111219;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      padding: 1rem;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
                   sans-serif;
      background: radial-gradient(circle at top, #15182a 0, #05060a 50%);
      color: var(--fg);
    }

    h1 {
      font-size: 1.4rem;
      margin: 0 0 0.25rem;
    }
    .subtitle {
      font-size: 0.8rem;
      color: var(--muted);
      margin-bottom: 0.75rem;
    }

    .frame {
      max-width: 960px;
      margin: 0 auto;
      background: rgba(5, 6, 10, 0.9);
      border-radius: 14px;
      border: 1px solid rgba(255, 255, 255, 0.03);
      box-shadow: 0 30px 80px rgba(0, 0, 0, 0.6);
      padding: 1rem 1.1rem 1.25rem;
    }

    .row {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 0.5rem;
      margin-bottom: 0.75rem;
      font-size: 0.85rem;
    }

    .timeframe-row button {
      border: 1px solid transparent;
      background: transparent;
      color: var(--fg);
      padding: 0.15rem 0.5rem;
      border-radius: 999px;
      cursor: pointer;
      font-size: 0.8rem;
      opacity: 0.8;
      white-space: nowrap;
    }

    .timeframe-row button.active {
      border-color: var(--accent);
      background: rgba(138, 206, 0, 0.15);
      opacity: 1;
    }

    .dimension-row {
      display: flex;
      flex-wrap: wrap;
      gap: 0.75rem;
      align-items: center;
      font-size: 0.85rem;
      margin-bottom: 0.8rem;
    }

    .dimension-row label {
      display: inline-flex;
      align-items: center;
      gap: 0.3rem;
      cursor: pointer;
    }

    #chart {
      width: 100%;
      height: 320px;
      border-radius: 12px;
      background: var(--card);
      border: 1px solid var(--border);
      margin-bottom: 0.75rem;
      overflow: hidden;
    }

    .account-list {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
      gap: 0.4rem;
      margin-bottom: 0.9rem;
      font-size: 0.8rem;
    }

    .account-chip {
      background: #111219;
      border-radius: 999px;
      border: 1px solid var(--border);
      padding: 0.25rem 0.5rem;
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      gap: 0.5rem;
    }

    .account-chip-name {
      font-weight: 500;
      font-size: 0.8rem;
    }

    .account-chip-value {
      font-family: "Menlo", "Roboto Mono", ui-monospace, SFMono-Regular, monospace;
      font-size: 0.8rem;
      opacity: 0.9;
    }

    .entry-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.8rem;
      margin-bottom: 0.75rem;
    }
    .entry-table th,
    .entry-table td {
      border-bottom: 1px solid rgba(255, 255, 255, 0.04);
      padding: 0.2rem 0.25rem;
    }
    .entry-table th {
      text-align: left;
      font-weight: 500;
      color: var(--muted);
    }
    .entry-table input[type="number"] {
      width: 100%;
      font-size: 0.8rem;
      padding: 0.2rem 0.3rem;
      border-radius: 6px;
      border: 1px solid rgba(255, 255, 255, 0.08);
      background: #05060a;
      color: var(--fg);
    }

    .actions-row {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      justify-content: flex-end;
      margin-bottom: 0.25rem;
    }

    button.primary {
      border-radius: 999px;
      border: 1px solid var(--accent);
      background: var(--accent);
      color: #000;
      font-size: 0.8rem;
      padding: 0.2rem 0.9rem;
      cursor: pointer;
      font-weight: 500;
    }

    button.secondary {
      border-radius: 999px;
      border: 1px solid var(--border);
      background: transparent;
      color: var(--fg);
      font-size: 0.8rem;
      padding: 0.2rem 0.8rem;
      cursor: pointer;
    }

    .type-filter-row {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 0.5rem;
      margin-top: 0.4rem;
      margin-bottom: 0.4rem;
      font-size: 0.8rem;
      opacity: 0.95;
    }
    .type-filter-row span:first-child {
      font-weight: 500;
      margin-right: 0.25rem;
    }
    .type-filter-row label.type-chip {
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
      padding: 0.1rem 0.4rem;
      border-radius: 999px;
      border: 1px solid rgba(255, 255, 255, 0.18);
      cursor: pointer;
      user-select: none;
    }

    .safety-note {
      font-size: 0.7rem;
      color: var(--muted);
      margin-top: 0.4rem;
      margin-bottom: 0;
    }

    .footer-version {
      font-size: 0.7rem;
      color: var(--muted);
      margin-top: 0.25rem;
    }

    .error-banner {
      display: none;
      margin-bottom: 0.5rem;
      padding: 0.4rem 0.6rem;
      border-radius: 6px;
      font-size: 0.75rem;
      background: #391b1b;
      color: #fddddb;
      border: 1px solid #5e3030;
    }
  </style>
</head>
<body>
  <div class="frame">
    <h1>Ledger — Accounts &amp; Chart</h1>
    <div class="subtitle">
      Timeframe controls, Totals / Type / Per-Account views, and per-account entries.
    </div>

    <div id="errorBanner" class="error-banner"></div>

    <div class="row timeframe-row" id="timeframeRow">
      <span style="font-weight:500;">Timeframe:</span>
      <button data-tf="ytd" class="active">This Calendar Year</button>
      <button data-tf="today">Today</button>
      <button data-tf="7d">Last 7 Days</button>
      <button data-tf="14d">Last 14 Days</button>
      <button data-tf="30d">Last 30 Days</button>
      <button data-tf="90d">Last 90 Days</button>
      <button data-tf="1y">Last Year (12mo)</button>
      <button data-tf="all">All Time</button>
    </div>

    <div class="dimension-row">
      <span>View:</span>
      <label>
        <input type="radio" name="dimension" value="totals" checked>
        Totals
      </label>
      <label>
        <input type="radio" name="dimension" value="types">
        Type
      </label>
      <label>
        <input type="radio" name="dimension" value="accounts">
        Per-Account
      </label>
    </div>

    <div id="chart"></div>

    <div class="account-list" id="accountList"></div>

    <table class="entry-table" id="entryTable">
      <thead>
        <tr>
          <th>Account</th>
          <th>New Value (optional)</th>
        </tr>
      </thead>
      <tbody id="entryTableBody"></tbody>
    </table>

    <div class="actions-row">
      <button class="secondary" id="refreshBtn">Refresh</button>
      <button class="primary" id="submitBtn">Submit All</button>
    </div>

    <div id="typeFilterRow" class="type-filter-row" hidden></div>

    <p class="safety-note">
      Privacy First: No login credentials or personally identifiable information is stored in this application.
      All data resides in your Google Sheet. Your financial footprint, your control.
    </p>
    <div class="footer-version">
      v3.0 — Type summaries • Totals / Type / Per-Account toggle
    </div>
  </div>

  <script>
    // === CONFIG ===
    // Replace with your deployed Apps Script Web App URL (ending in /exec)
    const API_BASE = 'https://script.google.com/macros/s/AKfycbyjfgyOa7UZgdZ7IVQAXzJqZOVl2duSznDhv6ZwWiowMsvF-mrPx-ZOyZDnZdA7EoQPdQ/exec';

    // === State ===
    let currentTimeframe = 'ytd';
    let currentDimension = 'totals'; // totals | types | accounts

    let snapshotData = null;
    let accounts = [];
    let seriesByAccount = {};
    let totals = { assets: [], debts: [] };

    let typeMeta = {};
    let typeSeries = {};
    let activeTypeCodes = new Set();

    // === DOM references ===
    const chartEl = document.getElementById('chart');
    const tfRow = document.getElementById('timeframeRow');
    const accountListEl = document.getElementById('accountList');
    const entryBodyEl = document.getElementById('entryTableBody');
    const typeFilterRowEl = document.getElementById('typeFilterRow');
    const errorBanner = document.getElementById('errorBanner');

    const refreshBtn = document.getElementById('refreshBtn');
    const submitBtn = document.getElementById('submitBtn');

    // === Init Google Charts ===
    google.charts.load('current', { packages: ['corechart'] });
    google.charts.setOnLoadCallback(init);

    function init() {
      wireUI();
      loadSnapshot(currentTimeframe);
    }

    function wireUI() {
      // Timeframe buttons
      tfRow.querySelectorAll('button[data-tf]').forEach(btn => {
        btn.addEventListener('click', () => {
          const tf = btn.getAttribute('data-tf');
          currentTimeframe = tf;
          tfRow.querySelectorAll('button[data-tf]').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          loadSnapshot(tf);
        });
      });

      // Dimension radios
      document.querySelectorAll('input[name="dimension"]').forEach(radio => {
        radio.addEventListener('change', (e) => {
          currentDimension = e.target.value;
          updateDimensionVisibility();
          drawCurrentDimensionChart();
        });
      });

      refreshBtn.addEventListener('click', () => {
        loadSnapshot(currentTimeframe);
      });

      submitBtn.addEventListener('click', () => {
        submitEntries();
      });
    }

    // === API Helpers ===
    async function loadSnapshot(tf) {
      showError(null);
      try {
        const url = API_BASE + '?route=snapshot&timeframe=' + encodeURIComponent(tf);
        const res = await fetch(url);
        if (!res.ok) throw new Error('HTTP ' + res.status);
        const data = await res.json();
        if (!data.ok) throw new Error(data.error || 'Snapshot error');
        applySnapshot(data);
      } catch (err) {
        console.error('loadSnapshot error', err);
        showError('Error loading snapshot: ' + err.message);
      }
    }

    async function submitEntries() {
      if (!accounts.length) {
        showError('No accounts loaded yet.');
        return;
      }
      const entries = [];
      entryBodyEl.querySelectorAll('tr').forEach(row => {
        const acct = row.getAttribute('data-account');
        const input = row.querySelector('input');
        const valStr = input.value.trim();
        if (!valStr) return; // no entry for this account
        const v = Number(valStr);
        if (!isFinite(v)) return;
        entries.push({ account: acct, value: v });
      });

      if (!entries.length) {
        showError('No values entered to submit.');
        return;
      }

      showError(null);

      try {
        const payload = {
          route: 'submit',
          entries: entries
        };
        const res = await fetch(API_BASE, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        if (!res.ok) throw new Error('HTTP ' + res.status);
        const data = await res.json();
        if (!data.ok) throw new Error(data.error || 'Submit failed');

        // Clear inputs + reload snapshot
        entryBodyEl.querySelectorAll('input').forEach(i => i.value = '');
        loadSnapshot(currentTimeframe);
      } catch (err) {
        console.error('submitEntries error', err);
        showError('Error submitting values: ' + err.message);
      }
    }

    // === Snapshot handling ===
    function applySnapshot(data) {
      snapshotData = data;
      accounts = data.accounts || [];
      seriesByAccount = data.series || {};
      totals = data.totals || { assets: [], debts: [] };

      typeMeta = data.typeMeta || {};
      typeSeries = data.typeSeries || {};
      const typeCodes = Object.keys(typeMeta);
      activeTypeCodes = new Set(typeCodes);

      renderAccountsList();
      renderEntryTable();
      buildTypeCheckboxRow();
      updateDimensionVisibility();
      drawCurrentDimensionChart();
    }

    function renderAccountsList() {
      accountListEl.innerHTML = '';
      if (!accounts.length) return;

      accounts.forEach(acct => {
        const chip = document.createElement('div');
        chip.className = 'account-chip';

        const nameEl = document.createElement('div');
        nameEl.className = 'account-chip-name';
        nameEl.textContent = acct.name;

        const valEl = document.createElement('div');
        valEl.className = 'account-chip-value';
        const s = seriesByAccount[acct.name];
        const last = s ? s.last : 0;
        valEl.textContent = formatNumber(last);

        chip.appendChild(nameEl);
        chip.appendChild(valEl);

        accountListEl.appendChild(chip);
      });
    }

    function renderEntryTable() {
      entryBodyEl.innerHTML = '';
      if (!accounts.length) return;

      accounts.forEach(acct => {
        const tr = document.createElement('tr');
        tr.setAttribute('data-account', acct.name);

        const tdName = document.createElement('td');
        tdName.textContent = acct.name;

        const tdInput = document.createElement('td');
        const input = document.createElement('input');
        input.type = 'number';
        input.step = '0.01';
        input.placeholder = 'Leave blank to skip';
        tdInput.appendChild(input);

        tr.appendChild(tdName);
        tr.appendChild(tdInput);
        entryBodyEl.appendChild(tr);
      });
    }

    function buildTypeCheckboxRow() {
      typeFilterRowEl.innerHTML = '';

      const codes = Object.keys(typeMeta);
      if (!codes.length) {
        typeFilterRowEl.hidden = true;
        return;
      }

      const label = document.createElement('span');
      label.textContent = 'Show types:';
      typeFilterRowEl.appendChild(label);

      codes.sort().forEach(code => {
        const meta = typeMeta[code] || {};
        const uiLabel = (meta.label || code).toUpperCase();

        const wrapper = document.createElement('label');
        wrapper.className = 'type-chip';

        const cb = document.createElement('input');
        cb.type = 'checkbox';
        cb.value = code;
        cb.checked = true;
        cb.addEventListener('change', (e) => {
          if (e.target.checked) {
            activeTypeCodes.add(code);
          } else {
            activeTypeCodes.delete(code);
          }
          if (currentDimension === 'types') {
            drawCurrentDimensionChart();
          }
        });

        const text = document.createElement('span');
        text.textContent = uiLabel;

        wrapper.appendChild(cb);
        wrapper.appendChild(text);
        typeFilterRowEl.appendChild(wrapper);
      });
    }

    function updateDimensionVisibility() {
      // Only show typeFilterRow in Type mode
      if (!typeFilterRowEl) return;
      typeFilterRowEl.hidden = (currentDimension !== 'types');
    }

    // === Chart drawing ===
    function drawCurrentDimensionChart() {
      if (!snapshotData) return;
      if (currentDimension === 'types') {
        drawTypeChart(snapshotData);
      } else if (currentDimension === 'accounts') {
        drawPerAccountChart(snapshotData);
      } else {
        drawTotalsChart(snapshotData);
      }
    }

    function drawTotalsChart(data) {
      const axis = data.dateAxis || [];
      const totals = data.totals || { assets: [], debts: [] };

      const dt = new google.visualization.DataTable();
      dt.addColumn('string', 'Date');
      dt.addColumn('number', 'Assets');
      dt.addColumn('number', 'Debts');

      for (let i = 0; i < axis.length; i++) {
        dt.addRow([
          axis[i],
          Number(totals.assets[i] || 0),
          Number(totals.debts[i] || 0)
        ]);
      }

      const options = {
        title: 'Totals: Assets vs Debts',
        legend: { position: 'bottom' },
        isStacked: false,
        areaOpacity: 0.6,
        backgroundColor: '#111219',
        chartArea: { left: 40, top: 30, right: 20, bottom: 40 },
        hAxis: { textStyle: { color: '#ccc' } },
        vAxis: { textStyle: { color: '#ccc' }, minValue: 0 }
      };

      const chart = new google.visualization.AreaChart(chartEl);
      chart.draw(dt, options);
    }

    function drawTypeChart(data) {
      const axis = data.dateAxis || [];
      const dt = new google.visualization.DataTable();
      dt.addColumn('string', 'Date');

      const codes = Object.keys(typeMeta);
      const active = (activeTypeCodes.size ? Array.from(activeTypeCodes) : codes);

      active.forEach(code => {
        const meta = typeMeta[code] || {};
        dt.addColumn('number', meta.label || code);
      });

      axis.forEach((label, idx) => {
        const row = [label];
        active.forEach(code => {
          const arr = (typeSeries[code] || []);
          row.push(Number(arr[idx] || 0));
        });
        dt.addRow(row);
      });

      const options = {
        title: 'By Type',
        legend: { position: 'bottom' },
        isStacked: true,
        areaOpacity: 0.75,
        backgroundColor: '#111219',
        chartArea: { left: 40, top: 30, right: 20, bottom: 40 },
        hAxis: { textStyle: { color: '#ccc' } },
        vAxis: { textStyle: { color: '#ccc' } }
      };

      const chart = new google.visualization.AreaChart(chartEl);
      chart.draw(dt, options);
    }

    function drawPerAccountChart(data) {
      const axis = data.dateAxis || [];
      const dt = new google.visualization.DataTable();
      dt.addColumn('string', 'Date');

      const acctNames = accounts.map(a => a.name);
      acctNames.forEach(name => {
        dt.addColumn('number', name);
      });

      axis.forEach((label, idx) => {
        const row = [label];
        acctNames.forEach(name => {
          const s = seriesByAccount[name];
          const arr = s ? (s.monthly || []) : [];
          row.push(Number(arr[idx] || 0));
        });
        dt.addRow(row);
      });

      const options = {
        title: 'Per-Account',
        legend: { position: 'bottom', maxLines: 3 },
        isStacked: false,
        areaOpacity: 0.6,
        backgroundColor: '#111219',
        chartArea: { left: 40, top: 30, right: 20, bottom: 60 },
        hAxis: { textStyle: { color: '#ccc' } },
        vAxis: { textStyle: { color: '#ccc' } }
      };

      const chart = new google.visualization.AreaChart(chartEl);
      chart.draw(dt, options);
    }

    // === Utilities ===
    function formatNumber(n) {
      if (!isFinite(n)) return '';
      const sign = n < 0 ? '-' : '';
      const abs = Math.abs(n);
      return sign + abs.toLocaleString(undefined, {
        maximumFractionDigits: 2
      });
    }

    function showError(msg) {
      if (!errorBanner) return;
      if (!msg) {
        errorBanner.style.display = 'none';
        errorBanner.textContent = '';
      } else {
        errorBanner.style.display = 'block';
        errorBanner.textContent = msg;
      }
    }
  </script>
</body>
</html>
